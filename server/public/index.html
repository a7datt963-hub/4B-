<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>موقع شحن الألعاب — نسخة متكاملة</title>
  <style>
  /* (CSS مدمج من الملف الأساسي — لم ألمس الستايل لتفادي كسر التصميم) */
  * { margin:0; padding:0; box-sizing:border-box }
  html,body { height:100% }
  body { font-family:Arial,Helvetica,sans-serif; background:#000; color:#fff; overflow-x:hidden }

  header { background:#111; padding:10px 20px; position:relative; text-align:center }
  header img { height:90px; width:auto; display:block; margin:0 auto }
  #ordersStatusBar { margin:8px auto 0; max-width:720px; padding:4px 8px; border-radius:6px; text-align:center; min-height:22px; display:none; overflow:hidden; white-space:normal; pointer-events:none }
  .status-line { color:#FFCB01; padding:2px 4px; margin:2px 0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; font-weight:700; border-bottom:1px solid rgba(255,203,1,0.06); line-height:1.1 }
  .menu { position:absolute; right:20px; font-size:28px; cursor:pointer; color:#FFCB01; top:50%; transform:translateY(-50%) }
  #personalNumberDisplay { position:absolute; left:20px; top:30%; transform:translateY(-50%); color:#FFCB01; font-weight:bold; font-size:13px }
  #notifBell { position:absolute; right:68px; top:50%; transform:translateY(-50%); font-size:22px; cursor:pointer; color:#FFCB01 }
  #notifBell .badge { background:#ff3b30; color:#fff; border-radius:999px; padding:2px 6px; font-size:12px; margin-left:6px; vertical-align:middle }

  #balanceBox {
    position:absolute;
    left:20px;
    top:58%;
    transform:translateY(0);
    background: #FFCB01;
    color: #000;
    padding:6px 10px;
    border-radius:8px;
    font-weight:700;
    font-size:13px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    white-space:nowrap;
  }
  #balanceBox.hidden { display:none; }

  .notif-panel { position:fixed; top:70px; right:20px; width:360px; max-width:92%; background:#111; border:2px solid #FFCB01; border-radius:10px; padding:10px; z-index:1500; box-shadow:0 6px 30px rgba(0,0,0,0.6) }
  .notif-panel.hidden { display:none }
  .notif-empty { color:#aaa; padding:8px; text-align:center }

  .sidebar {
    position:fixed;
    top:0;
    right:-100%;
    width:80%;
    max-width:300px;
    height:100%;
    background:transparent;
    padding:20px;
    transition:0.28s;
    z-index:1000;
    overflow-y:auto;
    border-left:2px solid rgba(255,255,255,0.03);
  }
  .sidebar.active { right:0; background:rgba(17,17,17,0.98); }

  .sidebar .avatar { width:48px; height:48px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:20px; color:#FFCB01; border:2px solid #FFCB01; }

  .sidebar a {
    display:block;
    color:#fff !important;
    text-decoration:none;
    padding:10px 12px;
    margin:6px 0;
    font-size:16px;
    font-weight:700;
    text-align:right;
    border-radius:6px;
    transition: color 0.15s, background 0.15s;
    background: transparent;
  }
  .sidebar a:hover { color:#FFCB01; background:rgba(255,203,1,0.04); }

  .sidebar .small-btn {
    display:block;
    width:100%;
    text-align:center;
    background:transparent;
    color:#fff;
    border:2px solid rgba(255,255,255,0.05);
    padding:10px;
    border-radius:8px;
    margin-top:12px;
    cursor:pointer;
  }
  .sidebar .small-btn:hover { border-color:rgba(255,203,1,0.35); color:#FFCB01; }

  .container { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; padding:20px }
  .card { background:#111; border:2px solid #FFCB01; border-radius:12px; padding:20px; text-align:center; cursor:pointer; transition:.25s; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center }
  .card:hover { background:#FFCB01; color:#000 }
  .hidden { display:none }
  .form-box { background:#111; border:2px solid #FFCB01; border-radius:12px; padding:20px; margin:20px }
  select,input,button,textarea { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:none; font-size:16px; background:#222; color:#fff }
  .button-option { background:#222; color:#FFCB01; border:2px solid #FFCB01; margin:5px 0; padding:10px; border-radius:8px; cursor:pointer; width:100%; text-align:center; font-weight:bold }
  .button-option.selected { background:#FFCB01; color:#000 }
  button { background:#FFCB01; color:#000; font-weight:bold; cursor:pointer; border-radius:8px; padding:10px }
  .small-btn { display:inline-block; padding:8px 12px; border-radius:8px; background:#FFCB01; color:#000; cursor:pointer; margin-top:8px; text-align:center }
  .back-btn { display:block; margin:20px auto; background:#FFCB01; color:#000; padding:10px; border-radius:8px; text-align:center; font-weight:bold; cursor:pointer }
  .price-note { color:#FFCB01; font-weight:bold; margin:10px 0; font-size:14px; white-space:pre-line }
  .orders-list { padding:10px; margin:10px; background:#111; border-radius:10px; border:1px solid #333 }
  .order-item { padding:12px; border:2px solid #FFCB01; border-radius:8px; margin-bottom:10px; background:#111 }
  .login-page { max-width:600px; margin:18px auto; padding:16px }
  .muted-small { font-size:13px; color:#aaa; margin-top:6px }
  .upload-status { font-size:13px; color:#aaa; margin-top:6px }

  @media (min-width: 900px) {
    .sidebar { right:0; position:static; width:260px; max-width:none; background:transparent; border-left:none; padding:20px 10px 20px 20px; }
    .sidebar.active { right:0; background:transparent; }
    main { margin-right:260px; }
  }

  @media (max-width: 899px) {
    .menu { display:block }
    header img { height:72px }
    #personalNumberDisplay { top:30%; left:10px; }
    #balanceBox { top:66%; left:10px; }
  }

  /* زر شحن مميز */
  #btnCharge {
    background: linear-gradient(270deg, #FFCB01, #FF9F00, #FFCB01) !important;
    background-size: 600% 600%;
    animation: moveGradient 6s ease infinite;
    color: #000 !important;
    border: none !important;
    padding: 12px !important;
    width: 100% !important;
    font-weight: 800 !important;
    border-radius: 10px !important;
    cursor: pointer;
  }
  @keyframes moveGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  </style>
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/W1Ysr3QG/image.png" alt="Logo">
    <div id="personalNumberDisplay">رقمك الشخصي: <span id="personalNum">0000000</span></div>
    <div id="balanceBox" class="hidden">رصيدك: 0 ل.س</div>
    <div id="notifBell" title="الإشعارات">🔔<span id="notifBadge" class="badge hidden">0</span></div>
    <div class="menu" id="menuBtn">☰</div>
    <div id="ordersStatusBar" aria-live="polite" role="status" style="display:none"></div>
  </header>

  <!-- notif panel -->
  <div id="notifPanel" class="notif-panel hidden" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h4 style="color:#FFCB01;margin:0">الإشعارات</h4>
      <div style="cursor:pointer;color:#FFCB01" id="notifCloseBtn">×</div>
    </div>
    <div id="notifList"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <div class="small-btn" id="notifClearBtn">مسح الكل</div>
      <div class="small-btn" id="notifGoOffersBtn">اذهب للعروض</div>
    </div>
  </div>

  <!-- sidebar -->
  <div id="sidebar" class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="display:flex;gap:10px;align-items:center;cursor:pointer" id="sidebarProfileArea">
        <div class="avatar" id="sidebarAvatar">أ</div>
        <div>
          <div id="sidebarName" style="color:#FFCB01;font-weight:700">ضيف</div>
          <div id="sidebarPersonal" style="color:#ccc;font-size:13px">--</div>
        </div>
      </div>
      <div style="cursor:pointer;color:#FFCB01" id="sidebarCloseBtn">×</div>
    </div>

    <a href="#" id="linkHome">الرئيسية</a>
    <a href="#" id="linkOrders">الطلبات</a>
    <a href="#" id="linkHelp">المساعدة في حل مشكلة</a>
    <a href="#" id="linkOffers">العروض والهدايا</a>
    <a href="#" id="linkJoinWhats">الانضمام لمجتمع واتساب</a>
    <div style="margin-top:16px;">
      <div class="small-btn" id="btnCharge">شحن الرصيد</div>
    </div>
  </div>

  <!-- pages -->
  <main id="mainContent">
    <!-- login page (معدل: اضفت أزرار البحث و إنشاء الحساب) -->
    <div id="loginPage" class="form-box login-page hidden">
      <h3 style="text-align:center;color:#FFCB01;">تسجيل الدخول / التسجيل</h3>
      <label>ضع الأسم</label>
      <input type="text" id="loginName" placeholder="أدخل اسمك">
      <label>البريد الإلكتروني</label>
      <input type="email" id="loginEmail" placeholder="example@domain.com">
      <label>كلمة السر</label>
      <div style="position:relative;">
        <input type="password" id="loginPassword" placeholder="كلمة السر">
        <button id="loginTogglePwd" style="position:absolute;left:6px;top:10px;height:36px;width:80px;cursor:pointer;">اظهار</button>
      </div>
      <label>رقم هاتف</label>
      <input type="text" id="loginPhone" placeholder="مثال: 0999xxxxxx">
      <label>ضع الرقم الشخصي (غير قابل للتعديل)</label>
      <input type="text" id="loginPersonalNumber" readonly>
      <div class="small-muted" style="margin-top:6px;">
        ملاحظة: لن يتم ارسال اي كود على البريد الإلكتروني او رقم الهاتف.
        فقط قم بتعبئة بياناتك الاصلية ففي حال حدوث مشكلة نستطيع التواصل معك.
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <!-- زر تسجيل الدخول القديم (يعمل كـ register legacy) -->
        <button id="doLoginBtn">تسجيل الدخول</button>
        <!-- أزرار البحث / إنشاء الحساب الجديدة المضافة -->
        <button id="btnSearch" style="background:#2563eb;color:#fff">بحث عن الحساب</button>
        <button id="btnCreate" style="background:#10b981;color:#fff">إنشاء حساب جديد</button>
      </div>
      <div id="loginError" class="error" style="display:none;color:#ff8080;margin-top:8px;"></div>
    </div>

    <!-- profile page -->
    <div id="profilePage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">الملف الشخصي</h3>
        <label>الاسم</label>
        <input type="text" id="profileName" readonly>
        <label>البريد الإلكتروني</label>
        <input type="email" id="profileEmail" readonly>
        <label>كلمة السر</label>
        <input type="password" id="profilePassword" readonly>
        <label>رقم الهاتف</label>
        <input type="text" id="profilePhone" readonly>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button id="requestEditBtn">طلب تعديل معلوماتك</button>
          <button id="confirmSaveBtn" class="hidden">حفظ التعديلات</button>
        </div>
        <div class="back-btn" id="profileBackBtn">⬅ رجوع</div>
        <div id="profileMsg" class="muted-small"></div>
      </div>
    </div>

    <!-- home page -->
    <div id="homePage" class="hidden">
      <div class="container">
        <div class="card" id="cardGames">قسم الألعاب</div>
        <div class="card" id="cardApps">قسم التطبيقات</div>
      </div>
    </div>

    <!-- help page -->
    <div id="helpPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;">المساعدة في حل مشكلة</h3>
        <label>الرقم الشخصي (غير قابل للتعديل)</label>
        <input type="text" id="helpPersonalField" readonly>
        <label>-اختر مشكلتك-</label>
        <select id="helpIssueSelect">
          <option value="" disabled selected>-- اختر مشكلتلك --</option>
          <option value="لا استطيع تعبئة البيانات">لا استطع تعبئة البيانات</option>
          <option value="قمت بتحويل الرصيد ولم يُراجع طلبي">قمت بتحويل الرصيد ولم يُراجع طلبي</option>
          <option value="تم قبول طلبي لكن لم يصلني شيء">تم قبول طلبي لكن لم يصلني شيء</option>
          <option value="لا استطيع ارسال لقطة شاشة">لا استطيع ارسال لقطة شاشة</option>
        </select>
        <label>ارفاق ملف (اختياري)</label>
        <input type="file" id="helpFileUpload" accept="image/*">
        <div class="upload-status" id="helpUploadStatus"></div>
        <input type="text" id="helpFileLink" placeholder="رابط الملف سيظهر هنا (اختياري)" readonly>
        <label>وصف المشكلة</label>
        <textarea id="helpDesc" rows="5" maxlength="100" placeholder="اكتب مشكلتك وضع رقم عملية الطلب #***********"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="helpSubmitBtn">إرسال</button>
          <div class="back-btn" id="helpBackBtn">⬅ رجوع</div>
        </div>
      </div>
    </div>

    <!-- games page -->
    <div id="gamesPage" class="hidden">
      <div class="form-box">
        <h3>اختر لعبتك</h3>
        <select id="gameSelect">
          <option value="">-- اختر لعبة --</option>
          <option value="أكواد فري فاير">أكواد فري فاير</option>
          <option value="فري فاير ايدي">فري فاير ايدي</option>
          <option value="ببجي ايدي">ببجي ايدي</option>
          <option value="أكواد ببجي">أكواد ببجي</option>
          <option value="جواكر">جواكر</option>
        </select>
        <input type="text" id="personalField" readonly>
        <input type="text" id="idField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainer"></div>
        <div id="priceDisplay"></div>
        <button id="submitForm" disabled>إرسال</button>
        <div class="price-note" id="paymentNote">اختر الحزمة ثم اضغط إرسال لإرسال الطلب مباشرة (يُخصم من رصيدك إن كافى).</div>
        <div id="orderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtn" class="small-btn hidden">عرض الطلبات</button>
        </div>
        <div class="back-btn" id="gamesBackBtn">⬅ رجوع للصفحة الرئيسية</div>
      </div>
    </div>

    <!-- apps page -->
    <div id="appsPage" class="hidden">
      <div class="form-box">
        <h3>اختر التطبيق</h3>
        <select id="appSelect">
          <option value="">-- اختر تطبيق --</option>
          <option value="تطبيق 1">تطبيق 1</option>
          <option value="تطبيق 2">تطبيق 2</option>
          <option value="تطبيق 3">تطبيق 3</option>
        </select>
        <input type="text" id="appPersonalField" readonly>
        <input type="text" id="appIdField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainerApps"></div>
        <div id="priceDisplayApps"></div>
        <button id="appSubmitForm" disabled>إرسال</button>
        <div class="price-note" id="appPaymentNote">اختر الباقة/التطبيق ثم اضغط إرسال لإرسال الطلب مباشرة (يُخصم من رصيدك إن كافى).</div>
        <div id="appOrderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtnApp" class="small-btn hidden">عرض الطلبات</button>
        </div>
        <div class="back-btn" id="appsBackBtn">⬅ رجوع للصفحة الرئيسية</div>
      </div>
    </div>

    <!-- offers page -->
    <div id="offersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">العروض والهدايا</h3>
        <div id="offersList"></div>
        <div class="back-btn" id="offersBackBtn">⬅ رجوع للصفحة الرئيسية</div>
      </div>
    </div>

    <!-- payment details page -->
    <div id="paymentDetailsPage" class="hidden">
      <div class="form-box">
        <div class="back-btn" id="pdBackBtn">⬅ رجوع</div>
        <h3 id="pdTitle" style="text-align:center;">تفاصيل الدفع</h3>
        <div id="pdContent">
          <div id="pdTopInfo" style="text-align:center;margin-bottom:10px;color:#FFCB01;font-weight:bold;"></div>
          <select id="pdCashSelect">
            <option value="">-- اختر طريقة الدفع --</option>
            <option value="sham">شام كاش</option>
            <option value="syrtel">سيرتيل كاش</option>
            <option value="mtn">MTN كاش</option>
            <option value="hawala">حوالة مالية</option>
          </select>
          <div style="position:relative; margin-bottom:10px;">
            <input type="text" id="pdCopyField" readonly style="width:100%;padding-right:80px;">
            <button type="button" id="pdCopyBtn" style="position:absolute;left:0;top:0;height:100%;width:70px;cursor:pointer;">نسخ</button>
          </div>
          <div style="text-align:center;margin-bottom:10px;">
            <button type="button" id="pdToggleQrBtn">اظهر/اخفِ QR</button>
          </div>
          <div id="qrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="qrImg" src="https://i.postimg.cc/vHYg2nK5/IMG.jpg" alt="QR شام" style="width:300px;height:auto;">
          </div>
          <div id="syrtelQrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="syrtelQrImg" src="https://i.postimg.cc/tT6ScwYv/IMG.jpg" alt="QR سيرتيل" style="width:300px;height:auto;">
          </div>

          <div id="shamFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>تحويل شام كاش إلى:</strong>
              <div style="margin-top:6px;">العنوان/المحفظة: <span id="shamAddressDisplay">e5eca798a4add8f1b86d389330131c82</span></div>
            </div>
          </div>

          <div id="syrtelFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>تحويل سيرتيل كاش إلى:</strong>
              <div style="margin-top:6px;">الرقم: <span id="syrtelAddressDisplay">72289118</span></div>
            </div>
          </div>

          <div id="hawalaFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>قم بتحويل الرصيد المطلوب إلى الاسم التالي:</strong>
              <div style="margin-top:8px;">عبد الرحمن احمد عتون</div>
              <div class="muted-small" style="margin-top:8px;color:#ccc;">
                التحويل يتم عبر مكاتب الصرافة الموجودة في سوريا مثل: الهرم، الفؤاد، دوفيز، الخ...
              </div>
            </div>
          </div>

          <input type="file" id="paymentFileUpload" accept="image/*">
          <div class="upload-status" id="paymentUploadStatus"></div>
          <input type="text" id="paymentFileLink" placeholder="رابط الملف سيظهر هنا" readonly>
          <div id="pdPriceInfo" style="color:#0f0;font-weight:bold;margin-top:10px;text-align:center"></div>
          <div class="price-note" id="pdNote" style="white-space:pre-line">اختر طريقة الدفع لمتابعة التعليمات</div>
          <button id="pdSubmitForm">إرسال الطلب</button>
        </div>
      </div>
    </div>

    <!-- orders page -->
    <div id="ordersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center">الطلبات</h3>
        <div id="ordersList" class="orders-list"></div>
        <div class="back-btn" id="ordersBackBtn">⬅ رجوع للصفحة الرئيسية</div>
      </div>
    </div>

    <!-- review page -->
    <div id="reviewPage" class="hidden">
      <div class="form-box" style="text-align:center;">
        <h3>تم ارسال طلبك</h3>
        <p id="reviewMsg">تم استلام طلبك وسيتم مراجعته</p>
        <div class="back-btn" id="reviewBackBtn">⬅ رجوع للصفحة الرئيسية</div>
      </div>
    </div>

  </main>

<script>
/* ---------- Frontend logic ---------- */

/* API root dynamic — يبقى كما في ملفاتك الأصلية */
const API_ROOT = (window.API_ROOT && window.API_ROOT.length>0) ? window.API_ROOT : (location.origin + '/');

/* helpers */
function $(id){ return document.getElementById(id); }
function show(id){ const el=$(id); if(el) el.classList.remove('hidden'); }
function hide(id){ const el=$(id); if(el) el.classList.add('hidden'); }
function hideAllPages(){
  ['homePage','gamesPage','appsPage','ordersPage','paymentDetailsPage','reviewPage','helpPage','profilePage','loginPage','offersPage'].forEach(id => { const e=$(id); if(e) e.classList.add('hidden'); });
}

/* state */
let currentProfile = null;
let selectedGameOption = '';
let selectedAppOption = '';
let currentMap = null;
let currentMap_num = {};

/* price maps (محتوى كما كان لديك) */
const priceMapFF={"100 جواهر":"12500 ل.س","200 جواهر":"25000 ل.س","300 جواهر":"60000 ل.س","530 جواهر":"60000 ل.س","1080 جواهر":"120000 ل.س","2200 جواهر":"240000 ل.س","عضوية أسبوعية":"30000 ل.س","عضوية شهرية":"140000 ل.س"};
const priceMapPUBG={"60 شدة":"6000 ل.س","325 شدة":"25000 ل.س","660 شدة":"48000 ل.س","1800 شدة":"120000 ل.س","3850 شدة":"240000 ل.س","8100 شدة":"480000 ل.س"};
const priceMappubg1={"كود 60 شده":"12500 ل.س"};
const priceMapApps = {"تطبيق 1":"5000 ل.س","تطبيق 2":"10000 ل.س","تطبيق 3":"15000 ل.س"};
const priceMapFF_num = Object.fromEntries(Object.entries(priceMapFF).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMapPUBG_num = Object.fromEntries(Object.entries(priceMapPUBG).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMappubg1_num = Object.fromEntries(Object.entries(priceMappubg1).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMapApps_num = Object.fromEntries(Object.entries(priceMapApps).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));

/* ---------- Notifications & offers ---------- */
async function loadNotifications(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;
    const list = $('notifList');
    if(!list) return;
    list.innerHTML = '';
    const notifications = data.notifications || [];
    if(notifications.length === 0){
      list.innerHTML = '<div class="notif-empty">لا توجد إشعارات حالياً</div>';
    } else {
      notifications.forEach(n=>{
        const el = document.createElement('div');
        el.style.padding='8px';
        el.style.border='1px solid rgba(255,203,1,0.06)';
        el.style.marginBottom='8px';
        el.innerHTML = `<div style="font-weight:700;">${n.text}</div><div style="font-size:12px;color:#aaa;margin-top:6px;">${new Date(n.createdAt||Date.now()).toLocaleString()}</div>`;
        list.appendChild(el);
      });
    }
  }catch(e){
    console.warn('loadNotifications error', e);
  }
}

async function fetchOffers(){
  if(!currentProfile || !currentProfile.personalNumber) return;
  try{
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      const offers = data.offers || [];
      const container = $('offersList');
      if(container){
        container.innerHTML = '';
        if(offers.length === 0) {
          container.innerHTML = '<p style="color:#aaa">لا توجد عروض حالياً.</p>';
        } else {
          offers.forEach(of=>{
            const el = document.createElement('div');
            el.style.border='1px solid rgba(255,203,1,0.06)';
            el.style.padding='8px';
            el.style.marginBottom='8px';
            el.innerHTML = `<div>${of.text}</div><div style="margin-top:8px;"><button class="small-btn" onclick="ackOffer('${of.id}')">تحقق</button></div>`;
            container.appendChild(el);
          });
        }
      }
    }
  }catch(e){
    console.error('fetchOffers error', e);
  }
}

async function refreshNotificationsCount(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;

    const serverCanEdit = !!(data.canEdit || (data.profile && data.profile.canEdit));
    if(serverCanEdit !== !!currentProfile.canEdit){
      currentProfile.canEdit = serverCanEdit;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      applyProfileEditState();
    }

    if(data.profile && typeof data.profile.balance !== 'undefined'){
      const serverBal = Number(data.profile.balance || 0);
      if(serverBal !== Number(currentProfile.balance || 0)){
        currentProfile.balance = serverBal;
        localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
        refreshUIFromProfile();
      }
    }

    const offers = data.offers || [];
    const orders = data.orders || [];
    const charges = data.charges || [];
    const notifications = data.notifications || [];
    const unreadCount = (orders.filter(o=>o.replied).length) + (charges.filter(c=>c.replied).length) + (offers.length>0 ? 1 : 0) + (notifications.filter(n=>!n.read).length);
    if(unreadCount>0){ $('notifBadge').classList.remove('hidden'); $('notifBadge').textContent = String(unreadCount); } else { $('notifBadge').classList.add('hidden'); }
  }catch(err){
    console.warn('refreshNotificationsCount error', err);
  }
}

async function markNotificationsReadForCurrentUser(){
  if(!currentProfile || !currentProfile.personalNumber) return;
  try{
    const resp = await fetch(API_ROOT + 'api/notifications/mark-read', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      $('notifBadge').classList.add('hidden');
      return true;
    }
  }catch(e){ /* ignore */ }
  try{
    const r2 = await fetch(API_ROOT + 'api/notifications/mark-read/' + currentProfile.personalNumber, { method:'POST' });
    const d2 = await r2.json().catch(()=>null);
    if(d2 && d2.ok){
      $('notifBadge').classList.add('hidden');
      return true;
    }
  }catch(e){ /* ignore */ }
  return false;
}

/* ---------- DOM bindings ---------- */
document.addEventListener('DOMContentLoaded', ()=> {
  // menu
  if($('menuBtn')) $('menuBtn').addEventListener('click', ()=> { $('sidebar').classList.toggle('active'); });
  if($('sidebarCloseBtn')) $('sidebarCloseBtn').addEventListener('click', ()=> { $('sidebar').classList.remove('active'); });
  if($('sidebarProfileArea')) $('sidebarProfileArea').addEventListener('click', ()=> { openProfile(); $('sidebar').classList.remove('active'); });

  // sidebar links
  if($('linkHome')) $('linkHome').addEventListener('click', e=>{ e.preventDefault(); showHome(); $('sidebar').classList.remove('active'); });
  if($('linkOrders')) $('linkOrders').addEventListener('click', e=>{ e.preventDefault(); showOrders(); $('sidebar').classList.remove('active'); });
  if($('linkHelp')) $('linkHelp').addEventListener('click', e=>{ e.preventDefault(); showHelp(); $('sidebar').classList.remove('active'); });
  if($('linkOffers')) $('linkOffers').addEventListener('click', e=>{ e.preventDefault(); showOffers(); $('sidebar').classList.remove('active'); });
  if($('linkJoinWhats')) $('linkJoinWhats').addEventListener('click', e=>{ e.preventDefault(); window.open('https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J?mode=ems_copy_t','_blank'); });

  if($('btnCharge')) $('btnCharge').addEventListener('click', ()=>{ $('sidebar').classList.remove('active'); openChargePage(); });

  // notifications
  if($('notifBell')) $('notifBell').addEventListener('click', async ()=> {
    const hidden = $('notifPanel').classList.toggle('hidden');
    await loadNotifications();
    if(!hidden){
      await markNotificationsReadForCurrentUser();
      refreshNotificationsCount();
    }
  });
  if($('notifCloseBtn')) $('notifCloseBtn').addEventListener('click', ()=> $('notifPanel').classList.add('hidden'));
  if($('notifClearBtn')) $('notifClearBtn').addEventListener('click', async () => {
    try {
      const resp = await fetch(API_ROOT + 'api/notifications/clear', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ personal: currentProfile.personalNumber })
      });
      const data = await resp.json().catch(()=>null);
      if(data && data.ok){
        $('notifList').innerHTML='';
        $('notifBadge').classList.add('hidden');
      } else alert('فشل مسح الإشعارات');
    } catch(e){ console.error(e); alert('خطأ في الاتصال'); }
  });

  // login controls: DO NOT duplicate listeners if already set
  if($('doLoginBtn')) $('doLoginBtn').addEventListener('click', doLogin);
  if($('btnSearch')) $('btnSearch').addEventListener('click', searchProfileFromUI);
  if($('btnCreate')) $('btnCreate').addEventListener('click', createAccountFromUI);

  if($('loginTogglePwd')){
    $('loginTogglePwd').addEventListener('click', ()=>{
      const pwd = $('loginPassword');
      if(!pwd) return;
      if(pwd.type === 'password'){ pwd.type='text'; $('loginTogglePwd').textContent='إخفاء'; }
      else { pwd.type='password'; $('loginTogglePwd').textContent='اظهار'; }
    });
  }

  // help
  if($('helpSubmitBtn')) $('helpSubmitBtn').addEventListener('click', submitHelp);
  if($('helpFileUpload')) $('helpFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'helpFileLink','helpUploadStatus'); });

  // payment upload
  if($('paymentFileUpload')) $('paymentFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'paymentFileLink','paymentUploadStatus'); });

  // page navigation & games/apps bindings
  if($('cardGames')) $('cardGames').addEventListener('click', ()=> showGames());
  if($('cardApps')) $('cardApps').addEventListener('click', ()=> showApps());

  if($('gameSelect')) $('gameSelect').addEventListener('change', function(){ buildGameOptions(this.value); updateSubmitButtonGames(); });
  if($('idField')) $('idField').addEventListener('input', updateSubmitButtonGames);
  if($('submitForm')) $('submitForm').addEventListener('click', ()=> placeOrderFromUI('gamesPage'));
  if($('goOrdersBtn')) $('goOrdersBtn').addEventListener('click', ()=> showOrders());

  if($('appSelect')) $('appSelect').addEventListener('change', function(){ buildAppOptions(this.value); updateSubmitButtonApps(); });
  if($('appIdField')) $('appIdField').addEventListener('input', updateSubmitButtonApps);
  if($('appSubmitForm')) $('appSubmitForm').addEventListener('click', ()=> placeOrderFromUI('appsPage'));
  if($('goOrdersBtnApp')) $('goOrdersBtnApp').addEventListener('click', ()=> showOrders());

  // back buttons
  if($('gamesBackBtn')) $('gamesBackBtn').addEventListener('click', ()=> showHome());
  if($('appsBackBtn')) $('appsBackBtn').addEventListener('click', ()=> showHome());
  if($('profileBackBtn')) $('profileBackBtn').addEventListener('click', ()=> showHome());
  if($('helpBackBtn')) $('helpBackBtn').addEventListener('click', ()=> showHome());
  if($('pdBackBtn')) $('pdBackBtn').addEventListener('click', ()=> returnFromPaymentDetails());
  if($('ordersBackBtn')) $('ordersBackBtn').addEventListener('click', ()=> showHome());
  if($('reviewBackBtn')) $('reviewBackBtn').addEventListener('click', ()=> showHome());
  if($('offersBackBtn')) $('offersBackBtn').addEventListener('click', ()=> showHome());

  // payment details bindings
  if($('pdCashSelect')) $('pdCashSelect').addEventListener('change', onPdCashChange);
  if($('pdToggleQrBtn')) $('pdToggleQrBtn').addEventListener('click', toggleQr);
  if($('pdCopyBtn')) $('pdCopyBtn').addEventListener('click', ()=>{
    const v = $('pdCopyField') ? $('pdCopyField').value : '';
    if(!v){ alert('لا يوجد شيء لنسخه'); return; }
    navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(v).then(()=> alert('تم النسخ')) : (function(){ try{ const ta = document.createElement('textarea'); ta.value=v; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('تم النسخ'); }catch(e){ alert('فشل النسخ'); } })();
  });
  if($('pdSubmitForm')) $('pdSubmitForm').addEventListener('click', submitPaymentDetails);
async function submitPaymentDetails(e) {
  e.preventDefault();
  
  const phone = document.getElementById("chargePhone").value.trim();
  const amount = parseFloat(document.getElementById("chargeAmount").value);
  const method = document.getElementById("chargeMethod").value;

  try {
    const resp = await fetch(API_ROOT + "api/charges", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, amount, method })
    });

    const data = await resp.json();
    alert("✅ تمت العملية: " + JSON.stringify(data));
  } catch (err) {
    console.error(err);
    alert("❌ حدث خطأ أثناء إرسال طلب الشحن");
  }
}

  // load saved profile (if موجود)
  const saved = localStorage.getItem('user_profile_v1');
  if(saved){
    try{ currentProfile = JSON.parse(saved); }catch(e){ currentProfile = null; }
  }
  if(!currentProfile){
    let pn = localStorage.getItem('personalNumber');
    if(!pn){ pn = String(Math.floor(1000000 + Math.random()*9000000)); localStorage.setItem('personalNumber', pn); }
    currentProfile = { personalNumber: pn, name:'ضيف', email:'', phone:'', balance:0, canEdit:false };
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  }
  refreshUIFromProfile();

  // show login or home
  const isGuest = (!currentProfile || !currentProfile.name || currentProfile.name === 'ضيف');
  const hasCreds = !!(currentProfile && currentProfile.password);
  if (isGuest || !hasCreds) { hideAllPages(); if($('loginPage')) show('loginPage'); window.scrollTo({ top: 0 }); }
  else { showHome(); }

  // poll periodically
  setInterval(()=>{
    try{ refreshNotificationsCount(); }catch(e){ console.warn('refreshNotificationsCount interval error', e); }
    try{ fetchOffers(); }catch(e){ console.warn('fetchOffers interval error', e); }
  }, 6000);

  // initial fetches
  refreshNotificationsCount();
  fetchOffers();
});

/* ---------- UI & helper functions (كما في ملفك الأصلي) ---------- */

function showHome(){ hideAllPages(); show('homePage'); window.scrollTo({top:0}); }
function showGames(){ hideAllPages(); show('gamesPage'); window.scrollTo({top:0}); }
function showApps(){ hideAllPages(); show('appsPage'); window.scrollTo({top:0}); }
function showHelp(){ hideAllPages(); show('helpPage'); window.scrollTo({top:0}); }
function openProfile(){ hideAllPages(); show('profilePage'); fillProfileFields(); }
function openChargePage(){ hideAllPages(); show('paymentDetailsPage'); $('pdTitle').textContent='شحن الرصيد'; $('pdTopInfo').textContent='اطلب شحن الرصيد عبر رفع ايصال التحويل'; }
function showOrders(){ hideAllPages(); show('ordersPage'); loadOrdersList(); }
function showOffers(){ hideAllPages(); show('offersPage'); fetchOffers(); }

function refreshUIFromProfile(){
  try{
    $('personalNum').textContent = currentProfile.personalNumber || '';
    if($('personalField')) $('personalField').value = currentProfile.personalNumber || '';
    if($('appPersonalField')) $('appPersonalField').value = currentProfile.personalNumber || '';
    if($('helpPersonalField')) $('helpPersonalField').value = currentProfile.personalNumber || '';
    if($('loginPersonalNumber')) $('loginPersonalNumber').value = currentProfile.personalNumber || '';
    $('sidebarName').textContent = currentProfile.name || 'ضيف';
    $('sidebarAvatar').textContent = (currentProfile.name && currentProfile.name.trim().length>0) ? currentProfile.name.trim().charAt(0).toUpperCase() : 'أ';
    $('sidebarPersonal').textContent = 'رقم: ' + (currentProfile.personalNumber || '');

    // show balance
    const bal = Number(currentProfile.balance || 0);
    const bEl = $('balanceBox');
    if(bEl){
      bEl.textContent = `رصيدك: ${bal.toLocaleString('en-US')} ل.س`;
      bEl.classList.remove('hidden');
      bEl.style.opacity = bal === 0 ? '0.85' : '1';
    }
  }catch(e){ console.warn('refreshUIFromProfile error', e); }
}
function fillProfileFields(){
  if($('profileName')) $('profileName').value = currentProfile.name || '';
  if($('profileEmail')) $('profileEmail').value = currentProfile.email || '';
  if($('profilePassword')) $('profilePassword').value = currentProfile.password || '';
  if($('profilePhone')) $('profilePhone').value = currentProfile.phone || '';
  applyProfileEditState();
}
function applyProfileEditState(){
  const canEdit = !!currentProfile.canEdit;
  ['profileName','profileEmail','profilePassword','profilePhone'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(canEdit){ el.removeAttribute('readonly'); } else { el.setAttribute('readonly','readonly'); }
  });
  if(canEdit){ if($('requestEditBtn')) $('requestEditBtn').classList.add('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.remove('hidden'); if($('profileMsg')) $('profileMsg').textContent='يمكنك تعديل بياناتك الآن مرة واحدة ثم اضغط حفظ.'; }
  else { if($('requestEditBtn')) $('requestEditBtn').classList.remove('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.add('hidden'); if($('profileMsg')) $('profileMsg').textContent='للتعديل اطلب موافقة من الإدارة عبر الزر أدناه.'; }
}

/* ---------- New: search-profile (مصدر: merged from index2) ----------
   زر btnSearch يستدعي /api/search-profile للبحث عن الحساب عبر البريد أو الهاتف.
*/
async function searchProfileFromUI(){
  const email = $('loginEmail').value.trim();
  const phone = $('loginPhone').value.trim();
  const errEl = $('loginError'); if(errEl){ errEl.style.display='none'; errEl.textContent=''; }
  if(!email && !phone){
    if(errEl){ errEl.style.display='block'; errEl.textContent='ادخل بريد أو هاتف للبحث'; }
    return;
  }
  try{
    const resp = await fetch(API_ROOT + 'api/search-profile', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ email: email || null, phone: phone || null })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok && data.profile){
      currentProfile = data.profile;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      alert('تم العثور على حسابك. رقمك الشخصي: ' + currentProfile.personalNumber + '\nرصيدك: ' + (currentProfile.balance||0));
      hideAllPages(); showHome();
    } else {
      if(errEl){ errEl.style.display='block'; errEl.textContent = 'لم يتم العثور على حساب. اضغط "إنشاء حساب جديد" لإنشاء حساب.'; }
    }
  }catch(e){
    console.error('searchProfileFromUI error', e);
    if(errEl){ errEl.style.display='block'; errEl.textContent = 'خطأ في الاتصال'; }
  }
}

/* ---------- New: createAccountFromUI ----------
   زر إنشاء حساب يستدعي /api/register (server سيعيد الموجود إن كان موجودًا).
*/
async function createAccountFromUI(){
  const name = $('loginName').value.trim();
  const email = $('loginEmail').value.trim();
  const phone = $('loginPhone').value.trim();
  const password = $('loginPassword').value || '';
  const errEl = $('loginError'); if(errEl){ errEl.style.display='none'; errEl.textContent=''; }
  if(!name){ if(errEl){ errEl.style.display='block'; errEl.textContent='ادخل اسمك لإنشاء الحساب'; } return; }
  if(!email && !phone){ if(errEl){ errEl.style.display='block'; errEl.textContent='ادخل بريد أو هاتف لإنشاء الحساب'; } return; }
  try{
    const resp = await fetch(API_ROOT + 'api/register', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ name, email: email||null, phone: phone||null, password })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok && data.profile){
      currentProfile = data.profile;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      alert('تم إنشاء الحساب أو استرجاع الحساب الموجود. رقمك الشخصي: ' + currentProfile.personalNumber + '\nرصيدك: ' + (currentProfile.balance||0));
      hideAllPages(); showHome();
    } else {
      if(errEl){ errEl.style.display='block'; errEl.textContent = 'فشل الإنشاء: ' + (data && data.error ? data.error : 'خطأ غير معروف'); }
    }
  }catch(e){
    console.error('createAccountFromUI error', e);
    if(errEl){ errEl.style.display='block'; errEl.textContent = 'خطأ في الاتصال'; }
  }
}

/* ---------- doLogin (الزر القديم) ----------
   احتفظت بمنطق doLogin كما كان: يستدعي api/register (يتوافق مع السيرفر لأنه سيعيد البروفايل إن وجد).
*/
async function doLogin(){
  const name = $('loginName').value.trim();
  const email = $('loginEmail').value.trim();
  const password = $('loginPassword').value;
  const phone = $('loginPhone').value.trim();
  const personal = $('loginPersonalNumber').value || currentProfile.personalNumber;
  const errEl = $('loginError');
  if(errEl) errEl.style.display='none';
  if(!name){ if(errEl){ errEl.textContent='الرجاء إدخال الاسم'; errEl.style.display='block'; } return; }
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ if(errEl){ errEl.textContent='صيغة البريد الإلكتروني غير صحيحة'; errEl.style.display='block'; } return; }
  if(!password){ if(errEl){ errEl.textContent='الرجاء إدخال كلمة السر'; errEl.style.display='block'; } return; }

  try{
    const resp = await fetch(API_ROOT + 'api/register', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ name, email, password, phone, personalNumber: personal })
    });
    const data = await resp.json().catch(()=>null);
    if (data && data.ok) {
      currentProfile = data.profile ? Object.assign({}, currentProfile, data.profile) : { name, email, phone, password, personalNumber: personal, balance: (data.profile && data.profile.balance) || currentProfile.balance || 0 };
      if (!currentProfile.personalNumber) currentProfile.personalNumber = personal;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      localStorage.setItem('is_logged_in', '1');
      refreshUIFromProfile();
      showHome();
      alert('تم تسجيل الدخول');
    } else {
      alert('فشل التسجيل: ' + (data && data.error ? data.error : 'خطأ غير معروف'));
    }
  }catch(e){
    console.error('doLogin error', e);
    alert('خطأ في الاتصال');
  }
}

/* ---------- profile edit / help / upload / orders / charges ----------
   أبقيت منطقك كما كان في الملف الأساسي — لم أغيره إلا ليتوافق مع currentProfile المحدث.
*/

async function requestProfileEdit(){
  const ok = confirm('سيتم إرسال طلب تعديل بياناتك للإدارة. هل تريد المتابعة؟');
  if(!ok) return;
  try{
    const resp = await fetch(API_ROOT + 'api/profile/request-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if (data && data.ok) {
      alert('تم إرسال طلب التعديل. انتظر موافقة الإدارة.');
      if($('requestEditBtn')) $('requestEditBtn').textContent='تم إرسال الطلب';
      setTimeout(() => { if($('requestEditBtn')) $('requestEditBtn').textContent='طلب تعديل معلوماتك'; }, 10000);
    } else {
      alert('فشل الإرسال');
    }
  }catch(e){ console.error('requestProfileEdit error', e); alert('خطأ في الاتصال'); }
}

async function confirmProfileSave(){
  const name = $('profileName').value.trim();
  const email = $('profileEmail').value.trim();
  const password = $('profilePassword').value;
  const phone = $('profilePhone').value.trim();

  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    alert('البريد غير صالح');
    return;
  }

  try {
    const resp = await fetch(API_ROOT + 'api/profile/submit-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({
        personal: currentProfile.personalNumber,
        name, email, password, phone
      })
    });
    const data = await resp.json().catch(()=>null);

    if(data && data.ok){
      if(data.profile){
        currentProfile = Object.assign({}, currentProfile, data.profile);
      } else {
        currentProfile.name = name || currentProfile.name;
        currentProfile.email = email || currentProfile.email;
        currentProfile.password = password || currentProfile.password;
        currentProfile.phone = phone || currentProfile.phone;
      }
      currentProfile.canEdit = false;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));

      alert('تم حفظ التعديلات');
      applyProfileEditState();
      refreshUIFromProfile();
    } else {
      alert('لا يمكنك التعديل الآن: ' + (data && data.error ? data.error : 'خطأ غير معروف'));
    }
  } catch(err){
    console.error(err);
    alert('فشل الاتصال بالخادم');
  }
}

async function submitHelp(){
  const issue = $('helpIssueSelect').value;
  const fileLink = $('helpFileLink').value;
  const desc = $('helpDesc').value.trim();
  const personal = currentProfile.personalNumber;
  if(!issue){ alert('اختر مشكلتك'); return; }
  try{
    const resp = await fetch(API_ROOT + 'api/help', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal, issue, fileLink, desc, name: currentProfile.name, email: currentProfile.email, phone: currentProfile.phone })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){ alert('تم ارسال المشكلة'); hide('helpPage'); showHome(); } else { alert('فشل الارسال'); }
  }catch(e){ console.error('submitHelp error', e); alert('خطأ في الاتصال'); }
}

/* upload to imgbb (client) — كما في ملفك */
async function uploadFileToImgbb(file, targetInputId = 'paymentFileLink', statusElId='paymentUploadStatus'){
  if(!file) return;
  const statusEl = $(statusElId);
  if(statusEl) statusEl.textContent = 'جارية عملية الرفع... 0%';
  try{
    const IMGBB_KEY = "e5603dfd5675ed2b5a671577abcf6d33"; // إن أردت استبداله ضع المفتاح الخاص بك
    const fd = new FormData();
    fd.append('image', file);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`);
    xhr.onload = function(){
      if(xhr.status>=200 && xhr.status<300){
        try{
          const resp = JSON.parse(xhr.responseText||'{}');
          const url = resp && resp.data && (resp.data.url || resp.data.display_url);
          if(url){
            $(targetInputId).value = url;
            if(statusEl) statusEl.textContent = 'تم الرفع بنجاح';
            alert('تم رفع الملف');
          } else {
            if(statusEl) statusEl.textContent = 'فشل الرفع';
            alert('فشل رفع الملف');
          }
        }catch(e){ if(statusEl) statusEl.textContent = 'خطأ في الرفع'; alert('خطأ في رفع الملف'); }
      } else {
        if(statusEl) statusEl.textContent = 'فشل الرفع';
        alert('فشل الرفع: ' + xhr.status);
      }
    };
    xhr.onerror = function(){ if(statusEl) statusEl.textContent='خطأ في الشبكة'; alert('خطأ في الشبكة أثناء الرفع'); };
    xhr.upload.onprogress = function(ev){ if(ev.lengthComputable){ const pct = Math.round((ev.loaded/ev.total)*100); if(statusEl) statusEl.textContent = `جارية عملية الرفع... ${pct}%`; } };
    xhr.send(fd);
  }catch(e){ console.error(e); if($(statusElId)) $(statusElId).textContent = 'خطأ أثناء الرفع'; alert('خطأ أثناء الرفع'); }
}

/* games/apps options & ordering (كما في ملفك) */
function buildGameOptions(val){
  if($('optionsContainer')) $('optionsContainer').innerHTML='';
  selectedGameOption=''; if($('priceDisplay')) $('priceDisplay').textContent='';
  if(val==='فري فاير ايدي'){ currentMap = priceMapFF; currentMap_num = priceMapFF_num; }
  else if(val==='ببجي ايدي'){ currentMap = priceMapPUBG; currentMap_num = priceMapPUBG_num; }
  else if(val==='جواكر'){ currentMap = priceMappubg1; currentMap_num = priceMappubg1_num; }
  else { currentMap = null; currentMap_num = {}; }
  if(currentMap && $('optionsContainer')){
    Object.keys(currentMap).forEach(opt=>{
      const d = document.createElement('div'); d.className='button-option'; d.textContent = opt;
      d.addEventListener('click', ()=> {
        document.querySelectorAll('#optionsContainer .button-option').forEach(x=>x.classList.remove('selected'));
        d.classList.add('selected');
        selectedGameOption = opt;
        if($('priceDisplay')) { $('priceDisplay').textContent = `الحزمة: ${opt}\nالسعر: ${currentMap[opt]}`; $('priceDisplay').style.color='#0f0'; }
        updateSubmitButtonGames();
      });
      $('optionsContainer').appendChild(d);
    });
  }
}

function buildAppOptions(val){
  if($('optionsContainerApps')) $('optionsContainerApps').innerHTML='';
  selectedAppOption=''; if($('priceDisplayApps')) $('priceDisplayApps').textContent='';
  if(priceMapApps[val] && $('optionsContainerApps')){
    const d = document.createElement('div'); d.className='button-option'; d.textContent = val;
    d.addEventListener('click', ()=> {
      document.querySelectorAll('#optionsContainerApps .button-option').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      selectedAppOption = val;
      if($('priceDisplayApps')) { $('priceDisplayApps').textContent = `السعر: ${priceMapApps[val]}`; $('priceDisplayApps').style.color='#0f0'; }
      updateSubmitButtonApps();
    });
    $('optionsContainerApps').appendChild(d);
  }
}
function updateSubmitButtonGames(){ const idf=$('idField') ? $('idField').value.trim() : ''; if($('submitForm')) $('submitForm').disabled = !(selectedGameOption && idf); }
function updateSubmitButtonApps(){ const idf=$('appIdField') ? $('appIdField').value.trim() : ''; if($('appSubmitForm')) $('appSubmitForm').disabled = !(selectedAppOption && idf); }

async function placeOrderFromUI(fromPage){
  try{
    if(fromPage === 'gamesPage'){
      const personal = $('personalField').value;
      const game = $('gameSelect').value;
      const idField = $('idField').value.trim();
      const opt = selectedGameOption;
      if(!game || !idField || !opt){ alert('اكمل البيانات'); return; }
      let price = 0;
      if(currentMap_num && currentMap_num[opt]) price = Number(currentMap_num[opt]);
      else {
        const raw = $('priceDisplay') ? $('priceDisplay').textContent : '';
        price = parseInt((raw.replace(/\D/g,''))||0,10);
      }
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'شحن لعبة', item: `${game} - ${opt}`, idField, paidAmount: price });
    } else if(fromPage === 'appsPage'){
      const personal = $('appPersonalField').value;
      const app = $('appSelect').value;
      const idField = $('appIdField').value.trim();
      const opt = selectedAppOption;
      if(!app || !idField || !opt){ alert('اكمل البيانات'); return; }
      let price = priceMapApps_num[opt] || 0;
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'شراء تطبيق', item: `${app} - ${opt}`, idField, paidAmount: price });
    } else {
      alert('مصدر غير معروف للطلب');
    }
  }catch(e){
    console.error('placeOrderFromUI', e);
    alert('خطأ أثناء إرسال الطلب');
  }
}

async function attemptChargeAndSendOrder(orderBody){
  const bal = Number(currentProfile.balance || 0);
  const price = Number(orderBody.paidAmount || 0);
  if(isNaN(price) || price <= 0){
    alert('تعذر تحديد سعر الحزمة');
    return;
  }
  if(bal < price){
    alert('مافي رصيد كافي');
    return;
  }

  // deduct locally (optimistic)
  currentProfile.balance = bal - price;
  localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  refreshUIFromProfile();

  const body = {
    personal: orderBody.personal,
    phone: orderBody.phone,
    type: orderBody.type,
    item: orderBody.item,
    idField: orderBody.idField,
    fileLink: orderBody.fileLink || '',
    cashMethod: orderBody.cashMethod || '',
    paidWithBalance: true,
    paidAmount: price
  };

  try{
    const r = await fetch(API_ROOT + 'api/orders', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
    const data = await r.json().catch(()=>null);
    if(data && data.ok){
      hideAllPages(); show('reviewPage'); if($('reviewMsg')) $('reviewMsg').textContent = 'تم ارسال طلبك وسيتم مراجعته (مدفوع من رصيدك).';
      localStorage.setItem('lastOrderId', data.order && data.order.id ? data.order.id : '');
      try{
        const el = document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid rgba(255,203,1,0.06)'; el.style.marginBottom='8px';
        el.innerHTML = `<div><strong>تم إرسال طلب ودُفع من رصيدك</strong></div><div>${body.item} - المبلغ: ${price.toLocaleString('en-US')} ل.س</div>`;
        const list = $('notifList'); if(list) list.prepend(el);
      }catch(e){}
    } else {
      currentProfile.balance = bal;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      alert('فشل إرسال الطلب إلى الخادم: ' + (data && data.error ? data.error : 'خطأ'));
    }
  }catch(err){
    console.error(err);
    currentProfile.balance = bal;
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
    refreshUIFromProfile();
    alert('خطأ في الاتصال عند إرسال الطلب');
  }
}

/* payment details helpers (مختصر) */
let previousBeforePayment = null;
function showPaymentDetailsFromSubmit(fromPage){
  previousBeforePayment = fromPage;
  hideAllPages(); show('paymentDetailsPage');
}
function returnFromPaymentDetails(){ if(previousBeforePayment==='gamesPage') showGames(); else if(previousBeforePayment==='appsPage') showApps(); else showHome(); }
function onPdCashChange(){ const value = $('pdCashSelect').value; if(value==='sham'){ if($('shamFields')) $('shamFields').style.display='block'; if($('syrtelFields')) $('syrtelFields').style.display='none'; if($('hawalaFields')) $('hawalaFields').style.display='none'; } else if(value==='syrtel'){ if($('syrtelFields')) $('syrtelFields').style.display='block'; if($('shamFields')) $('shamFields').style.display='none'; if($('hawalaFields')) $('hawalaFields').style.display='none'; } else if(value==='hawala'){ if($('hawalaFields')) $('hawalaFields').style.display='block'; if($('shamFields')) $('shamFields').style.display='none'; if($('syrtelFields')) $('syrtelFields').style.display='none'; } else { if($('shamFields')) $('shamFields').style.display='none'; if($('syrtelFields')) $('syrtelFields').style.display='none'; if($('hawalaFields')) $('hawalaFields').style.display='none'; } }
function toggleQr(){ const q = $('qrContainer'); if(!q) return; q.style.display = q.style.display === 'none' ? 'block' : 'none'; }

/* load orders list / notifications (كما في الملف الأساسي) */
async function loadOrdersList(){
  try{
    const personal = currentProfile.personalNumber;
    const resp = await fetch(API_ROOT + 'api/notifications/' + personal);
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      const orders = data.orders || [];
      const charges = data.charges || [];
      const container = $('ordersList'); if(container) container.innerHTML = '';
      if(orders.length===0 && charges.length===0){ if(container) container.innerHTML = '<div>لا توجد طلبات حتى الآن.</div>'; return; }
      orders.forEach(o=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${o.id}</strong> - ${o.type} - ${o.item || ''} <br> الايدي: ${o.idField || ''} <br> الهاتف: ${o.phone || ''} <br> الحالة: <strong>${o.status}</strong> <br> أنشئ: ${new Date(o.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
      charges.forEach(c=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${c.id}</strong> - شحن رصيد - المبلغ: ${c.amount} <br> الحالة: <strong>${c.status}</strong> <br> أنشئ: ${new Date(c.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
    }
  }catch(e){ console.error('loadOrdersList error', e); }
}

</script>
</body>
  </html>
