<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ÙˆÙ‚Ø¹ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ â€” Ù†Ø³Ø®Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
  <style>
  /* (CSS Ù…Ø¯Ù…Ø¬ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ â€” Ù„Ù… Ø£Ù„Ù…Ø³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ù„ØªÙØ§Ø¯ÙŠ ÙƒØ³Ø± Ø§Ù„ØªØµÙ…ÙŠÙ…) */
  * { margin:0; padding:0; box-sizing:border-box }
  html,body { height:100% }
  body { font-family:Arial,Helvetica,sans-serif; background:#000; color:#fff; overflow-x:hidden }

  header { background:#111; padding:10px 20px; position:relative; text-align:center }
  header img { height:90px; width:auto; display:block; margin:0 auto }
  #ordersStatusBar { margin:8px auto 0; max-width:720px; padding:4px 8px; border-radius:6px; text-align:center; min-height:22px; display:none; overflow:hidden; white-space:normal; pointer-events:none }
  .status-line { color:#FFCB01; padding:2px 4px; margin:2px 0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; font-weight:700; border-bottom:1px solid rgba(255,203,1,0.06); line-height:1.1 }
  .menu { position:absolute; right:20px; font-size:28px; cursor:pointer; color:#FFCB01; top:50%; transform:translateY(-50%) }
  #personalNumberDisplay { position:absolute; left:20px; top:30%; transform:translateY(-50%); color:#FFCB01; font-weight:bold; font-size:13px }
  #notifBell { position:absolute; right:68px; top:50%; transform:translateY(-50%); font-size:22px; cursor:pointer; color:#FFCB01 }
  #notifBell .badge { background:#ff3b30; color:#fff; border-radius:999px; padding:2px 6px; font-size:12px; margin-left:6px; vertical-align:middle }

  #balanceBox {
    position:absolute;
    left:20px;
    top:58%;
    transform:translateY(0);
    background: #FFCB01;
    color: #000;
    padding:6px 10px;
    border-radius:8px;
    font-weight:700;
    font-size:13px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    white-space:nowrap;
  }
  #balanceBox.hidden { display:none; }

  .notif-panel { position:fixed; top:70px; right:20px; width:360px; max-width:92%; background:#111; border:2px solid #FFCB01; border-radius:10px; padding:10px; z-index:1500; box-shadow:0 6px 30px rgba(0,0,0,0.6) }
  .notif-panel.hidden { display:none }
  .notif-empty { color:#aaa; padding:8px; text-align:center }

  .sidebar {
    position:fixed;
    top:0;
    right:-100%;
    width:80%;
    max-width:300px;
    height:100%;
    background:transparent;
    padding:20px;
    transition:0.28s;
    z-index:1000;
    overflow-y:auto;
    border-left:2px solid rgba(255,255,255,0.03);
  }
  .sidebar.active { right:0; background:rgba(17,17,17,0.98); }

  .sidebar .avatar { width:48px; height:48px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:20px; color:#FFCB01; border:2px solid #FFCB01; }

  .sidebar a {
    display:block;
    color:#fff !important;
    text-decoration:none;
    padding:10px 12px;
    margin:6px 0;
    font-size:16px;
    font-weight:700;
    text-align:right;
    border-radius:6px;
    transition: color 0.15s, background 0.15s;
    background: transparent;
  }
  .sidebar a:hover { color:#FFCB01; background:rgba(255,203,1,0.04); }

  .sidebar .small-btn {
    display:block;
    width:100%;
    text-align:center;
    background:transparent;
    color:#fff;
    border:2px solid rgba(255,255,255,0.05);
    padding:10px;
    border-radius:8px;
    margin-top:12px;
    cursor:pointer;
  }
  .sidebar .small-btn:hover { border-color:rgba(255,203,1,0.35); color:#FFCB01; }

  .container { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; padding:20px }
  .card { background:#111; border:2px solid #FFCB01; border-radius:12px; padding:20px; text-align:center; cursor:pointer; transition:.25s; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center }
  .card:hover { background:#FFCB01; color:#000 }
  .hidden { display:none }
  .form-box { background:#111; border:2px solid #FFCB01; border-radius:12px; padding:20px; margin:20px }
  select,input,button,textarea { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:none; font-size:16px; background:#222; color:#fff }
  .button-option { background:#222; color:#FFCB01; border:2px solid #FFCB01; margin:5px 0; padding:10px; border-radius:8px; cursor:pointer; width:100%; text-align:center; font-weight:bold }
  .button-option.selected { background:#FFCB01; color:#000 }
  button { background:#FFCB01; color:#000; font-weight:bold; cursor:pointer; border-radius:8px; padding:10px }
  .small-btn { display:inline-block; padding:8px 12px; border-radius:8px; background:#FFCB01; color:#000; cursor:pointer; margin-top:8px; text-align:center }
  .back-btn { display:block; margin:20px auto; background:#FFCB01; color:#000; padding:10px; border-radius:8px; text-align:center; font-weight:bold; cursor:pointer }
  .price-note { color:#FFCB01; font-weight:bold; margin:10px 0; font-size:14px; white-space:pre-line }
  .orders-list { padding:10px; margin:10px; background:#111; border-radius:10px; border:1px solid #333 }
  .order-item { padding:12px; border:2px solid #FFCB01; border-radius:8px; margin-bottom:10px; background:#111 }
  .login-page { max-width:600px; margin:18px auto; padding:16px }
  .muted-small { font-size:13px; color:#aaa; margin-top:6px }
  .upload-status { font-size:13px; color:#aaa; margin-top:6px }

  @media (min-width: 900px) {
    .sidebar { right:0; position:static; width:260px; max-width:none; background:transparent; border-left:none; padding:20px 10px 20px 20px; }
    .sidebar.active { right:0; background:transparent; }
    main { margin-right:260px; }
  }

  @media (max-width: 899px) {
    .menu { display:block }
    header img { height:72px }
    #personalNumberDisplay { top:30%; left:10px; }
    #balanceBox { top:66%; left:10px; }
  }

  /* Ø²Ø± Ø´Ø­Ù† Ù…Ù…ÙŠØ² */
  #btnCharge {
    background: linear-gradient(270deg, #FFCB01, #FF9F00, #FFCB01) !important;
    background-size: 600% 600%;
    animation: moveGradient 6s ease infinite;
    color: #000 !important;
    border: none !important;
    padding: 12px !important;
    width: 100% !important;
    font-weight: 800 !important;
    border-radius: 10px !important;
    cursor: pointer;
  }
  @keyframes moveGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  </style>
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/W1Ysr3QG/image.png" alt="Logo">
    <div id="personalNumberDisplay">Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ: <span id="personalNum">0000000</span></div>
    <div id="balanceBox" class="hidden">Ø±ØµÙŠØ¯Ùƒ: 0 Ù„.Ø³</div>
    <div id="notifBell" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">ğŸ””<span id="notifBadge" class="badge hidden">0</span></div>
    <div class="menu" id="menuBtn">â˜°</div>
    <div id="ordersStatusBar" aria-live="polite" role="status" style="display:none"></div>
  </header>

  <!-- notif panel -->
  <div id="notifPanel" class="notif-panel hidden" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h4 style="color:#FFCB01;margin:0">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
      <div style="cursor:pointer;color:#FFCB01" id="notifCloseBtn">Ã—</div>
    </div>
    <div id="notifList"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <div class="small-btn" id="notifClearBtn">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</div>
      <div class="small-btn" id="notifGoOffersBtn">Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¹Ø±ÙˆØ¶</div>
    </div>
  </div>

  <!-- sidebar -->
  <div id="sidebar" class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="display:flex;gap:10px;align-items:center;cursor:pointer" id="sidebarProfileArea">
        <div class="avatar" id="sidebarAvatar">Ø£</div>
        <div>
          <div id="sidebarName" style="color:#FFCB01;font-weight:700">Ø¶ÙŠÙ</div>
          <div id="sidebarPersonal" style="color:#ccc;font-size:13px">--</div>
        </div>
      </div>
      <div style="cursor:pointer;color:#FFCB01" id="sidebarCloseBtn">Ã—</div>
    </div>

    <a href="#" id="linkHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="#" id="linkOrders">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
    <a href="#" id="linkHelp">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø©</a>
    <a href="#" id="linkOffers">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§</a>
    <a href="#" id="linkJoinWhats">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ø¬ØªÙ…Ø¹ ÙˆØ§ØªØ³Ø§Ø¨</a>
    <div style="margin-top:16px;">
      <div class="small-btn" id="btnCharge">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</div>
    </div>
  </div>

  <!-- pages -->
  <main id="mainContent">
    <!-- login page (Ù…Ø¹Ø¯Ù„: Ø§Ø¶ÙØª Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨) -->
    <div id="loginPage" class="form-box login-page hidden">
      <h3 style="text-align:center;color:#FFCB01;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
      <label>Ø¶Ø¹ Ø§Ù„Ø£Ø³Ù…</label>
      <input type="text" id="loginName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="loginEmail" placeholder="example@domain.com">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
      <div style="position:relative;">
        <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button id="loginTogglePwd" style="position:absolute;left:6px;top:10px;height:36px;width:80px;cursor:pointer;">Ø§Ø¸Ù‡Ø§Ø±</button>
      </div>
      <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ</label>
      <input type="text" id="loginPhone" placeholder="Ù…Ø«Ø§Ù„: 0999xxxxxx">
      <label>Ø¶Ø¹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø´Ø®ØµÙŠ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
      <input type="text" id="loginPersonalNumber" readonly>
      <div class="small-muted" style="margin-top:6px;">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù† ÙŠØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§ÙŠ ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.
        ÙÙ‚Ø· Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø§ØµÙ„ÙŠØ© ÙÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ù…Ø´ÙƒÙ„Ø© Ù†Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ.
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙŠØ¹Ù…Ù„ ÙƒÙ€ register legacy) -->
        <button id="doLoginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« / Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© -->
        <button id="btnSearch" style="background:#2563eb;color:#fff">Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <button id="btnCreate" style="background:#10b981;color:#fff">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      </div>
      <div id="loginError" class="error" style="display:none;color:#ff8080;margin-top:8px;"></div>
    </div>

    <!-- profile page -->
    <div id="profilePage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="profileName" readonly>
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="profileEmail" readonly>
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
        <input type="password" id="profilePassword" readonly>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="text" id="profilePhone" readonly>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button id="requestEditBtn">Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ</button>
          <button id="confirmSaveBtn" class="hidden">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
        <div class="back-btn" id="profileBackBtn">â¬… Ø±Ø¬ÙˆØ¹</div>
        <div id="profileMsg" class="muted-small"></div>
      </div>
    </div>

    <!-- home page -->
    <div id="homePage" class="hidden">
      <div class="container">
        <div class="card" id="cardGames">Ù‚Ø³Ù… Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="card" id="cardApps">Ù‚Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</div>
      </div>
    </div>

    <!-- help page -->
    <div id="helpPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø©</h3>
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø´Ø®ØµÙŠ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
        <input type="text" id="helpPersonalField" readonly>
        <label>-Ø§Ø®ØªØ± Ù…Ø´ÙƒÙ„ØªÙƒ-</label>
        <select id="helpIssueSelect">
          <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ø´ÙƒÙ„ØªÙ„Ùƒ --</option>
          <option value="Ù„Ø§ Ø§Ø³ØªØ·ÙŠØ¹ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ù„Ø§ Ø§Ø³ØªØ·Ø¹ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
          <option value="Ù‚Ù…Øª Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ„Ù… ÙŠÙØ±Ø§Ø¬Ø¹ Ø·Ù„Ø¨ÙŠ">Ù‚Ù…Øª Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ„Ù… ÙŠÙØ±Ø§Ø¬Ø¹ Ø·Ù„Ø¨ÙŠ</option>
          <option value="ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ÙŠ Ù„ÙƒÙ† Ù„Ù… ÙŠØµÙ„Ù†ÙŠ Ø´ÙŠØ¡">ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ÙŠ Ù„ÙƒÙ† Ù„Ù… ÙŠØµÙ„Ù†ÙŠ Ø´ÙŠØ¡</option>
          <option value="Ù„Ø§ Ø§Ø³ØªØ·ÙŠØ¹ Ø§Ø±Ø³Ø§Ù„ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©">Ù„Ø§ Ø§Ø³ØªØ·ÙŠØ¹ Ø§Ø±Ø³Ø§Ù„ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©</option>
        </select>
        <label>Ø§Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="file" id="helpFileUpload" accept="image/*">
        <div class="upload-status" id="helpUploadStatus"></div>
        <input type="text" id="helpFileLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" readonly>
        <label>ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
        <textarea id="helpDesc" rows="5" maxlength="100" placeholder="Ø§ÙƒØªØ¨ Ù…Ø´ÙƒÙ„ØªÙƒ ÙˆØ¶Ø¹ Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø·Ù„Ø¨ #***********"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="helpSubmitBtn">Ø¥Ø±Ø³Ø§Ù„</button>
          <div class="back-btn" id="helpBackBtn">â¬… Ø±Ø¬ÙˆØ¹</div>
        </div>
      </div>
    </div>

    <!-- games page -->
    <div id="gamesPage" class="hidden">
      <div class="form-box">
        <h3>Ø§Ø®ØªØ± Ù„Ø¹Ø¨ØªÙƒ</h3>
        <select id="gameSelect">
          <option value="">-- Ø§Ø®ØªØ± Ù„Ø¹Ø¨Ø© --</option>
          <option value="Ø£ÙƒÙˆØ§Ø¯ ÙØ±ÙŠ ÙØ§ÙŠØ±">Ø£ÙƒÙˆØ§Ø¯ ÙØ±ÙŠ ÙØ§ÙŠØ±</option>
          <option value="ÙØ±ÙŠ ÙØ§ÙŠØ± Ø§ÙŠØ¯ÙŠ">ÙØ±ÙŠ ÙØ§ÙŠØ± Ø§ÙŠØ¯ÙŠ</option>
          <option value="Ø¨Ø¨Ø¬ÙŠ Ø§ÙŠØ¯ÙŠ">Ø¨Ø¨Ø¬ÙŠ Ø§ÙŠØ¯ÙŠ</option>
          <option value="Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø¨Ø¬ÙŠ">Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø¨Ø¬ÙŠ</option>
          <option value="Ø¬ÙˆØ§ÙƒØ±">Ø¬ÙˆØ§ÙƒØ±</option>
        </select>
        <input type="text" id="personalField" readonly>
        <input type="text" id="idField" placeholder="Ø¶Ø¹ Ø§Ù„Ø§ÙŠØ¯ÙŠ" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainer"></div>
        <div id="priceDisplay"></div>
        <button id="submitForm" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
        <div class="price-note" id="paymentNote">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© (ÙŠÙØ®ØµÙ… Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø¥Ù† ÙƒØ§ÙÙ‰).</div>
        <div id="orderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtn" class="small-btn hidden">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
        <div class="back-btn" id="gamesBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- apps page -->
    <div id="appsPage" class="hidden">
      <div class="form-box">
        <h3>Ø§Ø®ØªØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
        <select id="appSelect">
          <option value="">-- Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚ --</option>
          <option value="ØªØ·Ø¨ÙŠÙ‚ 1">ØªØ·Ø¨ÙŠÙ‚ 1</option>
          <option value="ØªØ·Ø¨ÙŠÙ‚ 2">ØªØ·Ø¨ÙŠÙ‚ 2</option>
          <option value="ØªØ·Ø¨ÙŠÙ‚ 3">ØªØ·Ø¨ÙŠÙ‚ 3</option>
        </select>
        <input type="text" id="appPersonalField" readonly>
        <input type="text" id="appIdField" placeholder="Ø¶Ø¹ Ø§Ù„Ø§ÙŠØ¯ÙŠ" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainerApps"></div>
        <div id="priceDisplayApps"></div>
        <button id="appSubmitForm" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
        <div class="price-note" id="appPaymentNote">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©/Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© (ÙŠÙØ®ØµÙ… Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø¥Ù† ÙƒØ§ÙÙ‰).</div>
        <div id="appOrderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtnApp" class="small-btn hidden">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
        <div class="back-btn" id="appsBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- offers page -->
    <div id="offersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§</h3>
        <div id="offersList"></div>
        <div class="back-btn" id="offersBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- payment details page -->
    <div id="paymentDetailsPage" class="hidden">
      <div class="form-box">
        <div class="back-btn" id="pdBackBtn">â¬… Ø±Ø¬ÙˆØ¹</div>
        <h3 id="pdTitle" style="text-align:center;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h3>
        <div id="pdContent">
          <div id="pdTopInfo" style="text-align:center;margin-bottom:10px;color:#FFCB01;font-weight:bold;"></div>
          <select id="pdCashSelect">
            <option value="">-- Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ --</option>
            <option value="sham">Ø´Ø§Ù… ÙƒØ§Ø´</option>
            <option value="syrtel">Ø³ÙŠØ±ØªÙŠÙ„ ÙƒØ§Ø´</option>
            <option value="mtn">MTN ÙƒØ§Ø´</option>
            <option value="hawala">Ø­ÙˆØ§Ù„Ø© Ù…Ø§Ù„ÙŠØ©</option>
          </select>
          <div style="position:relative; margin-bottom:10px;">
            <input type="text" id="pdCopyField" readonly style="width:100%;padding-right:80px;">
            <button type="button" id="pdCopyBtn" style="position:absolute;left:0;top:0;height:100%;width:70px;cursor:pointer;">Ù†Ø³Ø®</button>
          </div>
          <div style="text-align:center;margin-bottom:10px;">
            <button type="button" id="pdToggleQrBtn">Ø§Ø¸Ù‡Ø±/Ø§Ø®ÙÙ QR</button>
          </div>
          <div id="qrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="qrImg" src="https://i.postimg.cc/vHYg2nK5/IMG.jpg" alt="QR Ø´Ø§Ù…" style="width:300px;height:auto;">
          </div>
          <div id="syrtelQrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="syrtelQrImg" src="https://i.postimg.cc/tT6ScwYv/IMG.jpg" alt="QR Ø³ÙŠØ±ØªÙŠÙ„" style="width:300px;height:auto;">
          </div>

          <div id="shamFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>ØªØ­ÙˆÙŠÙ„ Ø´Ø§Ù… ÙƒØ§Ø´ Ø¥Ù„Ù‰:</strong>
              <div style="margin-top:6px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„Ù…Ø­ÙØ¸Ø©: <span id="shamAddressDisplay">e5eca798a4add8f1b86d389330131c82</span></div>
            </div>
          </div>

          <div id="syrtelFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>ØªØ­ÙˆÙŠÙ„ Ø³ÙŠØ±ØªÙŠÙ„ ÙƒØ§Ø´ Ø¥Ù„Ù‰:</strong>
              <div style="margin-top:6px;">Ø§Ù„Ø±Ù‚Ù…: <span id="syrtelAddressDisplay">72289118</span></div>
            </div>
          </div>

          <div id="hawalaFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ:</strong>
              <div style="margin-top:8px;">Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ø­Ù…Ø¯ Ø¹ØªÙˆÙ†</div>
              <div class="muted-small" style="margin-top:8px;color:#ccc;">
                Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØªÙ… Ø¹Ø¨Ø± Ù…ÙƒØ§ØªØ¨ Ø§Ù„ØµØ±Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø³ÙˆØ±ÙŠØ§ Ù…Ø«Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„ÙØ¤Ø§Ø¯ØŒ Ø¯ÙˆÙÙŠØ²ØŒ Ø§Ù„Ø®...
              </div>
            </div>
          </div>

          <input type="file" id="paymentFileUpload" accept="image/*">
          <div class="upload-status" id="paymentUploadStatus"></div>
          <input type="text" id="paymentFileLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§" readonly>
          <div id="pdPriceInfo" style="color:#0f0;font-weight:bold;margin-top:10px;text-align:center"></div>
          <div class="price-note" id="pdNote" style="white-space:pre-line">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</div>
          <button id="pdSubmitForm">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
      </div>
    </div>

    <!-- orders page -->
    <div id="ordersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <div id="ordersList" class="orders-list"></div>
        <div class="back-btn" id="ordersBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- review page -->
    <div id="reviewPage" class="hidden">
      <div class="form-box" style="text-align:center;">
        <h3>ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ</h3>
        <p id="reviewMsg">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡</p>
        <div class="back-btn" id="reviewBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

  </main>

<script>
/* ---------- Frontend logic ---------- */

/* API root dynamic â€” ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ© */
const API_ROOT = (window.API_ROOT && window.API_ROOT.length>0) ? window.API_ROOT : (location.origin + '/');

/* helpers */
function $(id){ return document.getElementById(id); }
function show(id){ const el=$(id); if(el) el.classList.remove('hidden'); }
function hide(id){ const el=$(id); if(el) el.classList.add('hidden'); }
function hideAllPages(){
  ['homePage','gamesPage','appsPage','ordersPage','paymentDetailsPage','reviewPage','helpPage','profilePage','loginPage','offersPage'].forEach(id => { const e=$(id); if(e) e.classList.add('hidden'); });
}

/* state */
let currentProfile = null;
let selectedGameOption = '';
let selectedAppOption = '';
let currentMap = null;
let currentMap_num = {};

/* price maps (Ù…Ø­ØªÙˆÙ‰ ÙƒÙ…Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ) */
const priceMapFF={"100 Ø¬ÙˆØ§Ù‡Ø±":"12500 Ù„.Ø³","200 Ø¬ÙˆØ§Ù‡Ø±":"25000 Ù„.Ø³","300 Ø¬ÙˆØ§Ù‡Ø±":"60000 Ù„.Ø³","530 Ø¬ÙˆØ§Ù‡Ø±":"60000 Ù„.Ø³","1080 Ø¬ÙˆØ§Ù‡Ø±":"120000 Ù„.Ø³","2200 Ø¬ÙˆØ§Ù‡Ø±":"240000 Ù„.Ø³","Ø¹Ø¶ÙˆÙŠØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©":"30000 Ù„.Ø³","Ø¹Ø¶ÙˆÙŠØ© Ø´Ù‡Ø±ÙŠØ©":"140000 Ù„.Ø³"};
const priceMapPUBG={"60 Ø´Ø¯Ø©":"6000 Ù„.Ø³","325 Ø´Ø¯Ø©":"25000 Ù„.Ø³","660 Ø´Ø¯Ø©":"48000 Ù„.Ø³","1800 Ø´Ø¯Ø©":"120000 Ù„.Ø³","3850 Ø´Ø¯Ø©":"240000 Ù„.Ø³","8100 Ø´Ø¯Ø©":"480000 Ù„.Ø³"};
const priceMappubg1={"ÙƒÙˆØ¯ 60 Ø´Ø¯Ù‡":"12500 Ù„.Ø³"};
const priceMapApps = {"ØªØ·Ø¨ÙŠÙ‚ 1":"5000 Ù„.Ø³","ØªØ·Ø¨ÙŠÙ‚ 2":"10000 Ù„.Ø³","ØªØ·Ø¨ÙŠÙ‚ 3":"15000 Ù„.Ø³"};
const priceMapFF_num = Object.fromEntries(Object.entries(priceMapFF).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMapPUBG_num = Object.fromEntries(Object.entries(priceMapPUBG).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMappubg1_num = Object.fromEntries(Object.entries(priceMappubg1).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMapApps_num = Object.fromEntries(Object.entries(priceMapApps).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));

/* ---------- Notifications & offers ---------- */
async function loadNotifications(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;
    const list = $('notifList');
    if(!list) return;
    list.innerHTML = '';
    const notifications = data.notifications || [];
    if(notifications.length === 0){
      list.innerHTML = '<div class="notif-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    } else {
      notifications.forEach(n=>{
        const el = document.createElement('div');
        el.style.padding='8px';
        el.style.border='1px solid rgba(255,203,1,0.06)';
        el.style.marginBottom='8px';
        el.innerHTML = `<div style="font-weight:700;">${n.text}</div><div style="font-size:12px;color:#aaa;margin-top:6px;">${new Date(n.createdAt||Date.now()).toLocaleString()}</div>`;
        list.appendChild(el);
      });
    }
  }catch(e){
    console.warn('loadNotifications error', e);
  }
}

async function fetchOffers(){
  if(!currentProfile || !currentProfile.personalNumber) return;
  try{
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      const offers = data.offers || [];
      const container = $('offersList');
      if(container){
        container.innerHTML = '';
        if(offers.length === 0) {
          container.innerHTML = '<p style="color:#aaa">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
        } else {
          offers.forEach(of=>{
            const el = document.createElement('div');
            el.style.border='1px solid rgba(255,203,1,0.06)';
            el.style.padding='8px';
            el.style.marginBottom='8px';
            el.innerHTML = `<div>${of.text}</div><div style="margin-top:8px;"><button class="small-btn" onclick="ackOffer('${of.id}')">ØªØ­Ù‚Ù‚</button></div>`;
            container.appendChild(el);
          });
        }
      }
    }
  }catch(e){
    console.error('fetchOffers error', e);
  }
}

async function refreshNotificationsCount(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;

    const serverCanEdit = !!(data.canEdit || (data.profile && data.profile.canEdit));
    if(serverCanEdit !== !!currentProfile.canEdit){
      currentProfile.canEdit = serverCanEdit;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      applyProfileEditState();
    }

    if(data.profile && typeof data.profile.balance !== 'undefined'){
      const serverBal = Number(data.profile.balance || 0);
      if(serverBal !== Number(currentProfile.balance || 0)){
        currentProfile.balance = serverBal;
        localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
        refreshUIFromProfile();
      }
    }

    const offers = data.offers || [];
    const orders = data.orders || [];
    const charges = data.charges || [];
    const notifications = data.notifications || [];
    const unreadCount = (orders.filter(o=>o.replied).length) + (charges.filter(c=>c.replied).length) + (offers.length>0 ? 1 : 0) + (notifications.filter(n=>!n.read).length);
    if(unreadCount>0){ $('notifBadge').classList.remove('hidden'); $('notifBadge').textContent = String(unreadCount); } else { $('notifBadge').classList.add('hidden'); }
  }catch(err){
    console.warn('refreshNotificationsCount error', err);
  }
}

async function markNotificationsReadForCurrentUser(){
  if(!currentProfile || !currentProfile.personalNumber) return;
  try{
    const resp = await fetch(API_ROOT + 'api/notifications/mark-read', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      $('notifBadge').classList.add('hidden');
      return true;
    }
  }catch(e){ /* ignore */ }
  try{
    const r2 = await fetch(API_ROOT + 'api/notifications/mark-read/' + currentProfile.personalNumber, { method:'POST' });
    const d2 = await r2.json().catch(()=>null);
    if(d2 && d2.ok){
      $('notifBadge').classList.add('hidden');
      return true;
    }
  }catch(e){ /* ignore */ }
  return false;
}

/* ---------- DOM bindings ---------- */
document.addEventListener('DOMContentLoaded', ()=> {
  // menu
  if($('menuBtn')) $('menuBtn').addEventListener('click', ()=> { $('sidebar').classList.toggle('active'); });
  if($('sidebarCloseBtn')) $('sidebarCloseBtn').addEventListener('click', ()=> { $('sidebar').classList.remove('active'); });
  if($('sidebarProfileArea')) $('sidebarProfileArea').addEventListener('click', ()=> { openProfile(); $('sidebar').classList.remove('active'); });

  // sidebar links
  if($('linkHome')) $('linkHome').addEventListener('click', e=>{ e.preventDefault(); showHome(); $('sidebar').classList.remove('active'); });
  if($('linkOrders')) $('linkOrders').addEventListener('click', e=>{ e.preventDefault(); showOrders(); $('sidebar').classList.remove('active'); });
  if($('linkHelp')) $('linkHelp').addEventListener('click', e=>{ e.preventDefault(); showHelp(); $('sidebar').classList.remove('active'); });
  if($('linkOffers')) $('linkOffers').addEventListener('click', e=>{ e.preventDefault(); showOffers(); $('sidebar').classList.remove('active'); });
  if($('linkJoinWhats')) $('linkJoinWhats').addEventListener('click', e=>{ e.preventDefault(); window.open('https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J?mode=ems_copy_t','_blank'); });

  if($('btnCharge')) $('btnCharge').addEventListener('click', ()=>{ $('sidebar').classList.remove('active'); openChargePage(); });

  // notifications
  if($('notifBell')) $('notifBell').addEventListener('click', async ()=> {
    const hidden = $('notifPanel').classList.toggle('hidden');
    await loadNotifications();
    if(!hidden){
      await markNotificationsReadForCurrentUser();
      refreshNotificationsCount();
    }
  });
  if($('notifCloseBtn')) $('notifCloseBtn').addEventListener('click', ()=> $('notifPanel').classList.add('hidden'));
  if($('notifClearBtn')) $('notifClearBtn').addEventListener('click', async () => {
    try {
      const resp = await fetch(API_ROOT + 'api/notifications/clear', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ personal: currentProfile.personalNumber })
      });
      const data = await resp.json().catch(()=>null);
      if(data && data.ok){
        $('notifList').innerHTML='';
        $('notifBadge').classList.add('hidden');
      } else alert('ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
    } catch(e){ console.error(e); alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
  });

  // login controls: DO NOT duplicate listeners if already set
  if($('doLoginBtn')) $('doLoginBtn').addEventListener('click', doLogin);
  if($('btnSearch')) $('btnSearch').addEventListener('click', searchProfileFromUI);
  if($('btnCreate')) $('btnCreate').addEventListener('click', createAccountFromUI);

  if($('loginTogglePwd')){
    $('loginTogglePwd').addEventListener('click', ()=>{
      const pwd = $('loginPassword');
      if(!pwd) return;
      if(pwd.type === 'password'){ pwd.type='text'; $('loginTogglePwd').textContent='Ø¥Ø®ÙØ§Ø¡'; }
      else { pwd.type='password'; $('loginTogglePwd').textContent='Ø§Ø¸Ù‡Ø§Ø±'; }
    });
  }

  // help
  if($('helpSubmitBtn')) $('helpSubmitBtn').addEventListener('click', submitHelp);
  if($('helpFileUpload')) $('helpFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'helpFileLink','helpUploadStatus'); });

  // payment upload
  if($('paymentFileUpload')) $('paymentFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'paymentFileLink','paymentUploadStatus'); });

  // page navigation & games/apps bindings
  if($('cardGames')) $('cardGames').addEventListener('click', ()=> showGames());
  if($('cardApps')) $('cardApps').addEventListener('click', ()=> showApps());

  if($('gameSelect')) $('gameSelect').addEventListener('change', function(){ buildGameOptions(this.value); updateSubmitButtonGames(); });
  if($('idField')) $('idField').addEventListener('input', updateSubmitButtonGames);
  if($('submitForm')) $('submitForm').addEventListener('click', ()=> placeOrderFromUI('gamesPage'));
  if($('goOrdersBtn')) $('goOrdersBtn').addEventListener('click', ()=> showOrders());

  if($('appSelect')) $('appSelect').addEventListener('change', function(){ buildAppOptions(this.value); updateSubmitButtonApps(); });
  if($('appIdField')) $('appIdField').addEventListener('input', updateSubmitButtonApps);
  if($('appSubmitForm')) $('appSubmitForm').addEventListener('click', ()=> placeOrderFromUI('appsPage'));
  if($('goOrdersBtnApp')) $('goOrdersBtnApp').addEventListener('click', ()=> showOrders());

  // back buttons
  if($('gamesBackBtn')) $('gamesBackBtn').addEventListener('click', ()=> showHome());
  if($('appsBackBtn')) $('appsBackBtn').addEventListener('click', ()=> showHome());
  if($('profileBackBtn')) $('profileBackBtn').addEventListener('click', ()=> showHome());
  if($('helpBackBtn')) $('helpBackBtn').addEventListener('click', ()=> showHome());
  if($('pdBackBtn')) $('pdBackBtn').addEventListener('click', ()=> returnFromPaymentDetails());
  if($('ordersBackBtn')) $('ordersBackBtn').addEventListener('click', ()=> showHome());
  if($('reviewBackBtn')) $('reviewBackBtn').addEventListener('click', ()=> showHome());
  if($('offersBackBtn')) $('offersBackBtn').addEventListener('click', ()=> showHome());

  // payment details bindings
  if($('pdCashSelect')) $('pdCashSelect').addEventListener('change', onPdCashChange);
  if($('pdToggleQrBtn')) $('pdToggleQrBtn').addEventListener('click', toggleQr);
  if($('pdCopyBtn')) $('pdCopyBtn').addEventListener('click', ()=>{
    const v = $('pdCopyField') ? $('pdCopyField').value : '';
    if(!v){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù†Ø³Ø®Ù‡'); return; }
    navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(v).then(()=> alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®')) : (function(){ try{ const ta = document.createElement('textarea'); ta.value=v; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®'); }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®'); } })();
  });
  if($('pdSubmitForm')) $('pdSubmitForm').addEventListener('click', submitPaymentDetails);
async function submitPaymentDetails(e) {
  e.preventDefault();
  
  const phone = document.getElementById("chargePhone").value.trim();
  const amount = parseFloat(document.getElementById("chargeAmount").value);
  const method = document.getElementById("chargeMethod").value;

  try {
    const resp = await fetch(API_ROOT + "api/charges", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, amount, method })
    });

    const data = await resp.json();
    alert("âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: " + JSON.stringify(data));
  } catch (err) {
    console.error(err);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†");
  }
}

  // load saved profile (if Ù…ÙˆØ¬ÙˆØ¯)
  const saved = localStorage.getItem('user_profile_v1');
  if(saved){
    try{ currentProfile = JSON.parse(saved); }catch(e){ currentProfile = null; }
  }
  if(!currentProfile){
    let pn = localStorage.getItem('personalNumber');
    if(!pn){ pn = String(Math.floor(1000000 + Math.random()*9000000)); localStorage.setItem('personalNumber', pn); }
    currentProfile = { personalNumber: pn, name:'Ø¶ÙŠÙ', email:'', phone:'', balance:0, canEdit:false };
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  }
  refreshUIFromProfile();

  // show login or home
  const isGuest = (!currentProfile || !currentProfile.name || currentProfile.name === 'Ø¶ÙŠÙ');
  const hasCreds = !!(currentProfile && currentProfile.password);
  if (isGuest || !hasCreds) { hideAllPages(); if($('loginPage')) show('loginPage'); window.scrollTo({ top: 0 }); }
  else { showHome(); }

  // poll periodically
  setInterval(()=>{
    try{ refreshNotificationsCount(); }catch(e){ console.warn('refreshNotificationsCount interval error', e); }
    try{ fetchOffers(); }catch(e){ console.warn('fetchOffers interval error', e); }
  }, 6000);

  // initial fetches
  refreshNotificationsCount();
  fetchOffers();
});

/* ---------- UI & helper functions (ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ) ---------- */

function showHome(){ hideAllPages(); show('homePage'); window.scrollTo({top:0}); }
function showGames(){ hideAllPages(); show('gamesPage'); window.scrollTo({top:0}); }
function showApps(){ hideAllPages(); show('appsPage'); window.scrollTo({top:0}); }
function showHelp(){ hideAllPages(); show('helpPage'); window.scrollTo({top:0}); }
function openProfile(){ hideAllPages(); show('profilePage'); fillProfileFields(); }
function openChargePage(){ hideAllPages(); show('paymentDetailsPage'); $('pdTitle').textContent='Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯'; $('pdTopInfo').textContent='Ø§Ø·Ù„Ø¨ Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ø¨Ø± Ø±ÙØ¹ Ø§ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„'; }
function showOrders(){ hideAllPages(); show('ordersPage'); loadOrdersList(); }
function showOffers(){ hideAllPages(); show('offersPage'); fetchOffers(); }

function refreshUIFromProfile(){
  try{
    $('personalNum').textContent = currentProfile.personalNumber || '';
    if($('personalField')) $('personalField').value = currentProfile.personalNumber || '';
    if($('appPersonalField')) $('appPersonalField').value = currentProfile.personalNumber || '';
    if($('helpPersonalField')) $('helpPersonalField').value = currentProfile.personalNumber || '';
    if($('loginPersonalNumber')) $('loginPersonalNumber').value = currentProfile.personalNumber || '';
    $('sidebarName').textContent = currentProfile.name || 'Ø¶ÙŠÙ';
    $('sidebarAvatar').textContent = (currentProfile.name && currentProfile.name.trim().length>0) ? currentProfile.name.trim().charAt(0).toUpperCase() : 'Ø£';
    $('sidebarPersonal').textContent = 'Ø±Ù‚Ù…: ' + (currentProfile.personalNumber || '');

    // show balance
    const bal = Number(currentProfile.balance || 0);
    const bEl = $('balanceBox');
    if(bEl){
      bEl.textContent = `Ø±ØµÙŠØ¯Ùƒ: ${bal.toLocaleString('en-US')} Ù„.Ø³`;
      bEl.classList.remove('hidden');
      bEl.style.opacity = bal === 0 ? '0.85' : '1';
    }
  }catch(e){ console.warn('refreshUIFromProfile error', e); }
}
function fillProfileFields(){
  if($('profileName')) $('profileName').value = currentProfile.name || '';
  if($('profileEmail')) $('profileEmail').value = currentProfile.email || '';
  if($('profilePassword')) $('profilePassword').value = currentProfile.password || '';
  if($('profilePhone')) $('profilePhone').value = currentProfile.phone || '';
  applyProfileEditState();
}
function applyProfileEditState(){
  const canEdit = !!currentProfile.canEdit;
  ['profileName','profileEmail','profilePassword','profilePhone'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(canEdit){ el.removeAttribute('readonly'); } else { el.setAttribute('readonly','readonly'); }
  });
  if(canEdit){ if($('requestEditBtn')) $('requestEditBtn').classList.add('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.remove('hidden'); if($('profileMsg')) $('profileMsg').textContent='ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¢Ù† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.'; }
  else { if($('requestEditBtn')) $('requestEditBtn').classList.remove('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.add('hidden'); if($('profileMsg')) $('profileMsg').textContent='Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡.'; }
}

/* ---------- New: search-profile (Ù…ØµØ¯Ø±: merged from index2) ----------
   Ø²Ø± btnSearch ÙŠØ³ØªØ¯Ø¹ÙŠ /api/search-profile Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ.
*/
async function searchProfileFromUI(){
  const email = $('loginEmail').value.trim();
  const phone = $('loginPhone').value.trim();
  const errEl = $('loginError'); if(errEl){ errEl.style.display='none'; errEl.textContent=''; }
  if(!email && !phone){
    if(errEl){ errEl.style.display='block'; errEl.textContent='Ø§Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ù‡Ø§ØªÙ Ù„Ù„Ø¨Ø­Ø«'; }
    return;
  }
  try{
    const resp = await fetch(API_ROOT + 'api/search-profile', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ email: email || null, phone: phone || null })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok && data.profile){
      currentProfile = data.profile;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      alert('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ. Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ: ' + currentProfile.personalNumber + '\nØ±ØµÙŠØ¯Ùƒ: ' + (currentProfile.balance||0));
      hideAllPages(); showHome();
    } else {
      if(errEl){ errEl.style.display='block'; errEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨. Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨.'; }
    }
  }catch(e){
    console.error('searchProfileFromUI error', e);
    if(errEl){ errEl.style.display='block'; errEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'; }
  }
}

/* ---------- New: createAccountFromUI ----------
   Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙŠØ³ØªØ¯Ø¹ÙŠ /api/register (server Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¥Ù† ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§).
*/
async function createAccountFromUI(){
  const name = $('loginName').value.trim();
  const email = $('loginEmail').value.trim();
  const phone = $('loginPhone').value.trim();
  const password = $('loginPassword').value || '';
  const errEl = $('loginError'); if(errEl){ errEl.style.display='none'; errEl.textContent=''; }
  if(!name){ if(errEl){ errEl.style.display='block'; errEl.textContent='Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'; } return; }
  if(!email && !phone){ if(errEl){ errEl.style.display='block'; errEl.textContent='Ø§Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ù‡Ø§ØªÙ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'; } return; }
  try{
    const resp = await fetch(API_ROOT + 'api/register', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ name, email: email||null, phone: phone||null, password })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok && data.profile){
      currentProfile = data.profile;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯. Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ: ' + currentProfile.personalNumber + '\nØ±ØµÙŠØ¯Ùƒ: ' + (currentProfile.balance||0));
      hideAllPages(); showHome();
    } else {
      if(errEl){ errEl.style.display='block'; errEl.textContent = 'ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ' + (data && data.error ? data.error : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); }
    }
  }catch(e){
    console.error('createAccountFromUI error', e);
    if(errEl){ errEl.style.display='block'; errEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'; }
  }
}

/* ---------- doLogin (Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…) ----------
   Ø§Ø­ØªÙØ¸Øª Ø¨Ù…Ù†Ø·Ù‚ doLogin ÙƒÙ…Ø§ ÙƒØ§Ù†: ÙŠØ³ØªØ¯Ø¹ÙŠ api/register (ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø£Ù†Ù‡ Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯).
*/
async function doLogin(){
  const name = $('loginName').value.trim();
  const email = $('loginEmail').value.trim();
  const password = $('loginPassword').value;
  const phone = $('loginPhone').value.trim();
  const personal = $('loginPersonalNumber').value || currentProfile.personalNumber;
  const errEl = $('loginError');
  if(errEl) errEl.style.display='none';
  if(!name){ if(errEl){ errEl.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'; errEl.style.display='block'; } return; }
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ if(errEl){ errEl.textContent='ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; errEl.style.display='block'; } return; }
  if(!password){ if(errEl){ errEl.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±'; errEl.style.display='block'; } return; }

  try{
    const resp = await fetch(API_ROOT + 'api/register', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ name, email, password, phone, personalNumber: personal })
    });
    const data = await resp.json().catch(()=>null);
    if (data && data.ok) {
      currentProfile = data.profile ? Object.assign({}, currentProfile, data.profile) : { name, email, phone, password, personalNumber: personal, balance: (data.profile && data.profile.balance) || currentProfile.balance || 0 };
      if (!currentProfile.personalNumber) currentProfile.personalNumber = personal;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      localStorage.setItem('is_logged_in', '1');
      refreshUIFromProfile();
      showHome();
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } else {
      alert('ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + (data && data.error ? data.error : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }
  }catch(e){
    console.error('doLogin error', e);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
  }
}

/* ---------- profile edit / help / upload / orders / charges ----------
   Ø£Ø¨Ù‚ÙŠØª Ù…Ù†Ø·Ù‚Ùƒ ÙƒÙ…Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ â€” Ù„Ù… Ø£ØºÙŠØ±Ù‡ Ø¥Ù„Ø§ Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ currentProfile Ø§Ù„Ù…Ø­Ø¯Ø«.
*/

async function requestProfileEdit(){
  const ok = confirm('Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');
  if(!ok) return;
  try{
    const resp = await fetch(API_ROOT + 'api/profile/request-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if (data && data.ok) {
      alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„. Ø§Ù†ØªØ¸Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.');
      if($('requestEditBtn')) $('requestEditBtn').textContent='ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
      setTimeout(() => { if($('requestEditBtn')) $('requestEditBtn').textContent='Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ'; }, 10000);
    } else {
      alert('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
    }
  }catch(e){ console.error('requestProfileEdit error', e); alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
}

async function confirmProfileSave(){
  const name = $('profileName').value.trim();
  const email = $('profileEmail').value.trim();
  const password = $('profilePassword').value;
  const phone = $('profilePhone').value.trim();

  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    alert('Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­');
    return;
  }

  try {
    const resp = await fetch(API_ROOT + 'api/profile/submit-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({
        personal: currentProfile.personalNumber,
        name, email, password, phone
      })
    });
    const data = await resp.json().catch(()=>null);

    if(data && data.ok){
      if(data.profile){
        currentProfile = Object.assign({}, currentProfile, data.profile);
      } else {
        currentProfile.name = name || currentProfile.name;
        currentProfile.email = email || currentProfile.email;
        currentProfile.password = password || currentProfile.password;
        currentProfile.phone = phone || currentProfile.phone;
      }
      currentProfile.canEdit = false;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));

      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
      applyProfileEditState();
      refreshUIFromProfile();
    } else {
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¢Ù†: ' + (data && data.error ? data.error : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }
  } catch(err){
    console.error(err);
    alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
  }
}

async function submitHelp(){
  const issue = $('helpIssueSelect').value;
  const fileLink = $('helpFileLink').value;
  const desc = $('helpDesc').value.trim();
  const personal = currentProfile.personalNumber;
  if(!issue){ alert('Ø§Ø®ØªØ± Ù…Ø´ÙƒÙ„ØªÙƒ'); return; }
  try{
    const resp = await fetch(API_ROOT + 'api/help', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal, issue, fileLink, desc, name: currentProfile.name, email: currentProfile.email, phone: currentProfile.phone })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){ alert('ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©'); hide('helpPage'); showHome(); } else { alert('ÙØ´Ù„ Ø§Ù„Ø§Ø±Ø³Ø§Ù„'); }
  }catch(e){ console.error('submitHelp error', e); alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
}

/* upload to imgbb (client) â€” ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙÙƒ */
async function uploadFileToImgbb(file, targetInputId = 'paymentFileLink', statusElId='paymentUploadStatus'){
  if(!file) return;
  const statusEl = $(statusElId);
  if(statusEl) statusEl.textContent = 'Ø¬Ø§Ø±ÙŠØ© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹... 0%';
  try{
    const IMGBB_KEY = "e5603dfd5675ed2b5a671577abcf6d33"; // Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¶Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const fd = new FormData();
    fd.append('image', file);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`);
    xhr.onload = function(){
      if(xhr.status>=200 && xhr.status<300){
        try{
          const resp = JSON.parse(xhr.responseText||'{}');
          const url = resp && resp.data && (resp.data.url || resp.data.display_url);
          if(url){
            $(targetInputId).value = url;
            if(statusEl) statusEl.textContent = 'ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­';
            alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
          } else {
            if(statusEl) statusEl.textContent = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹';
            alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
          }
        }catch(e){ if(statusEl) statusEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹'; alert('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù'); }
      } else {
        if(statusEl) statusEl.textContent = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹';
        alert('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + xhr.status);
      }
    };
    xhr.onerror = function(){ if(statusEl) statusEl.textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©'; alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹'); };
    xhr.upload.onprogress = function(ev){ if(ev.lengthComputable){ const pct = Math.round((ev.loaded/ev.total)*100); if(statusEl) statusEl.textContent = `Ø¬Ø§Ø±ÙŠØ© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹... ${pct}%`; } };
    xhr.send(fd);
  }catch(e){ console.error(e); if($(statusElId)) $(statusElId).textContent = 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹'; alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹'); }
}

/* games/apps options & ordering (ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙÙƒ) */
function buildGameOptions(val){
  if($('optionsContainer')) $('optionsContainer').innerHTML='';
  selectedGameOption=''; if($('priceDisplay')) $('priceDisplay').textContent='';
  if(val==='ÙØ±ÙŠ ÙØ§ÙŠØ± Ø§ÙŠØ¯ÙŠ'){ currentMap = priceMapFF; currentMap_num = priceMapFF_num; }
  else if(val==='Ø¨Ø¨Ø¬ÙŠ Ø§ÙŠØ¯ÙŠ'){ currentMap = priceMapPUBG; currentMap_num = priceMapPUBG_num; }
  else if(val==='Ø¬ÙˆØ§ÙƒØ±'){ currentMap = priceMappubg1; currentMap_num = priceMappubg1_num; }
  else { currentMap = null; currentMap_num = {}; }
  if(currentMap && $('optionsContainer')){
    Object.keys(currentMap).forEach(opt=>{
      const d = document.createElement('div'); d.className='button-option'; d.textContent = opt;
      d.addEventListener('click', ()=> {
        document.querySelectorAll('#optionsContainer .button-option').forEach(x=>x.classList.remove('selected'));
        d.classList.add('selected');
        selectedGameOption = opt;
        if($('priceDisplay')) { $('priceDisplay').textContent = `Ø§Ù„Ø­Ø²Ù…Ø©: ${opt}\nØ§Ù„Ø³Ø¹Ø±: ${currentMap[opt]}`; $('priceDisplay').style.color='#0f0'; }
        updateSubmitButtonGames();
      });
      $('optionsContainer').appendChild(d);
    });
  }
}

function buildAppOptions(val){
  if($('optionsContainerApps')) $('optionsContainerApps').innerHTML='';
  selectedAppOption=''; if($('priceDisplayApps')) $('priceDisplayApps').textContent='';
  if(priceMapApps[val] && $('optionsContainerApps')){
    const d = document.createElement('div'); d.className='button-option'; d.textContent = val;
    d.addEventListener('click', ()=> {
      document.querySelectorAll('#optionsContainerApps .button-option').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      selectedAppOption = val;
      if($('priceDisplayApps')) { $('priceDisplayApps').textContent = `Ø§Ù„Ø³Ø¹Ø±: ${priceMapApps[val]}`; $('priceDisplayApps').style.color='#0f0'; }
      updateSubmitButtonApps();
    });
    $('optionsContainerApps').appendChild(d);
  }
}
function updateSubmitButtonGames(){ const idf=$('idField') ? $('idField').value.trim() : ''; if($('submitForm')) $('submitForm').disabled = !(selectedGameOption && idf); }
function updateSubmitButtonApps(){ const idf=$('appIdField') ? $('appIdField').value.trim() : ''; if($('appSubmitForm')) $('appSubmitForm').disabled = !(selectedAppOption && idf); }

async function placeOrderFromUI(fromPage){
  try{
    if(fromPage === 'gamesPage'){
      const personal = $('personalField').value;
      const game = $('gameSelect').value;
      const idField = $('idField').value.trim();
      const opt = selectedGameOption;
      if(!game || !idField || !opt){ alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
      let price = 0;
      if(currentMap_num && currentMap_num[opt]) price = Number(currentMap_num[opt]);
      else {
        const raw = $('priceDisplay') ? $('priceDisplay').textContent : '';
        price = parseInt((raw.replace(/\D/g,''))||0,10);
      }
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'Ø´Ø­Ù† Ù„Ø¹Ø¨Ø©', item: `${game} - ${opt}`, idField, paidAmount: price });
    } else if(fromPage === 'appsPage'){
      const personal = $('appPersonalField').value;
      const app = $('appSelect').value;
      const idField = $('appIdField').value.trim();
      const opt = selectedAppOption;
      if(!app || !idField || !opt){ alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
      let price = priceMapApps_num[opt] || 0;
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'Ø´Ø±Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚', item: `${app} - ${opt}`, idField, paidAmount: price });
    } else {
      alert('Ù…ØµØ¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ù„Ù„Ø·Ù„Ø¨');
    }
  }catch(e){
    console.error('placeOrderFromUI', e);
    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
  }
}

async function attemptChargeAndSendOrder(orderBody){
  const bal = Number(currentProfile.balance || 0);
  const price = Number(orderBody.paidAmount || 0);
  if(isNaN(price) || price <= 0){
    alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø³Ø¹Ø± Ø§Ù„Ø­Ø²Ù…Ø©');
    return;
  }
  if(bal < price){
    alert('Ù…Ø§ÙÙŠ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ');
    return;
  }

  // deduct locally (optimistic)
  currentProfile.balance = bal - price;
  localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  refreshUIFromProfile();

  const body = {
    personal: orderBody.personal,
    phone: orderBody.phone,
    type: orderBody.type,
    item: orderBody.item,
    idField: orderBody.idField,
    fileLink: orderBody.fileLink || '',
    cashMethod: orderBody.cashMethod || '',
    paidWithBalance: true,
    paidAmount: price
  };

  try{
    const r = await fetch(API_ROOT + 'api/orders', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
    const data = await r.json().catch(()=>null);
    if(data && data.ok){
      hideAllPages(); show('reviewPage'); if($('reviewMsg')) $('reviewMsg').textContent = 'ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ (Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ).';
      localStorage.setItem('lastOrderId', data.order && data.order.id ? data.order.id : '');
      try{
        const el = document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid rgba(255,203,1,0.06)'; el.style.marginBottom='8px';
        el.innerHTML = `<div><strong>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ÙˆØ¯ÙÙØ¹ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ</strong></div><div>${body.item} - Ø§Ù„Ù…Ø¨Ù„Øº: ${price.toLocaleString('en-US')} Ù„.Ø³</div>`;
        const list = $('notifList'); if(list) list.prepend(el);
      }catch(e){}
    } else {
      currentProfile.balance = bal;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      alert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…: ' + (data && data.error ? data.error : 'Ø®Ø·Ø£'));
    }
  }catch(err){
    console.error(err);
    currentProfile.balance = bal;
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
    refreshUIFromProfile();
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
  }
}

/* payment details helpers (Ù…Ø®ØªØµØ±) */
let previousBeforePayment = null;
function showPaymentDetailsFromSubmit(fromPage){
  previousBeforePayment = fromPage;
  hideAllPages(); show('paymentDetailsPage');
}
function returnFromPaymentDetails(){ if(previousBeforePayment==='gamesPage') showGames(); else if(previousBeforePayment==='appsPage') showApps(); else showHome(); }
function onPdCashChange(){ const value = $('pdCashSelect').value; if(value==='sham'){ if($('shamFields')) $('shamFields').style.display='block'; if($('syrtelFields')) $('syrtelFields').style.display='none'; if($('hawalaFields')) $('hawalaFields').style.display='none'; } else if(value==='syrtel'){ if($('syrtelFields')) $('syrtelFields').style.display='block'; if($('shamFields')) $('shamFields').style.display='none'; if($('hawalaFields')) $('hawalaFields').style.display='none'; } else if(value==='hawala'){ if($('hawalaFields')) $('hawalaFields').style.display='block'; if($('shamFields')) $('shamFields').style.display='none'; if($('syrtelFields')) $('syrtelFields').style.display='none'; } else { if($('shamFields')) $('shamFields').style.display='none'; if($('syrtelFields')) $('syrtelFields').style.display='none'; if($('hawalaFields')) $('hawalaFields').style.display='none'; } }
function toggleQr(){ const q = $('qrContainer'); if(!q) return; q.style.display = q.style.display === 'none' ? 'block' : 'none'; }

/* load orders list / notifications (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) */
async function loadOrdersList(){
  try{
    const personal = currentProfile.personalNumber;
    const resp = await fetch(API_ROOT + 'api/notifications/' + personal);
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      const orders = data.orders || [];
      const charges = data.charges || [];
      const container = $('ordersList'); if(container) container.innerHTML = '';
      if(orders.length===0 && charges.length===0){ if(container) container.innerHTML = '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>'; return; }
      orders.forEach(o=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${o.id}</strong> - ${o.type} - ${o.item || ''} <br> Ø§Ù„Ø§ÙŠØ¯ÙŠ: ${o.idField || ''} <br> Ø§Ù„Ù‡Ø§ØªÙ: ${o.phone || ''} <br> Ø§Ù„Ø­Ø§Ù„Ø©: <strong>${o.status}</strong> <br> Ø£Ù†Ø´Ø¦: ${new Date(o.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
      charges.forEach(c=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${c.id}</strong> - Ø´Ø­Ù† Ø±ØµÙŠØ¯ - Ø§Ù„Ù…Ø¨Ù„Øº: ${c.amount} <br> Ø§Ù„Ø­Ø§Ù„Ø©: <strong>${c.status}</strong> <br> Ø£Ù†Ø´Ø¦: ${new Date(c.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
    }
  }catch(e){ console.error('loadOrdersList error', e); }
}

</script>
</body>
  </html>
