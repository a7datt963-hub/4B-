<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>موقع شحن الألعاب — نسخة معدلة</title>
  <!-- ربط خط Almarai -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
  <style>
  /* تطبيق خط Almarai على كل الصفحة */
body {
  font-family: 'Almarai', sans-serif !important;
}
  :root { --main-color: #FFCB01; }

  /* (CSS الأصلي مع تعديلات لإخفاء الشريط العلوي وإضافة انبثاق سريع) */
  * { margin:0; padding:0; box-sizing:border-box }
  html,body { height:100% }
  body { font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff; overflow-x:hidden }

  /* header عادي */
  header { background:#111; padding:10px 20px; position:relative; text-align:center; transition:height .12s ease, padding .12s ease, background .12s ease }
  header img { height:90px; width:auto; display:block; margin:0 auto; transition:opacity .12s ease }
  #ordersStatusBar { margin:8px auto 0; max-width:720px; padding:4px 8px; border-radius:6px; text-align:center; min-height:22px; display:none; overflow:hidden; white-space:normal; pointer-events:none }
  .status-line { color:var(--main-color); padding:2px 4px; margin:2px 0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; font-weight:700; border-bottom:1px solid rgba(255,203,1,0.06); line-height:1.1 }
  .menu { position:absolute; right:20px; font-size:28px; cursor:pointer; color:var(--main-color); top:50%; transform:translateY(-50%) }
  #personalNumberDisplay { position:absolute; left:20px; top:30%; transform:translateY(-50%); color:#111; font-weight:bold; font-size:11px }
  #notifBell { position:absolute; right:68px; top:50%; transform:translateY(-50%); font-size:22px; cursor:pointer; color:var(--main-color) }
  #notifBell .badge {
  position: relative;
  top: -20px;
  left: 10px;
  background: #ff3b30;
  color: #fff;
  border-radius: 999px;
  padding: 2px 6px;
  font-size: 12px;
}

  #balanceBox {
    position:absolute;
    left:20px;
    top:58%;
    transform:translateY(0);
    background:none;
    color: var(--main-color);
    padding:3px 7px;
    border-radius:4px;
    font-weight:700;
    font-size:11px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    white-space:nowrap;
  }
  #balanceBox.hidden { display:none; }

  .notif-panel { position:fixed; top:70px; right:20px; width:360px; max-width:92%; background:#111; border:2px solid var(--main-color); border-radius:10px; padding:10px; z-index:1500; box-shadow:0 6px 30px rgba(0,0,0,0.6) }
  .notif-panel.hidden { display:none }
  .notif-empty { color:#aaa; padding:8px; text-align:center }

  .sidebar {
    position:fixed;
    top:0;
    right:-100%;
    width:80%;
    max-width:300px;
    height:100%;
    background:transparent;
    padding:20px;
    transition:0.28s;
    z-index:1000;
    overflow-y:auto;
    border-left:2px solid rgba(255,255,255,0.03);
  }
  .sidebar.active { right:0; background:rgba(17,17,17,0.98); }

  .sidebar .avatar { width:48px; height:48px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--main-color); border:2px solid var(--main-color); }

  .sidebar a {
    display:block;
    color:#fff !important;
    text-decoration:none;
    padding:10px 12px;
    margin:6px 0;
    font-size:16px;
    font-weight:700;
    text-align:right;
    border-radius:6px;
    transition: color 0.15s, background 0.15s;
    background: transparent;
  }
  .sidebar a:hover { color:var(--main-color); background:rgba(255,203,1,0.04); }

  .sidebar .small-btn {
    display:block;
    width:100%;
    text-align:center;
    background:transparent;
    color:#fff;
    border:2px solid rgba(255,255,255,0.05);
    padding:10px;
    border-radius:8px;
    margin-top:12px;
    cursor:pointer;
  }
  .sidebar .small-btn:hover { border-color:rgba(255,203,1,0.35); color:var(--main-color); }

  .container { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; padding:20px }
  .card { background:#111; border:2px solid var(--main-color); border-radius:12px; padding:20px; text-align:center; cursor:pointer; transition:.25s; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center }
  .card:hover { background:var(--main-color); color:#000 }
  .hidden { display:none }
  .form-box { background:#000000; border:2px solid var(--main-color); border-radius:0px; padding:20px; margin:1px }
  select,input,button,textarea { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:none; font-size:16px; background:#222; color:#fff }
  .button-option { background:#222; color:var(--main-color); border:2px solid var(--main-color); margin:5px 0; padding:10px; border-radius:8px; cursor:pointer; width:100%; text-align:center; font-weight:bold }
  .button-option.selected { background:var(--main-color); color:#000 }
  button { background:var(--main-color); color:#000; font-weight:bold; cursor:pointer; border-radius:8px; padding:10px }
  .small-btn { display:inline-block; padding:8px 12px; border-radius:8px; background:var(--main-color); color:#000; cursor:pointer; margin-top:8px; text-align:center }
  .back-btn { display:block; margin:20px auto; background:var(--main-color); color:#000; padding:10px; border-radius:8px; text-align:center; font-weight:bold; cursor:pointer }
  .price-note { color:var(--main-color); font-weight:bold; margin:10px 0; font-size:14px; white-space:pre-line }
  .order-item { padding:12px; border:2px solid var(--main-color); border-radius:8px; margin-bottom:10px; background:#111 }
  .login-page { max-width:600px; margin:18px auto; padding:16px }
  .muted-small { font-size:13px; color:#aaa; margin-top:6px }
  .upload-status { font-size:13px; color:#aaa; margin-top:6px }

  @media (min-width: 900px) {
    .sidebar { right:0; position:static; width:260px; max-width:none; background:transparent; border-left:none; padding:20px 10px 20px 20px; }
    .sidebar.active { right:0; background:transparent; }
    main { margin-right:260px; }
  }

  @media (max-width: 899px) {
    .menu { display:block }
    header img { height:72px }
    #personalNumberDisplay { top:60%; left:10px; }
    #balanceBox { top:30%; left:10px; }
  }

  /* fast popup animation */
  @keyframes quickPop {
    0% { opacity:0; transform: translateY(10px) scale(0.995); }
    100% { opacity:1; transform: translateY(0) scale(1); }
  }
  .quick-popup { animation: quickPop .10s ease-out both; transform-origin: top center; }

  /* compact header class - يخفي التفاصيل العلوية بسرعة ويجعل المحتوى يصعد للأعلى */
  header.compact { height:8px !important; padding:2px 8px !important; background:#111 !important; }
  header.compact img, header.compact #personalNumberDisplay, header.compact #balanceBox, header.compact #notifBell, header.compact .menu, header.compact #ordersStatusBar { display:none !important; opacity:0 !important; }

  /* when header compact, remove extra top space from main */
  header + main { transition: margin-top .12s ease }
  /* make pages occupy top when header compact */
  main.compact-main { margin-top: 4px; padding-top:8px; }

  /* existing gradient for charge button */
  #btnCharge {
    background: linear-gradient(270deg, var(--main-color), #FF9F00, var(--main-color)) !important;
    background-size: 600% 600%;
    animation: moveGradient 6s ease infinite;
    color: #000 !important;
    border: none !important;
    padding: 12px !important;
    width: 100% !important;
    font-weight: 800 !important;
    border-radius: 10px !important;
    cursor: pointer;
  }

  @keyframes moveGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* bottom navigation styles */
  #bottomNav{
    position:fixed; left:0; right:0; bottom:0; z-index:1200;
    display:flex; justify-content:space-around; align-items:center;
    padding:10px 8px; padding-bottom:calc(10px + env(safe-area-inset-bottom));
    background:rgba(17,17,17,0.98); border-top:1px solid rgba(255,255,255,0.03);
  }
  .nav-btn{ display:flex; gap:8px; align-items:center; justify-content:center; flex-direction:column; background:transparent; border:none; color:#fff; font-weight:800; cursor:pointer; padding:4px 6px; border-radius:10px; min-width:56px }
  .nav-btn .icon{ width:26px; height:26px; display:block; }
  .nav-btn:active, .nav-btn:focus{ outline:none; transform:translateY(-2px); }
  .nav-label{ font-size:12px; color:var(--main-color) }

  @media(min-width:900px){ .nav-label{ display:block } }

  .profile-summary .row{ display:flex; gap:12px; align-items:center }
  .profile-summary .avatar { width:64px; height:64px; font-size:28px }
  .profile-summary .name{ color:var(--main-color); font-weight:800; font-size:18px; cursor:pointer }
  .profile-summary .personal{ color:#ccc; font-weight:700; cursor:pointer }
  .profile-actions{ margin-top:12px; display:flex; gap:10px; flex-direction:column; align-items:stretch; } /* تم تعديل: جعل الأزرار عمودية */
.profile-actions .small-link {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  color: #fff !important;
  font-weight: bold;
  display: flex;
  flex-direction: row-reverse;  /* الأيقونة على أقصى اليمين */
  align-items: center;
  justify-content: flex-end;    /* جميع العناصر على اليمين */
  gap: 25px;                     /* المسافة بين الأيقونة والنص */
  padding: 10px 15px 10px 0;     /* اضفت 15px على اليمين */
}

  /* تعطيل المربع الأزرق / الظل لجميع العناصر */
  * { outline: none !important; -webkit-tap-highlight-color: transparent; }
  button, a, input, textarea, select { outline: none !important; box-shadow: none !important; -webkit-tap-highlight-color: transparent; }

  .nav-btn { color: #fff; -webkit-tap-highlight-color: transparent; }
  .nav-btn.active { color:var(--main-color) }

  /* البروفايل بالنص مع خلفية #111 */
.profile-summary {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 4px;                 /* مسافة صغيرة بين العناصر */
  background: #111;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  color: #fff;
}

/* الصورة مع إطار ذهبي */
.profile-summary .avatar {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  border: 3px solid var(--main-color);   /* الدائرة ذات لون الثيم */
  background: #333;         /* خلفية داخلية */
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  color: #fff;
}

/* الاسم */
.profile-summary .name {
  font-size: 18px;
  font-weight: bold;
  color: var(--main-color);
  margin: 0;
}

/* الرقم رمادي فاتح */
.profile-summary .personal {
  font-size: 14px;
  color: #ccc;
  margin: 0;
}

/* بناتك grid tiles */
.benatak-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:12px; }
.benatak-tile { padding:14px; border:2px solid var(--main-color); border-radius:10px; text-align:center; background:#111; }
.benatak-tile .title { color:var(--main-color); font-weight:800; }
.benatak-tile .value { font-size:20px; margin-top:8px; color:#0f0; font-weight:800; }
/* خلي الإطار موجود */
#settingsPage .form-box {
  background: transparent !important;
  border: 2px solid var(--main-color) !important; /* الإطار يبقى */
  border-radius: 8px;
  padding: 20px;
}

#settingsPage .small-link,
#settingsPage .back-btn {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  color: #fff !important;
  font-weight: bold;
  display: flex;
  flex-direction: row-reverse;  /* الأيقونة على أقصى اليمين */
  align-items: center;
  justify-content: flex-end;    /* جميع العناصر على اليمين */
  gap: 25px;                     /* المسافة بين الأيقونة والنص */
  padding: 10px 0;
}
/* تطبيق Almarai على كل العناصر حتى لو كانت محددة مسبقًا */
body, 
body * {
  font-family: 'Almarai', sans-serif !important;
}

/* FIX: ensure sections take full width and show 3 per row */
#homePage > .container {
  display: block !important; /* منع السلوك الشبكي الخارجي الذي يضغط .sections-grid */
  padding: 12px !important;
  box-sizing: border-box;
}

/* force the sections grid to 3 columns on desktop, responsive down to 2/1 */
#homePage .sections-grid {
  display: grid !important;
  grid-template-columns: repeat(3, 1fr) !important; /* 3 أعمدة في السطر */
  gap: 12px !important;
  width: 100% !important;
  margin: 0 auto;
  box-sizing: border-box;
}

/* responsive */
@media (max-width: 1100px) {
  #homePage .sections-grid { grid-template-columns: repeat(2, 1fr) !important; }
}
@media (max-width: 720px) {
  #homePage .sections-grid { grid-template-columns: repeat(1, 1fr) !important; }
}
#homePage .section-tile {
  background: #0f0f0f;
  border: none;
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  gap: 8px;
  align-items: center;
  overflow: hidden;
  transition: transform .12s ease, box-shadow .12s ease;
}
#homePage .section-tile:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.5); }

#homePage .section-tile img.placeholder {
  width: 72%;
  height: 72px;
  object-fit: cover;
  border-radius: 8px;
  display: block;
  margin: 0 auto;
}

#homePage .section-tile .section-name {
  margin-top: 8px;
  font-weight: 800;
  color: #fff;
  font-size: 14px;
  text-align: center;
  line-height: 1.1;
}

/* subgrid inside section */
#sectionPage .subgrid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 12px;
}
#sectionPage .subcard {
  background: #111;
  border: 2px solid rgba(255,203,1,0.06);
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  min-height: 140px;
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:center;
  overflow:hidden;
}
#sectionPage .subcard img { width:66%; height:76px; object-fit:cover; border-radius:8px; display:block; }

/* game store grid */
#gameStoreGrid { display:grid; gap:12px; grid-template-columns: repeat(4,1fr); align-items:start; margin-top:12px; }
#gameStoreGrid .item-card { background:#0f0f0f; border:2px solid rgba(255,203,1,0.06); border-radius:10px; padding:10px; text-align:center; cursor:pointer; min-height:150px; display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:flex-start; overflow:hidden; }
#gameStoreGrid .item-card img { width:72px; height:72px; object-fit:cover; border-radius:8px; }

/* simple order small box */
.simple-order-box { max-width:520px; margin:8px auto; padding:12px; background:#0b0b0b; border-radius:10px; border:2px solid rgba(255,203,1,0.06); }

/* responsiveness */
@media(max-width:1100px){
  #homePage .sections-grid { grid-template-columns: repeat(2,1fr) !important; }
  #sectionPage .subgrid { grid-template-columns: repeat(3,1fr); }
  #gameStoreGrid { grid-template-columns: repeat(3,1fr); }
}
@media(max-width:720px){
  #homePage .sections-grid { grid-template-columns: repeat(1,1fr) !important; }
  #sectionPage .subgrid { grid-template-columns: repeat(2,1fr); }
  #gameStoreGrid { grid-template-columns: repeat(2,1fr); }
}

/* prevent global style collisions (extra specificity) */
body #homePage .sections-grid, body #sectionPage .subgrid, body #gameStoreGrid { -webkit-font-smoothing:antialiased; }
/* ======= Sections layout: Always 4 per row ======= */
#homePage .sections-grid {
  display: grid !important;
  grid-template-columns: repeat(4, 1fr) !important; /* 4 مربعات بالسطر */
  gap: 8px !important;
  padding: 10px;
  width: 100%;
  direction: rtl; /* من اليمين لليسار */
  box-sizing: border-box;
}

#homePage .section-tile {
  background: #0f0f0f;
  border:none;
  border-radius: 10px;
  padding: 6px;
  text-align: center;
  cursor: pointer;
  height: 90px; /* أصغر للحجم على الهاتف */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  transition: transform .12s ease, box-shadow .12s ease;
}

#homePage .section-tile:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.4);
}

#homePage .section-tile img.placeholder {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 6px;
}

#homePage .section-tile .section-name {
  margin-top: 4px;
  font-weight: 700;
  font-size: 12px;
  color: #fff;
  text-align: center;
}

.section-tile {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  border: none;          /* ألغينا أي إطار إضافي */
  background: transparent; /* لو فيه خلفية، نخليها شفافة */
}

/* المربع الأصفر للصورة */
.section-tile .image-box {
  width: 100%;
  height: 200px;
  border: 2px solid  var(--main-color);
  border-radius: 10px;
  overflow: hidden;
}

/* الصورة تملأ المربع */
.section-tile .image-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* الاسم تحت المربع */
.section-tile .section-name {
  margin-top: 8px;
  font-size: 16px;
  font-weight: bold;
  text-align: center;
  color: #333;
}
#homePage .section-tile {
  background: none !important;  /* ما في خلفية */
  border: none;                 /* الإطار الأساسي نشيله */
  box-shadow: none;             /* نتأكد ما في ظل */
}

main {
  padding-bottom: 85px; /* مسافة تكفي لزر الرجوع/الإرسال */
}

.form-box {
  margin-bottom: 30px; /* مسافة إضافية قبل نهاية الصندوق */
}
#balanceBox::before {
  content: "رصيدك:";
  display: block;
  font-size: 12px;
  font-weight: 500;
  color: var(--main-color);
  margin-bottom: 2px;
}
  </style>
</head>
<body>
  <header id="topHeader">
    <img src="https://i.postimg.cc/W1Ysr3QG/image.png" alt="Logo" id="siteLogo">
    <div id="personalNumberDisplay">رقمك الشخصي: <span id="personalNum">0000000</span></div>
    <div id="balanceBox" class="hidden"> 0 ل.س</div>
    <!-- استبدال جزء الإشعارات في الهيدر -->
    <div id="notifBell" title="الإشعارات">
<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-bell-fill" viewBox="0 0 16 16">
  <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2m.995-14.901a1 1 0 1 0-1.99 0A5 5 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901"/>
</svg>
  <span id="notifBadge" class="badge hidden">0</span></div>

    <div class="menu" id="menuBtn">☰</div>
    <div id="ordersStatusBar" aria-live="polite" role="status" style="display:none"></div>
  </header>

  <!-- notif panel -->
  <div id="notifPanel" class="notif-panel hidden" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h4 style="color: var(--main-color);margin:0">الإشعارات</h4>
      <div style="cursor:pointer;color: var(--main-color);" id="notifCloseBtn">×</div>
    </div>
    <div id="notifList"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <div class="small-btn" id="notifClearBtn">مسح الكل</div>
    </div>
  </div>

  <!-- sidebar -->
  <div id="sidebar" class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="display:flex;gap:10px;align-items:center;cursor:pointer" id="sidebarProfileArea">
        <div class="avatar" id="sidebarAvatar">أ</div>
        <div>
          <div id="sidebarName" style="color: var(--main-color);font-weight:700">ضيف</div>
          <div id="sidebarPersonal" style="color:#ccc;font-size:13px">--</div>
        </div>
      </div>
      <div style="cursor:pointer;color: var(--main-color);" id="sidebarCloseBtn">×</div>
    </div>

    <a href="#" id="linkHome">الرئيسية</a>
    <a href="#" id="linkOrders">الطلبات</a>
    <a href="#" id="linkHelp">المساعدة في حل مشكلة</a>
    <a href="#" id="linkOffers">العروض والهدايا</a>
    <a href="#" id="linkJoinWhats">الانضمام لمجتمع واتساب</a>
    <div style="margin-top:16px;">
      <div class="small-btn" id="btnCharge">شحن الرصيد</div>
    </div>
  </div>

  <!-- pages -->
  <main id="mainContent">

<!-- profile summary page -->
<div id="profileSummaryPage" class="hidden">
  <!-- بلوك البروفايل -->
  <div class="profile-summary">
    <div class="avatar" id="summaryAvatar">أ</div>
    <div class="name" id="summaryName" title="عرض وتعديل الملف">ضيف</div>
    <div class="personal" id="summaryPersonal" title="عرض وتعديل الملف">رقمك الشخصي: --</div>
  </div>

  <!-- الأزرار خارج البلوك (الآن رأسياً)-->
  <div class="profile-actions">
    <button class="small-link" id="summarySettingsBtn">الإعدادات ️
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
  <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
</svg>
    </button> 
    <button class="small-link" id="summaryHelpBtn">المساعدة في حل مشكلة
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope-exclamation-fill" viewBox="0 0 16 16">
  <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414zM0 4.697v7.104l5.803-3.558zM6.761 8.83l-6.57 4.026A2 2 0 0 0 2 14h6.256A4.5 4.5 0 0 1 8 12.5a4.49 4.49 0 0 1 1.606-3.446l-.367-.225L8 9.586zM16 4.697v4.974A4.5 4.5 0 0 0 12.5 8a4.5 4.5 0 0 0-1.965.45l-.338-.207z"/>
  <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1.5a.5.5 0 0 1-1 0V11a.5.5 0 0 1 1 0m0 3a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
</svg>
    </button>
    <button class="small-link" id="summaryJoinBtn">انضمام الى مجتمع واتساب
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">
  <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
</svg>
    </button>
    <button class="small-link" id="summaryBenatakBtn"> بياناتك الشخصية
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
  <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z"/>
</svg>
    </button> <!-- زر بيناتك جديد -->
  </div>
</div>

    <!-- benatak page -->
    <div id="benatakPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color: var(--main-color);">البيانات</h3>
        <div class="benatak-grid" aria-live="polite">
          <div class="benatak-tile" id="tileTotalTopups">
            <div class="title">مجموع رصيدك (كل الشحنات)</div>
            <div class="value" id="totalTopupsValue">0 ل.س</div>
            <div class="muted-small" style="margin-top:8px;color:#aaa">هذا مجموع كل المبالغ التي شحنتها منذ إنشاء الحساب.</div>
          </div>

          <div class="benatak-tile" id="tileAccepted">
            <div class="title">طلباتك المقبولة</div>
            <div class="value" id="acceptedCount">0</div>
          </div>

          <div class="benatak-tile" id="tileRejected">
            <div class="title">طلباتك المرفوضة</div>
            <div class="value" id="rejectedCount">0</div>
          </div>

          <div class="benatak-tile" id="tilePending">
            <div class="title">قيد المراجعة</div>
            <div class="value" id="pendingCount">0</div>
          </div>

          <div class="benatak-tile" id="tileProfileEdits">
            <div class="title">عدد طلبات تعديل معلومات البروفايل</div>
            <div class="value" id="profileEditRequestsCount">0</div>
          </div>
        </div>

        <div class="back-btn" id="benatakBackBtn">⬅ </div>
      </div>
    </div>

    <!-- login page -->
    <div id="loginPage" class="form-box login-page hidden">
      <h3 style="text-align:center;color: var(--main-color);">تسجيل الدخول / التسجيل</h3>
      <label>ضع الأسم</label>
      <input type="text" id="loginName" placeholder="أدخل اسمك">
      <label>البريد الإلكتروني</label>
      <input type="email" id="loginEmail" placeholder="example@domain.com">
      <label>كلمة السر</label>
      <div style="position:relative;">
        <input type="password" id="loginPassword" placeholder="كلمة السر">
        <button id="loginTogglePwd" style="position:absolute;left:6px;top:10px;height:36px;width:80px;cursor:pointer;">اظهار</button>
      </div>
      <label>رقم هاتف</label>
      <input type="text" id="loginPhone" placeholder="مثال: 0999xxxxxx">
      <label>ضع الرقم الشخصي (غير قابل للتعديل)</label>
      <input type="text" id="loginPersonalNumber" readonly>
      <div class="small-muted" style="margin-top:6px;">
        ملاحظة: لن يتم ارسال اي كود على البريد الإلكتروني او رقم الهاتف.
        فقط قم بتعبئة بياناتك الاصلية ففي حال حدوث مشكلة نستطيع التواصل معك.
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button id="doLoginBtn">تسجيل الدخول</button>
      </div>
      <div id="loginError" class="error" style="display:none;"></div>
    </div>

    <!-- profile page -->
    <div id="profilePage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color: var(--main-color);">الملف الشخصي</h3>
        <label>الاسم</label>
        <input type="text" id="profileName" readonly>
        <label>البريد الإلكتروني</label>
        <input type="email" id="profileEmail" readonly>
        <label>كلمة السر</label>
        <input type="password" id="profilePassword" readonly>
        <label>رقم الهاتف</label>
        <input type="text" id="profilePhone" readonly>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button id="requestEditBtn">طلب تعديل معلوماتك</button>
          <button id="confirmSaveBtn" class="hidden">حفظ التعديلات</button>
        </div>
      </div>
    </div>

    <!-- settings page -->
    <div id="settingsPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:var(--main-color);">الإعدادات</h3>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <button class="small-link" id="settingsEditProfileBtn">تعديل 
        المعلومات الشخصية              
        
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
</svg>
</button>
          <button class="small-link" id="settingsThemeBtn">اختيار الثيم
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-palette-fill" viewBox="0 0 16 16">
  <path d="M12.433 10.07C14.133 10.585 16 11.15 16 8a8 8 0 1 0-8 8c1.996 0 1.826-1.504 1.649-3.08-.124-1.101-.252-2.237.351-2.92.465-.527 1.42-.237 2.433.07M8 5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m4.5 3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3M5 6.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/>
</svg>
          </button>
          <button class="small-link" id="4bee3na">الدعم والمساعدة 
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-left-text-fill" viewBox="0 0 16 16">
  <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4.414a1 1 0 0 0-.707.293L.854 15.146A.5.5 0 0 1 0 14.793zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z"/>
</svg>
          </button>
          <button class="small-link" id="settingsPrivacyBtn">سياسة الخصوصية
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-square-fill" viewBox="0 0 16 16">
  <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm8.93 4.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
</svg>
          </button>
          <button class="small-link" id="settingsLogoutBtn">تسجيل خروج
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0z"/>
  <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708z"/>
</svg>
          </button>
        </div>
        <div class="back-btn" id="settingsBackBtn">⬅ رجوع</div>
      </div>
    </div>
    <!-- theme selection page -->
    <div id="themePage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:var(--main-color);">اختيار لون الثيم</h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;">
          <!-- الألوان المطلوبة -->
          <div class="theme-swatch" data-color="#AF10FF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#AF10FF"></div>
          <div class="theme-swatch" data-color="#01FEFF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#01FEFF"></div>
          <div class="theme-swatch" data-color="#FF0701" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FF0701"></div>
          <div class="theme-swatch" data-color="#FF03CF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FF03CF"></div>
          <div class="theme-swatch" data-color="#0E19FF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#0E19FF"></div>
          <div class="theme-swatch" data-color="#08FF03" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#08FF03"></div>
          <div class="theme-swatch" data-color="#FFCB01" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FFCB01"></div>
            <div class="theme-swatch" data-color="#FFFFFF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FFFFFF"></div>
            <div class="theme-swatch" data-color="#FF760B" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FF760B"></div>
            <div class="theme-swatch" data-color="#83C218" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#83C218"></div>
            <div class="theme-swatch" data-color="#934900" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#934900"></div>
            <div class="theme-swatch" data-color="#FFFD01" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FFFD01"></div>
            <div class="theme-swatch" data-color="#9B9B9B" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#9B9B9B"></div>
        </div>
        <div style="margin-top:12px;" class="muted-small">اضغط على اللون لتطبيقه. سيتم حفظه محليًا على جهازك.</div>
        <div class="back-btn" id="themeBackBtn">⬅ </div>
      </div>
    </div>

    <!-- privacy policy page -->
    <div id="privacyPage" class="hidden">
      <div class="form-box">
        <h3 class="privacy-title">سياسة الخصوصية والشروط</h3>
        <div class="privacy-box">
•مسؤوليات المستخدم:
-دقة بيانات الحساب: أنت مسؤول بالكامل عن دقة بيانات حسابك وحماية بيانات تسجيل الدخول الخاصة بك
-المسؤولية عن سوء الاستخدام: نحن نخلي مسؤوليتنا عن أي أخطاء تنتج عن سوء استخدامك
-عمليات الحساب : أنت مسؤول عن جميع العمليات والتحويلات التي تتم في حسابك وعن جميع الأخطاء التي قد تنتج نتيجة سوء استخدامه او الخطأ الناجم عن استعمال ارقام وروابط مغلوطة
-الاستخدام غير المناسب: استخدامك غير المناسب أو غير الأخلاقي للبرنامج، أو محاولتك للتحايل عليه، يجعلك مسؤولاً بالكامل ويعرضك للمساءلة حتى ان كانت قانونية

الاستخدام غير القانوني : لا يحق لك استخدام البرنامج لأغراض غير قانونية أو بما يخالف الأنظمة والقوانين المعمول بها.

تعليق الحساب والإجراءات القانونية

. حق التعليق: نحتفظ بالحق في تعليق حسابك في حالة انتهاكك لهذا الاتفاق أو بناءً على أمر قضائي دون الحاجة إلى إشعارك مسبقاً.

التزامنا

. هدف الخدمة: نسعى لتوفير منصة آمنة وموثوقة تمكن المستخدمين من شحن السلع الإلكترونية بسهولة وراحة باحترافية وشفافية.

قبول الشروط

. الاستخدام يعني الموافقة: استخدامك للبرنامج يعني قبولك لهذه الشروط والأحكام. إذا كنت لا توافق على أي جزء من هذه الاتفاقية، يجب عليك التوقف عن الاستخدام فوراً.

ختاماً

شكراً لثقتكم بنا، ونتطلع إلى تقديم خدمات الكترونية استثنائية لكم.
        </div>
        <div style="text-align:center;margin-top:12px;">
          <div class="back-btn" id="privacyBackBtn">⬅ </div>
        </div>
      </div>
    </div>

<!-- START: homePage replacement -->
<div id="homePage" class="">
  <div class="container">
    <div class="sections-grid">

      <!-- ROW 1 -->
<div class="section-tile" data-section="games" title="قسم الألعاب">
  <div class="image-box">
    <img class="placehold" src="https://i.postimg.cc/HnT7jJpS/image.jpg" data-img="PLACE_IMG_GAMES" alt="قسم الألعاب">
  </div>
  <div class="section-name">قسم الألعاب</div>
</div>

      <div class="section-tile" data-section="apps" title="قسم التطبيقات">
        <img class="placeholder" src="" data-img="PLACE_IMG_APPS" alt="قسم التطبيقات">
        <div class="section-name">قسم التطبيقات</div>
      </div>

      <div class="section-tile" data-section="rashq" title="قسم الرشق">
        <img class="placeholder" src="" data-img="PLACE_IMG_RASHQ" alt="قسم الرشق">
        <div class="section-name">قسم الرشق</div>
      </div>

      <div class="section-tile" data-section="cards" title="قسم البطاقات">
        <img class="placeholder" src="" data-img="PLACE_IMG_CARDS" alt="قسم البطاقات">
        <div class="section-name">قسم البطاقات</div>
      </div>

      <!-- ROW 2 -->
      <div class="section-tile" data-section="numbers" title="قسم الأرقام">
        <img class="placeholder" src="" data-img="PLACE_IMG_NUMBERS" alt="قسم الأرقام">
        <div class="section-name">قسم الأرقام</div>
      </div>

      <div class="section-tile" data-section="accounts_ready" title="حسابات جاهزة">
        <img class="placeholder" src="" data-img="PLACE_IMG_ACCOUNTS" alt="حسابات جاهزة">
        <div class="section-name">حسابات جاهزة</div>
      </div>

      <div class="section-tile" data-section="design_apps" title="برامج تصميم">
        <img class="placeholder" src="" data-img="PLACE_IMG_DESIGN" alt="برامج تصميم">
        <div class="section-name">برامج تصميم</div>
      </div>

      <div class="section-tile" data-section="verify_accounts" title="توثيق حسابات">
        <img class="placeholder" src="" data-img="PLACE_IMG_VERIFY" alt="توثيق حسابات">
        <div class="section-name">توثيق حسابات</div>
      </div>

      <!-- ROW 3 -->
      <div class="section-tile" data-section="balance" title="قسم الرصيد">
        <img class="placeholder" src="" data-img="PLACE_IMG_BALANCE" alt="قسم الرصيد">
        <div class="section-name">قسم الرصيد</div>
      </div>

      <div class="section-tile" data-section="subscriptions" title="اشتراكات تطبيقات">
        <img class="placeholder" src="" data-img="PLACE_IMG_SUBS" alt="اشتراكات تطبيقات">
        <div class="section-name">اشتراكات تطبيقات</div>
      </div>

      <div class="section-tile" data-section="proxies" title="بروكسيات">
        <img class="placeholder" src="" data-img="PLACE_IMG_PROXIES" alt="بروكسيات">
        <div class="section-name">بروكسيات</div>
      </div>

      <div class="section-tile" data-section="software" title="قسم السوفتوير">
        <img class="placeholder" src="" data-img="PLACE_IMG_SOFT" alt="قسم السوفتوير">
        <div class="section-name">قسم السوفتوير</div>
      </div>

    </div>
  </div>
</div>
<!-- END homePage replacement -->

<!-- sectionPage (show subcategories inside section) -->
<div id="sectionPage" class="hidden">
  <div class="form-box">
    <h3 id="sectionPageTitle" style="text-align:center;color:var(--main-color)">القسم</h3>
    <div id="sectionSubgrid" class="subgrid"></div>
    <div class="back-btn" id="sectionBackBtn">⬅ </div>
  </div>
</div>

    <!-- help page -->
    <div id="helpPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;">المساعدة في حل مشكلة</h3>
        <label>الرقم الشخصي (غير قابل للتعديل)</label>
        <input type="text" id="helpPersonalField" readonly>
        <label>-اختر مشكلتك-</label>
        <select id="helpIssueSelect">
          <option value="" disabled selected>-- اختر مشكلتلك --</option>
          <option value="لا استطيع تعبئة البيانات">لا استطع تعبئة البيانات</option>
          <option value="قمت بتحويل الرصيد ولم يُراجع طلبي">قمت بتحويل الرصيد ولم يُراجع طلبي</option>
          <option value="تم قبول طلبي لكن لم يصلني شيء">تم قبول طلبي لكن لم يصلني شيء</option>
          <option value="لا استطيع ارسال لقطة شاشة">لا استطيع ارسال لقطة شاشة</option>
        </select>
        <label>ارفاق ملف (اختياري)</label>
        <input type="file" id="helpFileUpload" accept="image/*">
        <div class="upload-status" id="helpUploadStatus"></div>
        <input type="text" id="helpFileLink" placeholder="رابط الملف سيظهر هنا (اختياري)" readonly>
        <label>وصف المشكلة</label>
        <textarea id="helpDesc" rows="5" maxlength="100" placeholder="اكتب مشكلتك وضع رقم عملية الطلب #***********"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="helpSubmitBtn">إرسال</button>
        </div>
      </div>
    </div>

    <!-- games page -->
    <div id="gamesPage" class="hidden">
      <div class="form-box">
        <h3>اختر لعبتك</h3>
        <select id="gameSelect">
          <option value="">-- اختر لعبة --</option>
          <option value="أكواد فري فاير">أكواد فري فاير</option>
          <option value="فري فاير ايدي">فري فاير ايدي</option>
          <option value="ببجي ايدي">ببجي ايدي</option>
          <option value="أكواد ببجي">أكواد ببجي</option>
          <option value="جواكر">جواكر</option>
        </select>
        <input type="text" id="personalField" readonly>
        <input type="text" id="idField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainer"></div>
        <div id="priceDisplay"></div>
        <button id="submitForm" disabled>إرسال</button>
        <div class="price-note" id="paymentNote">اختر الحزمة ثم اضغط إرسال لإرسال الطلب مباشرة (يُخصم من رصيدك إن كافى).</div>
        <div id="orderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtn" class="small-btn hidden">عرض الطلبات</button>
        </div>
      </div>
    </div>

    <!-- apps page -->
    <div id="appsPage" class="hidden">
      <div class="form-box">
        <h3>اختر التطبيق</h3>
        <select id="appSelect">
          <option value="">-- اختر تطبيق --</option>
          <option value="تطبيق 1">تطبيق 1</option>
          <option value="تطبيق 2">تطبيق 2</option>
          <option value="تطبيق 3">تطبيق 3</option>
        </select>
        <input type="text" id="appPersonalField" readonly>
        <input type="text" id="appIdField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainerApps"></div>
        <div id="priceDisplayApps"></div>
        <button id="appSubmitForm" disabled>إرسال</button>
        <div class="price-note" id="appPaymentNote">اختر الباقة/التطبيق ثم اضغط إرسال لإرسال الطلب مباشرة (يُخصم من رصيدك إن كافى).</div>
        <div id="appOrderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtnApp" class="small-btn hidden">عرض الطلبات</button>
        </div>
      </div>
    </div>

    <!-- offers page -->
    <div id="offersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">العروض والهدايا</h3>
        <div id="offersList"></div>
      </div>
    </div>

    <!-- payment details page -->
    <div id="paymentDetailsPage" class="hidden">
      <div class="form-box">
        <h3 id="pdTitle" style="text-align:center;">تفاصيل الدفع</h3>
        <div id="pdContent">
          <div id="pdTopInfo" style="text-align:center;margin-bottom:10px;color: var(--main-color);font-weight:bold;"></div>
          <select id="pdCashSelect">
            <option value="">-- اختر طريقة الدفع --</option>
            <option value="sham">شام كاش</option>
            <option value="syrtel">سيرتيل كاش</option>
            <option value="mtn">MTN كاش</option>
            <option value="hawala">حوالة مالية</option>
          </select>
          <div style="position:relative; margin-bottom:10px;">
            <input type="text" id="pdCopyField" readonly style="width:100%;padding-right:80px;">
            <button type="button" id="pdCopyBtn" style="position:absolute;left:0;top:0;height:100%;width:70px;cursor:pointer;">نسخ</button>
          </div>
          <div style="text-align:center;margin-bottom:10px;">
            <button type="button" id="pdToggleQrBtn">اظهر/اخفِ QR</button>
          </div>
          <div id="qrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="qrImg" src="https://i.postimg.cc/vHYg2nK5/IMG.jpg" alt="QR شام" style="width:300px;height:auto;">
          </div>
          <div id="syrtelQrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="syrtelQrImg" src="https://i.postimg.cc/tT6ScwYv/IMG.jpg" alt="QR سيرتيل" style="width:300px;height:auto;">
          </div>

          <div id="shamFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>تحويل شام كاش إلى:</strong>
              <div style="margin-top:6px;">العنوان/المحفظة: <span id="shamAddressDisplay">e5eca798a4add8f1b86d389330131c82</span></div>
            </div>
          </div>

          <div id="syrtelFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>تحويل سيرتيل كاش إلى:</strong>
              <div style="margin-top:6px;">الرقم: <span id="syrtelAddressDisplay">72289118</span></div>
            </div>
          </div>

          <div id="hawalaFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>قم بتحويل الرصيد المطلوب إلى الاسم التالي:</strong>
              <div style="margin-top:8px;">عبد الرحمن احمد عتون</div>
              <div class="muted-small" style="margin-top:8px;color:#ccc;">
                التحويل يتم عبر مكاتب الصرافة الموجودة في سوريا مثل: الهرم، الفؤاد، دوفيز، الخ...
              </div>
            </div>
          </div>

          <input type="file" id="paymentFileUpload" accept="image/*">
          <div class="upload-status" id="paymentUploadStatus"></div>
          <input type="text" id="paymentFileLink" placeholder="رابط الملف سيظهر هنا" readonly>
          <div id="pdPriceInfo" style="color:#0f0;font-weight:bold;margin-top:10px;text-align:center"></div>
          <div class="price-note" id="pdNote" style="white-space:pre-line">اختر طريقة الدفع لمتابعة التعليمات</div>
          <button id="pdSubmitForm">إرسال الطلب</button>
        </div>
      </div>
    </div>

    <!-- orders page -->
    <div id="ordersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center">الطلبات</h3>
        <div id="ordersList" class="orders-list"></div>
      </div>
    </div>

    <!-- review page -->
    <div id="reviewPage" class="hidden">
      <div class="form-box" style="text-align:center;">
        <h3>تم ارسال طلبك</h3>
        <p id="reviewMsg">تم استلام طلبك وسيتم مراجعته</p>
        <div class="back-btn" id="reviewBackBtn">⬅ رجوع للصفحة الرئيسية</div>
      </div>
    </div>
    
<!-- gameStorePage -->
<div id="gameStorePage" class="hidden">
  <div class="form-box">
    <h3 id="gameStoreTitle" style="text-align:center;color:var(--main-color)">متجر اللعبة</h3>
    <div id="gameStoreGrid"></div>
    <div style="display:flex;gap:10px;margin-top:12px;justify-content:center;">
      <div id="gameStoreBack" class="small-btn" style="background:transparent;color:var(--main-color);border:2px solid rgba(255,203,1,0.08);">⬅ رجوع</div>
    </div>
  </div>
</div>

<!-- simpleOrderPage (صفحة الطلب السريع) -->
<div id="simpleOrderPage" class="hidden">
  <div class="form-box simple-order-box">
    <h3 style="text-align:center;color:var(--main-color)">صفحة الطلب:الشحن ليس تلقائي ستأخذ بعض الوقت</h3>
    <div style="display:flex;gap:12px;align-items:center;">
      <img id="simpleOrderImg" src="" alt="صورة" style="width:84px;height:84px;object-fit:cover;border-radius:8px;border:2px solid rgba(255,255,255,0.03)">
      <div style="flex:1;text-align:right;">
        <div id="simpleOrderItemName" style="font-weight:800;color:#fff;font-size:16px">اسم الحزمة</div>
        <div id="simpleOrderItemNote" style="color:#ccc;font-size:13px;margin-top:6px">ملاحظة</div>
      </div>
    </div>

    <label style="margin-top:10px">رقمك الشخصي (مقروء)</label>
    <input type="text" id="simplePersonal" readonly>

    <label>ضع الايدي</label>
    <input type="text" id="simpleIdField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <label>الكمية</label>
    <input type="number" id="simpleQty" value="1" min="1">

    <label>سعر الوحدة</label>
    <input type="text" id="simpleUnitPrice" readonly>

    <label>السعر الإجمالي</label>
    <input type="text" id="simpleTotalPrice" readonly>

    <div id="simpleOrderMsg" style="color:#ffcc00;font-weight:700;margin-top:8px;text-align:center"></div>

    <div style="display:flex;gap:10px;margin-top:12px;">
      <button id="simpleOrderSend">إرسال وخصم من الرصيد</button>
      <div id="simpleOrderCancel" class="small-btn" style="background:transparent;color:#fff;border:2px solid rgba(255,255,255,0.05)">إلغاء</div>
    </div>
  </div>
</div>

  </main>


  <nav id="bottomNav" aria-label="شريط التنقل السفلي">
    <button class="nav-btn" id="navHomeBtn" title="الرئيسية">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon size-6">
        <path d="M11.47 3.841a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.061l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 1 0 1.061 1.06l8.69-8.689Z" />
        <path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.432Z" />
      </svg>
      <span class="nav-label"></span>
    </button>

    <button class="nav-btn" id="navChargeBtn" title="شحن الرصيد">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z" />
      </svg>
      <span class="nav-label"></span>
    </button>

    <button class="nav-btn" id="navOrdersBtn" title="الطلبات">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon size-6">
        <path d="M2.25 2.25a.75.75 0 0 0 0 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.752 3.752 0 0 0-2.806 3.63c0 .414.336.75.75.75h15.75a.75.75 0 0 0 0-1.5H5.378A2.25 2.25 0 0 1 7.5 15h11.218a.75.75 0 0 0 .674-.421 60.358 60.358 0 0 0 2.96-7.228.75.75 0 0 0-.525-.965A60.864 60.864 0 0 0 5.68 4.509l-.232-.867A1.875 1.875 0 0 0 3.636 2.25H2.25ZM3.75 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM16.5 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z" />
      </svg>
      <span class="nav-label"></span>
    </button>

    <button class="nav-btn" id="navProfileBtn" title="الملف الشخصي">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon size-6">
        <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" />
      </svg>
      <span class="nav-label"></span>
    </button>
  </nav>

  <!-- ---------- SCRIPT (مُعدل ومتكامل) ---------- -->
  <script>
/* ---------- Frontend logic مع التعديلات المطلوبة لإخفاء العناصر العلوية وصعود الصفحات وانبثاق سريع ---------- */

// API root
const API_ROOT = 'https://fourb-tawy.onrender.com/';

// helpers
function $(id){ return document.getElementById(id); }
function show(id){ const el=$(id); if(el) el.classList.remove('hidden'); }
function hide(id){ const el=$(id); if(el) el.classList.add('hidden'); }
// updated list to include all known pages
function hideAllPages(){
  const pages = ['homePage','gamesPage','appsPage','ordersPage','paymentDetailsPage','reviewPage','helpPage','profilePage','loginPage','offersPage','profileSummaryPage','benatakPage','settingsPage','themePage','privacyPage','sectionPage','gameStorePage','simpleOrderPage'];
  pages.forEach(id => { const e=$(id); if(e) e.classList.add('hidden'); });
}


// pages that should hide top details and move up
const compactPages = new Set(['paymentDetailsPage','ordersPage','profilePage','helpPage','gamesPage','appsPage','offersPage','profileSummaryPage','loginPage','benatakPage','sectionPage','gameStorePage','simpleOrderPage']);

/* ------------- notification helpers ------------- */
async function loadNotifications(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;
    const list = $('notifList');
    if(!list) return;
    list.innerHTML = '';
    const notifications = data.notifications || [];
    if(notifications.length === 0){
      list.innerHTML = '<div class="notif-empty">لا توجد إشعارات حالياً</div>';
    } else {
      notifications.forEach(n=>{
        const el = document.createElement('div');
        el.style.padding='8px';
        el.style.border='1px solid rgba(255,203,1,0.06)';
        el.style.marginBottom='8px';
        el.innerHTML = `<div style="font-weight:700;">${n.text}</div><div style="font-size:12px;color:#aaa;margin-top:6px;">${new Date(n.createdAt||Date.now()).toLocaleString()}</div>`;
        list.appendChild(el);
      });
    }
  }catch(e){
    console.warn('loadNotifications error', e);
  }
}

/* ----------- small helpers for compact header & quick popup ----------- */
function setCompactHeader(on){
  const hdr = $('topHeader');
  const main = $('mainContent');
  if(!hdr || !main) return;
  if(on){ hdr.classList.add('compact'); main.classList.add('compact-main'); }
  else { hdr.classList.remove('compact'); main.classList.remove('compact-main'); }
}

function showPageQuick(id){
  hideAllPages();
  // compact header if page is in compact list
  setCompactHeader(compactPages.has(id));
  const el = $(id);
  if(!el) return;
  el.classList.remove('hidden');
  // force reflow then add quick-popup for very fast appearance
  void el.offsetWidth;
  el.classList.add('quick-popup');
  // remove quick-popup after short time so it can be reused
  setTimeout(()=>{ el.classList.remove('quick-popup'); }, 250);
  // scroll to top immediately
  window.scrollTo({ top: 0 });
}

/* ---------- DOM & bindings ---------- */
document.addEventListener('DOMContentLoaded', ()=> {
  // menu open/close
  if($('menuBtn')) $('menuBtn').addEventListener('click', ()=> { $('sidebar').classList.toggle('active'); });
  if($('sidebarCloseBtn')) $('sidebarCloseBtn').addEventListener('click', ()=> { $('sidebar').classList.remove('active'); });
  if($('sidebarProfileArea')) $('sidebarProfileArea').addEventListener('click', ()=> { showProfile(); $('sidebar').classList.remove('active'); });

  // sidebar links
  if($('linkHome')) $('linkHome').addEventListener('click', e=>{ e.preventDefault(); showHome(); $('sidebar').classList.remove('active'); });
  if($('linkOrders')) $('linkOrders').addEventListener('click', e=>{ e.preventDefault(); showOrders(); $('sidebar').classList.remove('active'); });
  if($('linkHelp')) $('linkHelp').addEventListener('click', e=>{ e.preventDefault(); showHelp(); $('sidebar').classList.remove('active'); });
  if($('linkOffers')) $('linkOffers').addEventListener('click', e=>{ e.preventDefault(); showOffers(); $('sidebar').classList.remove('active'); });
  if($('linkJoinWhats')) $('linkJoinWhats').addEventListener('click', e=>{ e.preventDefault(); window.open('https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J?mode=ems_copy_t','_blank'); });
  if($('btnCharge')) $('btnCharge').addEventListener('click', ()=>{ $('sidebar').classList.remove('active'); openChargePage(); });

  // notif bell
  if($('notifBell')) $('notifBell').addEventListener('click', async ()=> {
    const hidden = $('notifPanel').classList.toggle('hidden');
    await loadNotifications();
    if(!hidden){
      await markNotificationsReadForCurrentUser();
      refreshNotificationsCount();
    }
  });

  // close & clear listeners
  if($('notifCloseBtn')) $('notifCloseBtn').addEventListener('click', ()=> $('notifPanel').classList.add('hidden'));
  if($('notifClearBtn')) $('notifClearBtn').addEventListener('click', async () => {
    try {
      const resp = await fetch(API_ROOT + 'api/notifications/clear', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ personal: currentProfile.personalNumber })
      });
      const data = await resp.json().catch(()=>null);
      if(data && data.ok){
        $('notifList').innerHTML='';
        $('notifBadge').classList.add('hidden');
      } else alert('فشل مسح الإشعارات');
    } catch(e){ console.error(e); alert('خطأ في الاتصال'); }
  });

  // bind main UI elements (buttons etc.)
  if($('doLoginBtn')) $('doLoginBtn').addEventListener('click', doLogin);
  if($('requestEditBtn')) $('requestEditBtn').addEventListener('click', requestProfileEdit);
  if($('confirmSaveBtn')) $('confirmSaveBtn').addEventListener('click', confirmProfileSave);
  if($('helpSubmitBtn')) $('helpSubmitBtn').addEventListener('click', submitHelp);
  if($('helpFileUpload')) $('helpFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'helpFileLink','helpUploadStatus'); });

  if($('paymentFileUpload')) $('paymentFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'paymentFileLink','paymentUploadStatus'); });

  // login pwd toggle
  if($('loginTogglePwd')){
    $('loginTogglePwd').addEventListener('click', ()=>{
      const pwd = $('loginPassword');
      if(!pwd) return;
      if(pwd.type === 'password'){ pwd.type='text'; $('loginTogglePwd').textContent='إخفاء'; }
      else { pwd.type='password'; $('loginTogglePwd').textContent='اظهار'; }
    });
  }

  // games/apps selects and inputs
  if($('gameSelect')) $('gameSelect').addEventListener('change', function(){ buildGameOptions(this.value); updateSubmitButtonGames(); });
  if($('idField')) $('idField').addEventListener('input', updateSubmitButtonGames);
  if($('submitForm')) $('submitForm').addEventListener('click', ()=> placeOrderFromUI('gamesPage'));
  if($('goOrdersBtn')) $('goOrdersBtn').addEventListener('click', ()=> showOrders());

  if($('appSelect')) $('appSelect').addEventListener('change', function(){ buildAppOptions(this.value); updateSubmitButtonApps(); });
  if($('appIdField')) $('appIdField').addEventListener('input', updateSubmitButtonApps);
  if($('appSubmitForm')) $('appSubmitForm').addEventListener('click', ()=> placeOrderFromUI('appsPage'));
  if($('goOrdersBtnApp')) $('goOrdersBtnApp').addEventListener('click', ()=> showOrders());

  // back buttons
  if($('sectionBackBtn')) $('sectionBackBtn').addEventListener('click', ()=> showHome());
  if($('gameStoreBack')) $('gameStoreBack').addEventListener('click', ()=> {
    // back to section page
    if(window._lastOpenedSection) openSection(window._lastOpenedSection);
    else showHome();
  });
  if($('simpleOrderCancel')) $('simpleOrderCancel').addEventListener('click', ()=> {
    if(window._lastOpenedGame) openGameStore(window._lastOpenedGame.key, window._lastOpenedGame.title);
    else if(window._lastOpenedSection) openSection(window._lastOpenedSection);
    else showHome();
  });

  // payment details bindings
  if($('pdCashSelect')) $('pdCashSelect').addEventListener('change', onPdCashChange);
  if($('pdToggleQrBtn')) $('pdToggleQrBtn').addEventListener('click', toggleQr);
  if($('pdCopyBtn')) $('pdCopyBtn').addEventListener('click', ()=>{
    const v = $('pdCopyField') ? $('pdCopyField').value : '';
    if(!v){ alert('لا يوجد شيء لنسخه'); return; }
    navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(v).then(()=> alert('تم النسخ')) : (function(){ try{ const ta = document.createElement('textarea'); ta.value=v; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('تم النسخ'); }catch(e){ alert('فشل النسخ'); } })();
  });
  if($('pdSubmitForm')) $('pdSubmitForm').addEventListener('click', submitPaymentDetails);

  // profile summary bindings
  if($('summaryName')) $('summaryName').addEventListener('click', ()=> { showProfile(); });
  if($('summaryPersonal')) $('summaryPersonal').addEventListener('click', ()=> { showProfile(); });
  if($('summaryAvatar')) $('summaryAvatar').addEventListener('click', ()=> { showProfile(); });
  if($('summaryHelpBtn')) $('summaryHelpBtn').addEventListener('click', ()=> { showHelp(); });
  if($('summaryJoinBtn')) $('summaryJoinBtn').addEventListener('click', ()=> { window.open('https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J?mode=ems_copy_t','_blank'); });
  if($('summaryBenatakBtn')) $('summaryBenatakBtn').addEventListener('click', ()=> { showBenatak(); });
  if($('summarySettingsBtn')) $('summarySettingsBtn').addEventListener('click', ()=> { showSettings(); });

  if($('benatakBackBtn')) $('benatakBackBtn').addEventListener('click', ()=> { showProfileSummary(); });

  // settings bindings
  if($('settingsBackBtn')) $('settingsBackBtn').addEventListener('click', ()=> { showProfileSummary(); });
  if($('settingsEditProfileBtn')) $('settingsEditProfileBtn').addEventListener('click', ()=> { showProfile(); });
  if($('settingsThemeBtn')) $('settingsThemeBtn').addEventListener('click', ()=> { showThemePage(); });
  if($('settingsPrivacyBtn')) $('settingsPrivacyBtn').addEventListener('click', ()=> { showPrivacy(); });
  if($('settingsLogoutBtn')) $('settingsLogoutBtn').addEventListener('click', ()=> { doLogout(); });

  // theme bindings
  document.querySelectorAll('.theme-swatch').forEach(el=>{
    el.addEventListener('click', ()=>{
      const c = el.getAttribute('data-color');
      if(c) applyMainColor(c, true);
    });
  });
  if($('themeBackBtn')) $('themeBackBtn').addEventListener('click', ()=> { showSettings(); });

  if($('privacyBackBtn')) $('privacyBackBtn').addEventListener('click', ()=> { showSettings(); });
  
  // bottom nav bindings
  if($('navHomeBtn')) $('navHomeBtn').addEventListener('click', ()=> { showHome(); });
  if($('navChargeBtn')) $('navChargeBtn').addEventListener('click', ()=> { openChargePage(); });
  if($('navOrdersBtn')) $('navOrdersBtn').addEventListener('click', ()=> { showOrders(); });
  if($('navProfileBtn')) $('navProfileBtn').addEventListener('click', ()=> { showProfileSummary(); });

  // load profile from localStorage
  const saved = localStorage.getItem('user_profile_v1');
  if(saved){
    try{ currentProfile = JSON.parse(saved); }catch(e){ currentProfile = null; }
  }
  if(!currentProfile){
    let pn = localStorage.getItem('personalNumber');
    if(!pn){ pn = String(Math.floor(1000000 + Math.random()*9000000)); localStorage.setItem('personalNumber', pn); }
    currentProfile = { personalNumber: pn, name:'ضيف', email:'', phone:'', balance:0, canEdit:false };
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  }
  if(typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
  
  // apply saved main color if موجود
  const savedColor = localStorage.getItem('app_main_color');
  if(savedColor) applyMainColor(savedColor, false);

  // show login or home
  const isGuest = (!currentProfile || !currentProfile.name || currentProfile.name === 'ضيف');
  const hasCreds = !!(currentProfile && currentProfile.password);
  if (isGuest || !hasCreds) { hideAllPages(); if($('loginPage')) showPageQuick('loginPage'); window.scrollTo({ top: 0 }); }
  else { showHome(); }

  // poll every 6s
  setInterval(()=>{
    try{ refreshNotificationsCount(); }catch(e){ console.warn('refreshNotificationsCount interval error', e); }
    try{ if(typeof fetchOffers === 'function') fetchOffers(); }catch(e){ console.warn('fetchOffers interval error', e); }
  }, 6000);

  // initial calls
  refreshNotificationsCount();
  if(typeof fetchOffers === 'function') fetchOffers();

  // Initialize section tiles (img placeholders and click handlers)
  initSectionsUI();
});

/* ---------- باقي الدوال كما في الأصل مع استبدال show... بدوال سريعة انبثاقية حيث يحتاج المستخدم ---------- */

function showHome(){
  // remove compact header for home
  setCompactHeader(false);
  hideAllPages(); show('homePage'); window.scrollTo({top:0});
}
function showGames(){ showPageQuick('gamesPage'); }
function showApps(){ showPageQuick('appsPage'); }
function showHelp(){ showPageQuick('helpPage'); }
function showProfile(){ showPageQuick('profilePage'); fillProfileFields(); }
function openChargePage(){
  $('pdTitle').textContent='شحن الرصيد';
  $('pdTopInfo').textContent='اطلب شحن الرصيد عبر رفع ايصال التحويل';
  showPageQuick('paymentDetailsPage');
}
function showOrders(){ showPageQuick('ordersPage'); loadOrdersList(); }
function showOffers(){ showPageQuick('offersPage'); fetchOffers(); }
function showProfileSummary(){ showPageQuick('profileSummaryPage'); window.scrollTo({top:0}); }
function showSettings(){ showPageQuick('settingsPage'); }

/* theme page */
function showThemePage(){ showPageQuick('themePage'); }

/* privacy */
function showPrivacy(){ showPageQuick('privacyPage'); }

// New: show benatak page and populate
function showBenatak(){
  showPageQuick('benatakPage');
  populateBenatak();
}
/* apply main color */
function applyMainColor(colorHex, save=true){
  try{
    document.documentElement.style.setProperty('--main-color', colorHex);
    if(save) localStorage.setItem('app_main_color', colorHex);
  }catch(e){ console.warn('applyMainColor error', e); }
}

// profile helpers
function refreshUIFromProfile(){
  try{
    $('personalNum').textContent = currentProfile.personalNumber || '';
    if($('personalField')) $('personalField').value = currentProfile.personalNumber || '';
    if($('appPersonalField')) $('appPersonalField').value = currentProfile.personalNumber || '';
    if($('helpPersonalField')) $('helpPersonalField').value = currentProfile.personalNumber || '';
    if($('loginPersonalNumber')) $('loginPersonalNumber').value = currentProfile.personalNumber || '';
    $('sidebarName').textContent = currentProfile.name || 'ضيف';
    $('sidebarAvatar').textContent = (currentProfile.name && currentProfile.name.trim().length>0) ? currentProfile.name.trim().charAt(0).toUpperCase() : 'أ';
    $('sidebarPersonal').textContent = 'رقمك الشخصي: ' + (currentProfile.personalNumber || '');

    if($('summaryName')) $('summaryName').textContent = currentProfile.name || 'ضيف';
    if($('summaryAvatar')) $('summaryAvatar').textContent = (currentProfile.name && currentProfile.name.trim().length>0) ? currentProfile.name.trim().charAt(0).toUpperCase() : 'أ';
    if($('summaryPersonal')) $('summaryPersonal').textContent = 'رقمك الشخصي: ' + (currentProfile.personalNumber || '');

    // show balance
    const bal = Number(currentProfile.balance || 0);
    const bEl = $('balanceBox');
    if(bEl){
      bEl.textContent = ` ${bal.toLocaleString('en-US')} ل.س`;
      bEl.classList.remove('hidden');
      bEl.style.opacity = bal === 0 ? '0.85' : '1';
    }
  }catch(e){ console.warn('refreshUIFromProfile error', e); }
}
function fillProfileFields(){
  if($('profileName')) $('profileName').value = currentProfile.name || '';
  if($('profileEmail')) $('profileEmail').value = currentProfile.email || '';
  if($('profilePassword')) $('profilePassword').value = currentProfile.password || '';
  if($('profilePhone')) $('profilePhone').value = currentProfile.phone || '';
  applyProfileEditState();
}
function applyProfileEditState(){
  const canEdit = !!currentProfile.canEdit;
  ['profileName','profileEmail','profilePassword','profilePhone'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(canEdit){ el.removeAttribute('readonly'); } else { el.setAttribute('readonly','readonly'); }
  });
  if(canEdit){ if($('requestEditBtn')) $('requestEditBtn').classList.add('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.remove('hidden'); if($('profileMsg')) $('profileMsg').textContent='يمكنك تعديل بياناتك الآن مرة واحدة ثم اضغط حفظ.'; }
  else { if($('requestEditBtn')) $('requestEditBtn').classList.remove('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.add('hidden'); if($('profileMsg')) $('profileMsg').textContent='للتعديل اطلب موافقة من الإدارة عبر الزر أدناه.'; }
}

// login/register
async function doLogin(){
  const name = $('loginName').value.trim();
  const email = $('loginEmail').value.trim();
  const password = $('loginPassword').value;
  const phone = $('loginPhone').value.trim();
  const personal = $('loginPersonalNumber').value || currentProfile.personalNumber;
  const errEl = $('loginError');
  if(errEl) errEl.style.display='none';
  if(!name){ if(errEl){ errEl.textContent='الرجاء إدخال الاسم'; errEl.style.display='block'; } return; }
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ if(errEl){ errEl.textContent='صيغة البريد الإلكتروني غير صحيحة'; errEl.style.display='block'; } return; }
  if(!password){ if(errEl){ errEl.textContent='الرجاء إدخال كلمة السر'; errEl.style.display='block'; } return; }

  try{
    const resp = await fetch(API_ROOT + 'api/register', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ name, email, password, phone, personalNumber: personal })
    });
    const data = await resp.json().catch(()=>null);
    if (data && data.ok) {
      currentProfile = data.profile ? Object.assign({}, currentProfile, data.profile) : { name, email, phone, password, personalNumber: personal, balance: (data.profile && data.profile.balance) || currentProfile.balance || 0 };
      if (!currentProfile.personalNumber) currentProfile.personalNumber = personal;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      localStorage.setItem('is_logged_in', '1');
      refreshUIFromProfile();
      showHome();
      alert('تم تسجيل الدخول');
    } else {
      alert('فشل التسجيل: ' + (data && data.error ? data.error : 'خطأ غير معروف'));
    }
  }catch(e){
    console.error('doLogin error', e);
    alert('خطأ في الاتصال');
  }
}

// request profile edit
async function requestProfileEdit(){
  const ok = confirm('سيتم إرسال طلب تعديل بياناتك للإدارة. هل تريد المتابعة؟');
  if(!ok) return;

  // increment local counter for edit requests
  try{
    const personal = currentProfile.personalNumber;
    const key = 'profile_edit_requests_' + personal;
    const prev = parseInt(localStorage.getItem(key) || '0', 10) || 0;
    const now = prev + 1;
    localStorage.setItem(key, String(now));
    currentProfile.profileEditRequests = now;
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
    if($('profileEditRequestsCount')) $('profileEditRequestsCount').textContent = String(now);
  }catch(e){ console.warn('increment edit counter', e); }

  try{
    const resp = await fetch(API_ROOT + 'api/profile/request-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if (data && data.ok) {
      alert('تم إرسال طلب التعديل. انتظر موافقة الإدارة.');
      if($('requestEditBtn')) $('requestEditBtn').textContent='تم إرسال الطلب';
      setTimeout(() => { if($('requestEditBtn')) $('requestEditBtn').textContent='طلب تعديل معلوماتك'; }, 10000);
    } else {
      alert('فشل الإرسال');
    }
  }catch(e){ console.error('requestProfileEdit error', e); alert('خطأ في الاتصال'); }
}

async function confirmProfileSave(){
  const name = $('profileName').value.trim();
  const email = $('profileEmail').value.trim();
  const password = $('profilePassword').value;
  const phone = $('profilePhone').value.trim();

  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    alert('البريد غير صالح');
    return;
  }

  try {
    const resp = await fetch(API_ROOT + 'api/profile/submit-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({
        personal: currentProfile.personalNumber,
        name, email, password, phone
      })
    });
    const data = await resp.json().catch(()=>null);

    if(data && data.ok){
      if(data.profile){
        currentProfile = Object.assign({}, currentProfile, data.profile);
      } else {
        currentProfile.name = name || currentProfile.name;
        currentProfile.email = email || currentProfile.email;
        currentProfile.password = password || currentProfile.password;
        currentProfile.phone = phone || currentProfile.phone;
      }
      currentProfile.canEdit = false;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));

      alert('تم حفظ التعديلات');
      applyProfileEditState();
      refreshUIFromProfile();
    } else {
      alert('لا يمكنك التعديل الآن: ' + (data && data.error ? data.error : 'خطأ غير معروف'));
    }
  } catch(err){
    console.error(err);
    alert('فشل الاتصال بالخادم');
  }
}

// help submit
async function submitHelp(){
  const issue = $('helpIssueSelect').value;
  const fileLink = $('helpFileLink').value;
  const desc = $('helpDesc').value.trim();
  const personal = currentProfile.personalNumber;
  if(!issue){ alert('اختر مشكلتك'); return; }
  try{
    const resp = await fetch(API_ROOT + 'api/help', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal, issue, fileLink, desc, name: currentProfile.name, email: currentProfile.email, phone: currentProfile.phone })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){ alert('تم ارسال المشكلة'); hide('helpPage'); showHome(); } else { alert('فشل الارسال'); }
  }catch(e){ console.error('submitHelp error', e); alert('خطأ في الاتصال'); }
}

// uploading to imgbb (client-side)
async function uploadFileToImgbb(file, targetInputId = 'paymentFileLink', statusElId='paymentUploadStatus'){
  if(!file) return;
  const statusEl = $(statusElId);
  if(statusEl) statusEl.textContent = 'جارية عملية الرفع... 0%';
  try{
    const IMGBB_KEY = "e5603dfd5675ed2b5a671577abcf6d33";
    const fd = new FormData();
    fd.append('image', file);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`);
    xhr.onload = function(){
      if(xhr.status>=200 && xhr.status<300){
        try{
          const resp = JSON.parse(xhr.responseText||'{}');
          const url = resp && resp.data && (resp.data.url || resp.data.display_url);
          if(url){
            $(targetInputId).value = url;
            if(statusEl) statusEl.textContent = 'تم الرفع بنجاح';
            alert('تم رفع الملف');
          } else {
            if(statusEl) statusEl.textContent = 'فشل الرفع';
            alert('فشل رفع الملف');
          }
        }catch(e){ if(statusEl) statusEl.textContent = 'خطأ في الرفع'; alert('خطأ في رفع الملف'); }
      } else {
        if(statusEl) statusEl.textContent = 'فشل الرفع';
        alert('فشل الرفع: ' + xhr.status);
      }
    };
    xhr.onerror = function(){ if(statusEl) statusEl.textContent='خطأ في الشبكة'; alert('خطأ في الشبكة أثناء الرفع'); };
    xhr.upload.onprogress = function(ev){ if(ev.lengthComputable){ const pct = Math.round((ev.loaded/ev.total)*100); if(statusEl) statusEl.textContent = `جارية عملية الرفع... ${pct}%`; } };
    xhr.send(fd);
  }catch(e){ console.error(e); if($(statusElId)) $(statusElId).textContent = 'خطأ أثناء الرفع'; alert('خطأ أثناء الرفع'); }
}

/* ===== Unified Section + Store + Simple Order data & functions ===== */

// بيانات افتراضية (عدل او استبدل الصور بالروابط التي سترفعها)
const sectionsData = {
  "games": { title:"قسم الألعاب", subs:[ {key:'freefire', title:'فري فاير', img:'https://i.postimg.cc/bN8h5xJD/image.jpg'}, {key:'pubg', title:'PUBG', img:'https://i.postimg.cc/PJTRSM4d/image.jpg'}, {key:'blodstrik', title:'بلود سترايك', img:'https://i.postimg.cc/vTKcFn7k/image.jpg'} ,{key:'dlta', title:'دلتا فورس', img:'https://i.postimg.cc/PJTRSM4d/image.jpg'} ] },
  
// <---  --->
  "apps": { title:"قسم التطبيقات", subs:[ {key:'app1', title:'تطبيق 1', img:''}, {key:'app2', title:'تطبيق 2', img:''} ] },
  
  // <---  --->
  "rashq": { title:"قسم الرشق", subs:[ {key:'r1', title:'رشق 1', img:''} ] },
  
  // <---  --->
  "cards": { title:"قسم البطاقات", subs:[ {key:'card1', title:'بطاقة 1', img:''} ] },
  
  // <---  --->
  "numbers": { title:"قسم الأرقام", subs:[ {key:'num1', title:'رقم 1', img:''} ] },
  
  // <---  --->
  "accounts_ready": { title:"حسابات جاهزة", subs:[ {key:'acc1', title:'حساب 1', img:''} ] },
  
  // <---  --->
  "design_apps": { title:"برامج تصميم", subs:[ {key:'des1', title:'برنامج 1', img:''} ] },
  
  // <---  --->
  "verify_accounts": { title:"توثيق حسابات", subs:[ {key:'v1', title:'توثيق 1', img:''} ] },
  
  // <---  --->
  "balance": { title:"قسم الرصيد", subs:[ {key:'charge1', title:'شحن 1', img:''} ] },
  
  // <---  --->
  "subscriptions": { title:"اشتراكات تطبيقات", subs:[ {key:'sub1', title:'اشتراك 1', img:''} ] },
  
  // <---  --->
  "proxies": { title:"بروكسيات", subs:[ {key:'px1', title:'بروكسي 1', img:''} ] },
  
  // <---  --->
  "software": { title:"قسم السوفتوير", subs:[ {key:'soft1', title:'سوفت 1', img:''} ] }
};

// حزم لكل لعبة (قابلة للتعديل)
const gamePackages = {
  'freefire': [

// <--- ff100 --->
    { id:'ff_100', title:'100 💎 + 10 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات', priceText:'11500 ل.س', priceNum:11500, img:'https://i.postimg.cc/7hHK3ZH6/image.jpg' },
    
// <--- ff200 --->    
    { id:'ff_210', title:'210 💎 + 21 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات', priceText:'25000 ل.س', priceNum:25000, img:'https://i.postimg.cc/CLjjhgSr/image.jpg' },
    
// <--- ff500 --->
    { id:'ff_530', title:'530 💎 + 53 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات!  ', priceText:'55000 ل.س', priceNum:55000, img:'https://i.postimg.cc/rFLpWqnS/image.jpg' },
    
// <--- ff1080 --->
    { id:'ff_1080', title:'1080 💎 + 108 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'115000 ل.س', priceNum:115000, img:'https://i.postimg.cc/kGyPWPGc/image.jpg' },

// <--- ff2200 --->
    { id:'ff_2200', title:'2200 💎 + 220 ', note:' الوقت لقبول الطلب: من دقيقة حتى 3 ساعات!  ', priceText:'225000 ل.س', priceNum:225000, img:'https://i.postimg.cc/x1qfKq2F/image.jpg' },
    
// <--- ffعضوية اسبوعية --->
    { id:'ff_week', title:'عضوية اسبوعية', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'27000 ل.س', priceNum:27000, img:'https://i.postimg.cc/VvpY6592/image.jpg' },
    
// <--- ffعضوية شهرية --->
    { id:'ff_month', title:'عضوية شهرية', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات  ', priceText:'127000 ل.س', priceNum:127000, img:'https://i.postimg.cc/PrV3F9T3/image.jpg' },
    
// <--- ffبوياه باس --->
    { id:'ff_boyah', title:'بوياه باس ', note:'   الوقت لقبول الطلب: من دقيقة حتى 3 ساعات!', priceText:'40000 ل.س', priceNum:40000, img:'https://i.postimg.cc/Y0C0nbH7/image.jpg' }
  ],
  'pubg': [

// <--- 60 شدة --->
    { id:'pubg_60', title:'60 UC ', note:' الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'12000 ل.س', priceNum:12000, img:'https://i.postimg.cc/fLYCM7k1/image.jpg' },
    
// <--- 325 شدة --->
    { id:'pubg_325', title:'325 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'55000 ل.س', priceNum:55000, img:'https://i.postimg.cc/t4PYSBf0/image.jpg' },
    
// <--- 660 شدة --->
    { id:'pubg_660', title:'660 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'115000 ل.س', priceNum:115000, img:'https://i.postimg.cc/VNZv520C/image.jpg' },
    
// <--- 1800 شدة --->
    { id:'pubg_1800', title:'1800 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'278650 ل.س', priceNum:278650, img:'https://i.postimg.cc/50ccPmZr/image.jpg' },
    
// <--- برايم شهر واحد --->
    { id:'pubg_prime1', title:'prime برايم شهر 1 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'20000 ل.س', priceNum:20000, img:'https://i.postimg.cc/8cR6YDt6/image.jpg' },
    
// <--- برايم --->
    { id:'pupbg_brim2', title:'prime برايم 3 شهور', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'41500 ل.س', priceNum:41500, img:'https://i.postimg.cc/2yDBWwWY/image.jpg' },

// <--- برايم --->
    { id:'pubg_prim3', title:'prime برايم 6 شهور ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'82500 ل.س', priceNum:82500, img:'https://i.postimg.cc/dQhqRd6P/image.jpg' },
    
// <---  --->
    { id:'plus', title:'برايم بلس شهر ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'125000 ل.س', priceNum:125000, img:'https://i.postimg.cc/C1Nfj8sf/image.jpg' },
    
// <---  --->
    { id:'pluus', title:'برايم بلس 3 شهور', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'ل.س 370500', priceNum:370500, img:'https://i.postimg.cc/vH9xzChs/image.jpg' }
  ],
  
  'blodstrik': [
      
// <---  --->
{ id:'blood1', title:'BS 320 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'34000 ل.س', priceNum:34000, img:'https://i.postimg.cc/8cR6YDt6/image.jpg' },

// <---  --->
    { id:'blood2', title:'BS 540 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'49500 ل.س', priceNum:49500, img:'https://i.postimg.cc/8cR6YDt6/image.jpg' },
    
    // <---  --->
    { id:'bllod3', title:'BS 1100 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'97900 ل.س', priceNum:97900, img:'https://i.postimg.cc/8cR6YDt6/image.jpg' },
    
    // <---  --->
    { id:'blood4', title:'BS ELITE pass', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'39990 ل.س', priceNum:39990, img:'https://i.postimg.cc/8cR6YDt6/image.jpg' },
    
    // <---  --->
    { id:'blood5', title:'BS Premium Pass', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'91750 ل.س', priceNum:91750, img:'https://i.postimg.cc/8cR6YDt6/image.jpg' }
  ],
  'dlta': [
      
// <---  --->
    { id:'dlta1', title:'DF 320 COINS', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'47500 ل.س', priceNum:47500, img:'' }
  ]
};

/* init: set images for section tiles and bind click */
function initSectionsUI(){
  // fill placeholders for images
  document.querySelectorAll('#homePage .section-tile').forEach(tile=>{
    const key = tile.getAttribute('data-section');
    const img = tile.querySelector('img.placeholder');
    if(img){
      // use first sub image if present
      const sd = sectionsData[key];
      if(sd && sd.subs && sd.subs.length>0 && sd.subs[0].img){
        img.src = sd.subs[0].img;
      } else {
        img.src = 'https://via.placeholder.com/200x120?text=img'; // fallback
      }
    }
    // click handler
    tile.addEventListener('click', ()=> {
      const sec = tile.getAttribute('data-section');
      if(sec) openSection(sec);
    });
  });
}

/* openSection: show sectionPage and populate subs */
function openSection(sectionKey){
  const sd = sectionsData[sectionKey];
  if(!sd){
    alert('القسم غير موجود');
    return;
  }
  window._lastOpenedSection = sectionKey;
  const title = sd.title || 'القسم';
  if($('sectionPageTitle')) $('sectionPageTitle').textContent = title;
  const grid = $('sectionSubgrid'); if(!grid) return;
  grid.innerHTML = '';
  // create subcards
  (sd.subs || []).forEach(sub=>{
    const d = document.createElement('div'); d.className = 'subcard';
    const img = document.createElement('img'); img.src = sub.img || 'https://via.placeholder.com/150x80?text=img'; img.alt = sub.title;
    const name = document.createElement('div'); name.textContent = sub.title; name.style.fontWeight='800';
    d.appendChild(img);
    d.appendChild(name);
    // Clicking a sub:
    d.addEventListener('click', ()=>{
      // if section is games, open game store for that key
      if(sectionKey === 'games'){
        // map sub.key to gamePackages key if exists
        openGameStore(sub.key, sub.title);
      } else {
        // for other sections open simple order page prefilled with sub info
        openSimpleOrderGeneric(sub.title, sub.img, 0, sub.key, sectionKey);
      }
    });
    grid.appendChild(d);
  });
  showPageQuick('sectionPage');
}

/* openGameStore: show packages for a specific game (gameKey) */
function openGameStore(gameKey, gameTitle){
  window._lastOpenedGame = { key: gameKey, title: gameTitle };
  const grid = $('gameStoreGrid'); if(!grid) return;
  const titleEl = $('gameStoreTitle'); if(titleEl) titleEl.textContent = `متجر ${gameTitle}`;
  grid.innerHTML = '';
  const pkgs = gamePackages[gameKey] || [];
  if(pkgs.length === 0){
    grid.innerHTML = `<div style="text-align:center;color:#aaa;padding:20px;">لا توجد باقات حالياً</div>`;
  } else {
    pkgs.forEach(pkg=>{
      const d = document.createElement('div'); d.className = 'item-card';
      const img = document.createElement('img'); img.src = pkg.img || 'https://via.placeholder.com/120'; img.alt = pkg.title;
      const name = document.createElement('div'); name.textContent = pkg.title; name.style.fontWeight='800';
      const note = document.createElement('div'); note.textContent = pkg.note || ''; note.style.color='#ccc'; note.style.fontSize='13px';
      const price = document.createElement('div'); price.textContent = pkg.priceText || ''; price.style.color='var(--main-color)'; price.style.fontWeight='800';
      d.appendChild(img); d.appendChild(name); d.appendChild(note); d.appendChild(price);
      d.addEventListener('click', ()=> {
        openSimpleOrderFromPkg(pkg, gameTitle);
      });
      grid.appendChild(d);
    });
  }
  showPageQuick('gameStorePage');
}

/* openSimpleOrderFromPkg: عندما يضغط المستخدم على باقة من متجر اللعبة */
function openSimpleOrderFromPkg(pkg, gameTitle){
  if(!pkg) return;
  // fill the simple order page
  if($('simpleOrderImg')) $('simpleOrderImg').src = pkg.img || '';
  if($('simpleOrderItemName')) $('simpleOrderItemName').textContent = `${gameTitle} - ${pkg.title}`;
  if($('simpleOrderItemNote')) $('simpleOrderItemNote').textContent = pkg.note || '';
  if($('simpleUnitPrice')) $('simpleUnitPrice').value = (pkg.priceNum || pkg.priceNum === 0) ? String(pkg.priceNum) + ' ل.س' : (pkg.priceText || '');
  if($('simpleQty')) $('simpleQty').value = 1;
  if($('simpleIdField')) $('simpleIdField').value = '';
  if($('simplePersonal')) $('simplePersonal').value = currentProfile.personalNumber || '';
  // compute total
  const updateTotal = ()=>{
    const qty = Number(($('simpleQty') && $('simpleQty').value) || 1);
    const unit = Number(pkg.priceNum || 0);
    const total = qty * unit;
    if($('simpleTotalPrice')) $('simpleTotalPrice').value = total ? (total + ' ل.س') : '0 ل.س';
  };
  updateTotal();
  // listeners for qty change
  if($('simpleQty')) { $('simpleQty').oninput = updateTotal; }
  // set a handler for send button
  if($('simpleOrderSend')) {
    $('simpleOrderSend').onclick = async function(){
      const idField = $('simpleIdField') ? $('simpleIdField').value.trim() : '';
      const qty = Number(($('simpleQty') && $('simpleQty').value) || 1);
      if(!idField){ alert('ضع الايدي'); return; }
      const unit = Number(pkg.priceNum || 0);
      const total = unit * qty;
      // check balance
      const bal = Number(currentProfile.balance || 0);
      if(bal < total){ alert('مافي رصيد كافي'); return; }
      // deduct locally and send order
      currentProfile.balance = bal - total;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      // prepare body similar to other flows
      const body = {
        personal: currentProfile.personalNumber,
        phone: currentProfile.phone,
        type: 'طلب سريع',
        item: `${gameTitle} - ${pkg.title}`,
        idField: idField,
        qty: qty,
        paidWithBalance: true,
        paidAmount: total
      };
      try{
        const r = await fetch(API_ROOT + 'api/orders', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
        const data = await r.json().catch(()=>null);
        if(data && data.ok){
          hideAllPages(); show('reviewPage'); if($('reviewMsg')) $('reviewMsg').textContent = 'تم ارسال طلبك وسيتم مراجعته (مدفوع من رصيدك).';
          // store history locally
          try{
            const key = 'orders_history_' + (currentProfile.personalNumber || 'guest');
            const prev = JSON.parse(localStorage.getItem(key) || '[]');
            prev.push(Object.assign({}, data.order || {}, { localSavedAt: new Date().toISOString() }));
            localStorage.setItem(key, JSON.stringify(prev));
          }catch(e){}
        } else {
          alert('فشل ارسال الطلب');
        }
      }catch(e){ console.error('simple order send', e); alert('خطأ في الاتصال'); }
    };
  }
  showPageQuick('simpleOrderPage');
}

/* generic opener for non-game simple orders */
function openSimpleOrderGeneric(title, img, priceNum=0, key=null, sectionKey=null){
  // For other sections, show simple order but price may be zero: user will be asked later or via payment flow
  const pkg = { id: key || ('pkg_' + Date.now()), title: title, note: title, priceText: priceNum ? (priceNum + ' ل.س') : 'سعر حسب الطلب', priceNum: priceNum || 0, img: img || '' };
  // mark last opened section so cancel goes back
  window._lastOpenedSection = sectionKey || null;
  openSimpleOrderFromPkg(pkg, title);
}

/* ----------- Existing build functions (kept for backward compatibility) ----------- */
function buildGameOptions(val){
  if($('optionsContainer')) $('optionsContainer').innerHTML='';
  selectedGameOption=''; if($('priceDisplay')) $('priceDisplay').textContent='';
  if(val==='فري فاير ايدي'){ currentMap = priceMapFF; currentMap_num = priceMapFF_num; }
  else if(val==='ببجي ايدي'){ currentMap = priceMapPUBG; currentMap_num = priceMapPUBG_num; }
  else if(val==='جواكر'){ currentMap = priceMappubg1; currentMap_num = priceMappubg1_num; }
  else { currentMap = null; currentMap_num = {}; }
  if(currentMap && $('optionsContainer')){
    Object.keys(currentMap).forEach(opt=>{
      const d = document.createElement('div'); d.className='button-option'; d.textContent = opt;
      d.addEventListener('click', ()=> {
        document.querySelectorAll('#optionsContainer .button-option').forEach(x=>x.classList.remove('selected'));
        d.classList.add('selected');
        selectedGameOption = opt;
        if($('priceDisplay')) { $('priceDisplay').textContent = `الحزمة: ${opt}\nالسعر: ${currentMap[opt]}`; $('priceDisplay').style.color='#0f0'; }
        updateSubmitButtonGames();
      });
      $('optionsContainer').appendChild(d);
    });
  }
}

function buildAppOptions(val){
  if($('optionsContainerApps')) $('optionsContainerApps').innerHTML='';
  selectedAppOption=''; if($('priceDisplayApps')) $('priceDisplayApps').textContent='';
  if(priceMapApps[val] && $('optionsContainerApps')){
    const d = document.createElement('div'); d.className='button-option'; d.textContent = val;
    d.addEventListener('click', ()=> {
      document.querySelectorAll('#optionsContainerApps .button-option').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      selectedAppOption = val;
      if($('priceDisplayApps')) { $('priceDisplayApps').textContent = `السعر: ${priceMapApps[val]}`; $('priceDisplayApps').style.color='#0f0'; }
      updateSubmitButtonApps();
    });
    $('optionsContainerApps').appendChild(d);
  }
}

function updateSubmitButtonGames(){ const idf=$('idField') ? $('idField').value.trim() : ''; if($('submitForm')) $('submitForm').disabled = !(selectedGameOption && idf); }
function updateSubmitButtonApps(){ const idf=$('appIdField') ? $('appIdField').value.trim() : ''; if($('appSubmitForm')) $('appSubmitForm').disabled = !(selectedAppOption && idf); }

// order placement (uses balance) - unchanged
async function placeOrderFromUI(fromPage){
  try{
    if(fromPage === 'gamesPage'){
      const personal = $('personalField').value;
      const game = $('gameSelect').value;
      const idField = $('idField').value.trim();
      const opt = selectedGameOption;
      if(!game || !idField || !opt){ alert('اكمل البيانات'); return; }
      let price = 0;
      if(currentMap_num && currentMap_num[opt]) price = Number(currentMap_num[opt]);
      else {
        const raw = $('priceDisplay') ? $('priceDisplay').textContent : '';
        price = parseInt((raw.replace(/\D/g,''))||0,10);
      }
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'شحن لعبة', item: `${game} - ${opt}`, idField, paidAmount: price });
    } else if(fromPage === 'appsPage'){
      const personal = $('appPersonalField').value;
      const app = $('appSelect').value;
      const idField = $('appIdField').value.trim();
      const opt = selectedAppOption;
      if(!app || !idField || !opt){ alert('اكمل البيانات'); return; }
      let price = priceMapApps_num[opt] || 0;
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'شراء تطبيق', item: `${app} - ${opt}`, idField, paidAmount: price });
    } else {
      alert('مصدر غير معروف للطلب');
    }
  }catch(e){
    console.error('placeOrderFromUI', e);
    alert('خطأ أثناء إرسال الطلب');
  }
}

async function attemptChargeAndSendOrder(orderBody){
  const bal = Number(currentProfile.balance || 0);
  const price = Number(orderBody.paidAmount || 0);
  if(isNaN(price) || price <= 0){
    alert('تعذر تحديد سعر الحزمة');
    return;
  }
  if(bal < price){
    alert('مافي رصيد كافي');
    return;
  }

  currentProfile.balance = bal - price;
  localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  refreshUIFromProfile();

  const body = {
    personal: orderBody.personal,
    phone: orderBody.phone,
    type: orderBody.type,
    item: orderBody.item,
    idField: orderBody.idField,
    fileLink: orderBody.fileLink || '',
    cashMethod: orderBody.cashMethod || '',
    paidWithBalance: true,
    paidAmount: price
  };

  try{
    const r = await fetch(API_ROOT + 'api/orders', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
    const data = await r.json().catch(()=>null);
    if(data && data.ok){
      hideAllPages(); show('reviewPage'); if($('reviewMsg')) $('reviewMsg').textContent = 'تم ارسال طلبك وسيتم مراجعته (مدفوع من رصيدك).';
      localStorage.setItem('lastOrderId', data.order && data.order.id ? data.order.id : '');
      // Optionally store to local orders history for offline counts
      try{
        const key = 'orders_history_' + (currentProfile.personalNumber || 'guest');
        const prev = JSON.parse(localStorage.getItem(key) || '[]');
        prev.push(Object.assign({}, data.order || {}, { localSavedAt: new Date().toISOString() }));
        localStorage.setItem(key, JSON.stringify(prev));
      }catch(e){ /* ignore */ }
    } else {
      alert('فشل ارسال الطلب');
    }
  }catch(e){ console.error('order send error', e); alert('خطأ في الاتصال'); }
}

// بقية الدوال: refreshNotificationsCount, markNotificationsReadForCurrentUser, loadOrdersList, fetchOffers, onPdCashChange, toggleQr, submitPaymentDetails
// (تم تضمينها كما في الملف الأصلي مع تعديلات بسيطة لتسجيل الشحنات محلياً — لتظهر في صفحة "بيناتك")

async function refreshNotificationsCount(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;

    const serverCanEdit = !!(data.canEdit || (data.profile && data.profile.canEdit));
    if(serverCanEdit !== !!currentProfile.canEdit){
      currentProfile.canEdit = serverCanEdit;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      if(typeof applyProfileEditState === 'function') applyProfileEditState();
    }

    if(data.profile && typeof data.profile.balance !== 'undefined'){
      const serverBal = Number(data.profile.balance || 0);
      if(serverBal !== Number(currentProfile.balance || 0)){
        currentProfile.balance = serverBal;
        localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
        if(typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
      }
    }

    const offers = data.offers || [];
    const orders = data.orders || [];
    const charges = data.charges || [];
    const notifications = data.notifications || [];
    const unreadCount = (orders.filter(o=>o.replied).length) + (charges.filter(c=>c.replied).length) + (offers.length>0 ? 1 : 0) + (notifications.filter(n=>!n.read).length);
    if(unreadCount>0){ $('notifBadge').classList.remove('hidden'); $('notifBadge').textContent = String(unreadCount); } else { $('notifBadge').classList.add('hidden'); }
  }catch(err){ console.warn('refreshNotificationsCount error', err); }
}

async function markNotificationsReadForCurrentUser(){
  if(!currentProfile || !currentProfile.personalNumber) return;
  try{
    const resp = await fetch(API_ROOT + 'api/notifications/mark-read', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){ $('notifBadge').classList.add('hidden'); return true; }
  }catch(e){ console.warn('mark-read body failed', e); }
  try{
    const r2 = await fetch(API_ROOT + 'api/notifications/mark-read/' + currentProfile.personalNumber, { method:'POST' });
    const d2 = await r2.json().catch(()=>null);
    if(d2 && d2.ok){ $('notifBadge').classList.add('hidden'); return true; }
  }catch(e){ console.warn('mark-read param failed', e); }
  return false;
}

async function loadOrdersList(){
  try{
    const personal = currentProfile.personalNumber;
    const resp = await fetch(API_ROOT + 'api/notifications/' + personal);
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      const orders = data.orders || [];
      const charges = data.charges || [];
      const container = $('ordersList'); if(container) container.innerHTML = '';
if(orders.length === 0 && charges.length === 0) {
    if(container) container.innerHTML = `
        <div style="text-align:center; margin-top:20px;">
            <p></p>
            <img src="https://i.postimg.cc/cJyvqjgM/image.jpg" alt="لا توجد طلبات" width="300">
        </div>
    `;
    return;
}
      orders.forEach(o=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${o.id}</strong> - ${o.type} - ${o.item || ''} <br> الايدي: ${o.idField || ''} <br> الهاتف: ${o.phone || ''} <br> الحالة: <strong>${o.status}</strong> <br> أنشئ: ${new Date(o.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
      charges.forEach(c=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${c.id}</strong> - شحن رصيد - المبلغ: ${c.amount} <br> الحالة: <strong>${c.status}</strong> <br> أنشئ: ${new Date(c.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
    }
  }catch(e){ console.error('loadOrdersList error', e); }
}


// payment flow
let previousBeforePayment = null;
function showPaymentDetailsFromSubmit(fromPage){
  previousBeforePayment = fromPage;
  hideAllPages(); show('paymentDetailsPage');
  if($('pdTopInfo')) $('pdTopInfo').textContent = '';
  if($('pdPriceInfo')) $('pdPriceInfo').textContent = '';
  if($('pdCashSelect')) $('pdCashSelect').value = '';
  if($('pdCopyField')) $('pdCopyField').value = '';
  if($('qrContainer')) $('qrContainer').style.display='none';
  if($('syrtelQrContainer')) $('syrtelQrContainer').style.display='none';
  if($('paymentFileLink')) $('paymentFileLink').value = '';
  if($('paymentUploadStatus')) $('paymentUploadStatus').textContent = '';
  if($('pdNote')) $('pdNote').textContent = 'اختر طريقة الدفع لمتابعة التعليمات';
  if($('shamFields')) $('shamFields').style.display='none';
  if($('syrtelFields')) $('syrtelFields').style.display='none';
  if($('hawalaFields')) $('hawalaFields').style.display='none';
}
function returnFromPaymentDetails(){ if(previousBeforePayment==='gamesPage') showGames(); else if(previousBeforePayment==='appsPage') showApps(); else showHome(); }

function onPdCashChange(){
  const value = $('pdCashSelect').value;
  const pdNoteEl = $('pdNote');
  if(value==='sham'){
    if($('shamFields')) $('shamFields').style.display='block';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('qrContainer')) $('qrContainer').style.display='none';
    if($('syrtelQrContainer')) $('syrtelQrContainer').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = 'e5eca798a4add8f1b86d389330131c82';
    if(pdNoteEl) pdNoteEl.textContent = `تعليمات شام كاش.`;
  } else if(value==='syrtel'){
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='block';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = '72289118';
    if(pdNoteEl) pdNoteEl.textContent = `تعليمات سيرتيل.`;
  } else if(value==='hawala'){
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('hawalaFields')) $('hawalaFields').style.display='block';
    if($('pdCopyField')) $('pdCopyField').value = '';
    if(pdNoteEl) pdNoteEl.textContent = `قم بتحويل الرصيد المطلوب إلى: عبد الرحمن احمد عتون`;
  } else {
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = '';
    if(pdNoteEl) pdNoteEl.textContent = 'اختر طريقة الدفع لمتابعة التعليمات';
  }
}

function toggleQr(){
  const m = $('pdCashSelect') ? $('pdCashSelect').value : '';
  if(m==='sham'){ if($('qrContainer')) $('qrContainer').style.display = $('qrContainer').style.display === 'none' ? 'block' : 'none'; }
  else if(m==='syrtel'){ if($('syrtelQrContainer')) $('syrtelQrContainer').style.display = $('syrtelQrContainer').style.display === 'none' ? 'block' : 'none'; }
  else alert('صورة QR غير متاحة لهذه الطريقة');
}

async function submitPaymentDetails(){
  const cashMethod = $('pdCashSelect').value;
  const fileLink = $('paymentFileLink').value;
  if(!cashMethod){ alert('اختر طريقة الدفع'); return; }
  if(previousBeforePayment === 'gamesPage'){
    const personal = $('personalField').value;
    const game = $('gameSelect').value;
    const idField = $('idField').value;
    if(!game || !idField || !selectedGameOption){ alert('اكمل البيانات'); return; }
    const body = { personal, phone: currentProfile.phone, type:'شحن لعبة', item: `${game} - ${selectedGameOption}`, idField, fileLink, cashMethod };
    try{
      const r = await fetch(API_ROOT + 'api/orders', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
      const data = await r.json().catch(()=>null);
      if(data && data.ok){ hideAllPages(); show('reviewPage'); if($('reviewMsg')) $('reviewMsg').textContent='تم ارسال طلبك وسيتم مراجعته'; localStorage.setItem('lastOrderId', data.order && data.order.id); } else alert('فشل ارسال الطلب');
    }catch(e){ console.error('submitPaymentDetails order error', e); alert('خطأ في الاتصال'); }
  } else if(previousBeforePayment === 'appsPage'){
    const personal = $('appPersonalField').value;
    const app = $('appSelect').value;
    const idField = $('appIdField').value;
    if(!app || !idField || !selectedAppOption){ alert('اكمل البيانات'); return; }
    const body = { personal, phone: currentProfile.phone, type:'شراء تطبيق', item: `${app} - ${selectedAppOption}`, idField, fileLink, cashMethod };
    try{
      const r = await fetch(API_ROOT + 'api/orders', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
      const data = await r.json().catch(()=>null);
      if(data && data.ok){ hideAllPages(); show('reviewPage'); if($('reviewMsg')) $('reviewMsg').textContent='تم ارسال طلب التطبيق'; } else alert('فشل ارسال الطلب');
    }catch(e){ console.error('submitPaymentDetails apps error', e); alert('خطأ في الاتصال'); }
  } else {
    const personal = currentProfile.personalNumber;
    const amount = prompt('كم المبلغ الذي تريد شحنه؟ (أدخل رقم فقط)');
    if(!amount || isNaN(Number(amount))){ alert('قيمة غير صحيحة'); return; }
    const method = cashMethod || 'unknown';
    try{
      const r = await fetch(API_ROOT + 'api/charge', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ personal, phone: currentProfile.phone, amount, method, fileLink }) });
      const data = await r.json().catch(()=>null);
      if(data && data.ok){
        // سجل الشحنة محليًا أيضاً حتى تظهر في صفحة "بيناتك"
        try{
          const key = 'charges_history_' + personal;
          const prev = JSON.parse(localStorage.getItem(key) || '[]');
          const rec = { amount: Number(amount), method: method, createdAt: new Date().toISOString(), status: data.charge && data.charge.status ? data.charge.status : 'pending', serverId: (data.charge && data.charge.id) || null };
          prev.push(rec);
          localStorage.setItem(key, JSON.stringify(prev));

          // تحديث إجمالي الشحنات في ملف الملف الشخصي (اختياري)
          const totalKey = 'charges_total_' + personal;
          const prevTotal = Number(localStorage.getItem(totalKey) || '0');
          const newTotal = prevTotal + Number(amount);
          localStorage.setItem(totalKey, String(newTotal));
          currentProfile.topupTotal = (Number(currentProfile.topupTotal||0) + Number(amount));
          localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
        }catch(e){ console.warn('save local charge', e); }

        alert('تم ارسال طلب الشحن. انتظر الموافقة.');
        hideAllPages(); showHome();
      } else alert('فشل ارسال طلب الشحن');
    }catch(e){ console.error('submitPaymentDetails charge error', e); alert('خطأ في الاتصال'); }
  }
}

/* ---------- New: populate benatak data ---------- */
async function populateBenatak(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const personal = currentProfile.personalNumber;

    // server charges & orders
    let serverCharges = [];
    let serverOrders = [];
    try{
      const resp = await fetch(API_ROOT + 'api/notifications/' + personal);
      const data = await resp.json().catch(()=>null);
      if(data && data.ok){
        serverCharges = data.charges || [];
        serverOrders = data.orders || [];
      }
    }catch(e){ console.warn('populateBenatak: server fetch failed', e); }

    // local fallback (في حال السيرفر ما رجع بيانات)
    let localTotal = 0;
    if(serverCharges.length === 0){
      const localKey = 'charges_history_' + personal;
      const localCharges = JSON.parse(localStorage.getItem(localKey) || '[]');
      localTotal = localCharges.reduce((s,c)=> s + (Number(c.amount)||0), 0);
    }

    // إذا في بيانات من السيرفر استعملها، غير هيك استعمل المحلي
    const totalTopups = serverCharges.length > 0
      ? serverCharges.reduce((s,c)=> s + (Number(c.amount)||0), 0)
      : localTotal;

    // compute order counts
    const orders = serverOrders.length
      ? serverOrders
      : (JSON.parse(localStorage.getItem('orders_history_' + personal) || '[]'));
    let accepted = 0, rejected = 0, pending = 0;
    (orders || []).forEach(o=>{
      const s = (o.status || '').toString().toLowerCase();
      if(/رفض|مرفوض|rejected|declined/.test(s)) rejected++;
      else if(/مقبول|قبول|accepted|approved|done/.test(s)) accepted++;
      else pending++;
    });

    // profile edit requests count
    const editKey = 'profile_edit_requests_' + personal;
    const editCountLocal = Number(localStorage.getItem(editKey) || '0') || 0;
    const editCountProfile = Number(currentProfile.profileEditRequests || 0) || 0;
    const editCount = Math.max(editCountLocal, editCountProfile);

    // render values
    if($('totalTopupsValue')) $('totalTopupsValue').textContent = `${Number(totalTopups).toLocaleString('en-US')} ل.س`;
    if($('acceptedCount')) $('acceptedCount').textContent = String(accepted);
    if($('rejectedCount')) $('rejectedCount').textContent = String(rejected);
    if($('pendingCount')) $('pendingCount').textContent = String(pending);
    if($('profileEditRequestsCount')) $('profileEditRequestsCount').textContent = String(editCount);
  }catch(e){ console.error('populateBenatak error', e); }
}
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
});
/* logout */
function doLogout(){
  const ok = confirm('هل أنت متأكد أنك تريد تسجيل الخروج؟');
  if(!ok) return;
  // clear login-sensitive keys but keep personalNumber
  const pn = localStorage.getItem('personalNumber');
  localStorage.clear();
  if(pn) localStorage.setItem('personalNumber', pn);
  // remove profile in-memory
  currentProfile = { personalNumber: pn, name:'ضيف', email:'', phone:'', balance:0, canEdit:false };
  localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  refreshUIFromProfile();
  hideAllPages();
  showPageQuick('loginPage');
}
// ===== دعم زر الرجوع في الهاتف (Back Button) =====
(function(){

  // نحفظ دالة showPageQuick القديمة (لو موجودة)
  const _origShowPageQuick = window.showPageQuick 
    ? window.showPageQuick 
    : function(id){ 
        hideAllPages(); 
        show(id); 
      };

  // نعرّف دالة جديدة تحل مكان القديمة
  window.showPageQuick = function(pageId, doPush = true){
    // استدعاء الأصلية لعرض الصفحة
    _origShowPageQuick(pageId);

    // نضيف للسجل (history) إذا مسموح
    if(doPush){
      try {
        history.pushState({page: pageId}, '', '#' + pageId);
      } catch(e){
        console.warn('history.pushState failed', e);
      }
    }
  };

  // عند تحميل أول مرة نحفظ حالة ابتدائية
  if(!history.state){
    history.replaceState({page: 'homePage'}, '', '#homePage');
  }

  // الاستماع لزر الرجوع في الجهاز
  window.addEventListener('popstate', function(evt){
    const state = evt.state;
    const page = state && state.page ? state.page : 'homePage';
    window.showPageQuick(page, false); // نرجع للصفحة السابقة بدون إضافة سجل جديد
  });

})();

/* SAFEGUARD: منع فقدان الرصيد عند حفظ user_profile_v1 في localStorage
   -- ضع هذا الكود آخر السكريبت (قبل </body>) */
(function(){
  // نحتفظ بالإشارات الأصلية
  const _origGet = localStorage.getItem.bind(localStorage);
  const _origSet = localStorage.setItem.bind(localStorage);

  localStorage.setItem = function(key, value) {
    try {
      if (key === 'user_profile_v1' && typeof value === 'string') {
        // محاولة تحليل النسخة الجديدة والنسخة القديمة
        let newObj = null;
        try { newObj = JSON.parse(value); } catch(e){ newObj = null; }

        const oldRaw = _origGet('user_profile_v1');
        let oldObj = null;
        try { oldObj = oldRaw ? JSON.parse(oldRaw) : null; } catch(e){ oldObj = null; }

        if (newObj && oldObj) {
          // إذا النسخة الجديدة لا تحتوي على balance صريح (undefined أو null)
          // نحتفظ بالرصيد القديم
          if (typeof newObj.balance === 'undefined' || newObj.balance === null) {
            if (typeof oldObj.balance !== 'undefined' && oldObj.balance !== null) {
              newObj.balance = oldObj.balance;
            } else {
              // لا يوجد رصيد سابق، ضمن قيمة رقمية واضحة
              newObj.balance = Number(newObj.balance) || 0;
            }
            // إعادة تحويل النص ليُخزن بالقيمة المعدّلة
            value = JSON.stringify(newObj);
          }
        }
      }
    } catch(e){
      // لا نكسر السلوك الأصلي في حال حصول خطأ هنا
      console.warn('safe-localstorage guard error', e);
    }
    // استدعاء setItem الأصلي
    return _origSet(key, value);
  };
})();
  </script>
</body>
  </html>
