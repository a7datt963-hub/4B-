<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ÙˆÙ‚Ø¹ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ â€” Ù†Ø³Ø®Ø© Ù…ØµØ­Ø­Ø©</title>
  <style>
  /* (Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ù† CSS Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©) */
  * { margin:0; padding:0; box-sizing:border-box }
  html,body { height:100% }
  body { font-family:Arial,Helvetica,sans-serif; background:#000; color:#fff; overflow-x:hidden }

  /* Header */
  header { background:#111; padding:10px 20px; position:relative; text-align:center }
  header img { height:90px; width:auto; display:block; margin:0 auto }
  #ordersStatusBar { margin:8px auto 0; max-width:720px; padding:4px 8px; border-radius:6px; text-align:center; min-height:22px; display:none; overflow:hidden; white-space:normal; pointer-events:none }
  .status-line { color:#FFCB01; padding:2px 4px; margin:2px 0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; font-weight:700; border-bottom:1px solid rgba(255,203,1,0.06); line-height:1.1 }
  .status-line:last-child { border-bottom:none }
  .menu { position:absolute; right:20px; font-size:28px; cursor:pointer; color:#FFCB01; top:50%; transform:translateY(-50%) }
  #personalNumberDisplay { position:absolute; left:20px; top:50%; transform:translateY(-50%); color:#FFCB01; font-weight:bold; font-size:13px }
  #notifBell { position:absolute; right:68px; top:50%; transform:translateY(-50%); font-size:22px; cursor:pointer; color:#FFCB01 }
  #notifBell .badge { background:#ff3b30; color:#fff; border-radius:999px; padding:2px 6px; font-size:12px; margin-left:6px; vertical-align:middle }

  /* Notif panel */
  .notif-panel { position:fixed; top:70px; right:20px; width:360px; max-width:92%; background:#111; border:2px solid #FFCB01; border-radius:10px; padding:10px; z-index:1500; box-shadow:0 6px 30px rgba(0,0,0,0.6) }
  .notif-panel.hidden { display:none }
  .notif-empty { color:#aaa; padding:8px; text-align:center }

  /* Sidebar (Ù…Ø­Ø³Ù‘Ù†) */
  .sidebar {
    position:fixed;
    top:0;
    right:-100%;
    width:80%;
    max-width:300px;
    height:100%;
    background:transparent; /* Ø´ÙØ§Ù Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‡ÙŠØ¯Ø± */
    padding:20px;
    transition:0.28s;
    z-index:1000;
    overflow-y:auto;
    border-left:2px solid rgba(255,255,255,0.03);
  }
  .sidebar.active { right:0; background:rgba(17,17,17,0.98); }

  /* Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£ÙØ§ØªØ§Ø±) */
  .sidebar .avatar { width:48px; height:48px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:20px; color:#FFCB01; border:2px solid #FFCB01; }

  /* Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© - ØªØ¸Ù‡Ø± ÙƒÙ€ Ù†Øµ Ø£Ø¨ÙŠØ¶ ØªØ­ØªÙŠ */
  .sidebar a {
    display:block;              /* ÙŠØ®Ù„ÙŠÙ‡Ù… ØªØ­Øª Ø¨Ø¹Ø¶ */
    color:#fff !important;      /* Ù†Øµ Ø£Ø¨ÙŠØ¶ */
    text-decoration:none;       /* ÙŠØ´ÙŠÙ„ Ø§Ù„Ø®Ø· ØªØ­Øª Ø§Ù„Ù†Øµ */
    padding:10px 12px;          /* Ù…Ø³Ø§ÙØ© Ø¯Ø§Ø®Ù„ÙŠØ© */
    margin:6px 0;               /* ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
    font-size:16px;
    font-weight:700;
    text-align:right;           /* Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ† (Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©) */
    border-radius:6px;
    transition: color 0.15s, background 0.15s;
    background: transparent;    /* Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ© */
  }
  /* ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± - ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù„ÙˆÙ† ÙÙ‚Ø· */
  .sidebar a:hover {
    color:#FFCB01;
    background:rgba(255,203,1,0.04); /* Ø·ÙÙŠÙ Ù„Ù…Ø³Ø§Ø­Ø© ØªÙ…Ø±ÙŠØ± */
  }

  /* Ø±ÙˆØ§Ø¨Ø· Ø«Ø§Ù†ÙˆÙŠØ© Ø£Ùˆ Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
  .sidebar .small-btn {
    display:block;
    width:100%;
    text-align:center;
    background:transparent;
    color:#fff;
    border:2px solid rgba(255,255,255,0.05);
    padding:10px;
    border-radius:8px;
    margin-top:12px;
    cursor:pointer;
  }
  .sidebar .small-btn:hover { border-color:rgba(255,203,1,0.35); color:#FFCB01; }

  /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
  .container { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; padding:20px }
  .card { background:#111; border:2px solid #FFCB01; border-radius:12px; padding:20px; text-align:center; cursor:pointer; transition:.25s; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center }
  .card:hover { background:#FFCB01; color:#000 }
  .hidden { display:none }
  .form-box { background:#111; border:2px solid #FFCB01; border-radius:12px; padding:20px; margin:20px }
  select,input,button,textarea { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:none; font-size:16px; background:#222; color:#fff }
  .button-option { background:#222; color:#FFCB01; border:2px solid #FFCB01; margin:5px 0; padding:10px; border-radius:8px; cursor:pointer; width:100%; text-align:center; font-weight:bold }
  .button-option.selected { background:#FFCB01; color:#000 }
  button { background:#FFCB01; color:#000; font-weight:bold; cursor:pointer; border-radius:8px; padding:10px }
  .small-btn { display:inline-block; padding:8px 12px; border-radius:8px; background:#FFCB01; color:#000; cursor:pointer; margin-top:8px; text-align:center }
  .back-btn { display:block; margin:20px auto; background:#FFCB01; color:#000; padding:10px; border-radius:8px; text-align:center; font-weight:bold; cursor:pointer }
  .price-note { color:#FFCB01; font-weight:bold; margin:10px 0; font-size:14px; white-space:pre-line }
  .orders-list { padding:10px; margin:10px; background:#111; border-radius:10px; border:1px solid #333 }
  .order-item { padding:12px; border:2px solid #FFCB01; border-radius:8px; margin-bottom:10px; background:#111 }
  .login-page { max-width:600px; margin:18px auto; padding:16px }
  .muted-small { font-size:13px; color:#aaa; margin-top:6px }
  .upload-status { font-size:13px; color:#aaa; margin-top:6px }

  /* responsive tweaks */
  @media (min-width: 900px) {
    .sidebar { right:0; position:static; width:260px; max-width:none; background:transparent; border-left:none; padding:20px 10px 20px 20px; }
    .sidebar.active { right:0; background:transparent; }
    main { margin-right:260px; } /* space for sidebar on wide screens */
  }

  @media (max-width: 899px) {
    .menu { display:block }
    header img { height:72px }
  }
</style>
</head>
<body>
    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginPage" class="form-box hidden">
  <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <form id="loginForm">
    <input type="text" id="loginPersonal" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø´Ø®ØµÙŠ">
    <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button type="submit">Ø¯Ø®ÙˆÙ„</button>
  </form>
  <p class="muted-small">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" onclick="showRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a></p>
</div>

<!-- ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ -->
<div id="registerPage" class="form-box hidden">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <form id="registerForm">
    <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
    <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="text" id="regPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input type="text" id="regPersonal" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø´Ø®ØµÙŠ">
    <input type="password" id="regPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button type="submit">ØªØ³Ø¬ÙŠÙ„</button>

    <!-- âœ… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ù†Ø§ Ø£Ø³ÙÙ„ Ø§Ù„Ø²Ø± -->
    <p class="muted-small" style="margin-top:10px;">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù† ÙŠØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§ÙŠ ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.<br>
      ÙÙ‚Ø· Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø§ØµÙ„ÙŠØ© ÙÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ù…Ø´ÙƒÙ„Ø© Ù†Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ.
    </p>
  </form>

  <p class="muted-small">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" onclick="showLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
</div>

<header>
    <img src="https://i.postimg.cc/W1Ysr3QG/image.png" alt="Logo">
    <div id="personalNumberDisplay">Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ: <span id="personalNum">0000000</span></div>
    <div id="notifBell" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">ğŸ””<span id="notifBadge" class="badge hidden">0</span></div>
    <div class="menu" id="menuBtn">â˜°</div>
    <div id="ordersStatusBar" aria-live="polite" role="status" style="display:none"></div>
  </header>

  <!-- notif panel -->
  <div id="notifPanel" class="notif-panel hidden" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h4 style="color:#FFCB01;margin:0">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
      <div style="cursor:pointer;color:#FFCB01" id="notifCloseBtn">Ã—</div>
    </div>
    <div id="notifList"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <div class="small-btn" id="notifClearBtn">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</div>
      <div class="small-btn" id="notifGoOffersBtn">Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¹Ø±ÙˆØ¶</div>
    </div>
  </div>

  <!-- sidebar -->
  <div id="sidebar" class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="display:flex;gap:10px;align-items:center;cursor:pointer" id="sidebarProfileArea">
        <div class="avatar" id="sidebarAvatar">Ø£</div>
        <div>
          <div id="sidebarName" style="color:#FFCB01;font-weight:700">Ø¶ÙŠÙ</div>
          <div id="sidebarPersonal" style="color:#ccc;font-size:13px">--</div>
        </div>
      </div>
      <div style="cursor:pointer;color:#FFCB01" id="sidebarCloseBtn">Ã—</div>
    </div>

    <a href="#" id="linkHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="#" id="linkOrders">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
    <a href="#" id="linkContact">Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…</a>
    <a href="#" id="linkHelp">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø©</a>
    <a href="#" id="linkOffers">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§</a>
    <a href="#" id="linkJoinWhats">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ø¬ØªÙ…Ø¹ ÙˆØ§ØªØ³Ø§Ø¨</a>
    <hr style="border:none;height:1px;background:#222;margin:12px 0">
    <a href="#" id="linkGames">Ù‚Ø³Ù… Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</a>
    <a href="#" id="linkApps">Ù‚Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</a>
    <div style="margin-top:16px;">
      <div class="small-btn" id="btnCharge">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</div>
    </div>
  </div>

  <!-- pages -->
  <main id="mainContent">

    <!-- profile page -->
    <div id="profilePage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="profileName" readonly>
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="profileEmail" readonly>
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
        <input type="password" id="profilePassword" readonly>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="text" id="profilePhone" readonly>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button id="requestEditBtn">Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ</button>
          <button id="confirmSaveBtn" class="hidden">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
        <div class="back-btn" id="profileBackBtn">â¬… Ø±Ø¬ÙˆØ¹</div>
        <div id="profileMsg" class="muted-small"></div>
      </div>
    </div>

    <!-- home page -->
    <div id="homePage" class="hidden">
      <div class="container">
        <div class="card" id="cardGames">Ù‚Ø³Ù… Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="card" id="cardApps">Ù‚Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</div>
      </div>
    </div>

    <!-- help page -->
    <div id="helpPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø©</h3>
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø´Ø®ØµÙŠ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
        <input type="text" id="helpPersonalField" readonly>
        <label>-Ø§Ø®ØªØ± Ù…Ø´ÙƒÙ„ØªÙƒ-</label>
        <select id="helpIssueSelect">
          <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ø´ÙƒÙ„ØªÙ„Ùƒ --</option>
          <option value="Ù„Ø§ Ø§Ø³ØªØ·ÙŠØ¹ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ù„Ø§ Ø§Ø³ØªØ·Ø¹ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
          <option value="Ù‚Ù…Øª Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ„Ù… ÙŠÙØ±Ø§Ø¬Ø¹ Ø·Ù„Ø¨ÙŠ">Ù‚Ù…Øª Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ„Ù… ÙŠÙØ±Ø§Ø¬Ø¹ Ø·Ù„Ø¨ÙŠ</option>
          <option value="ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ÙŠ Ù„ÙƒÙ† Ù„Ù… ÙŠØµÙ„Ù†ÙŠ Ø´ÙŠØ¡">ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ÙŠ Ù„ÙƒÙ† Ù„Ù… ÙŠØµÙ„Ù†ÙŠ Ø´ÙŠØ¡</option>
          <option value="Ù„Ø§ Ø§Ø³ØªØ·ÙŠØ¹ Ø§Ø±Ø³Ø§Ù„ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©">Ù„Ø§ Ø§Ø³ØªØ·ÙŠØ¹ Ø§Ø±Ø³Ø§Ù„ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©</option>
        </select>
        <label>Ø§Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="file" id="helpFileUpload" accept="image/*">
        <div class="upload-status" id="helpUploadStatus"></div>
        <input type="text" id="helpFileLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" readonly>
        <label>ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
        <textarea id="helpDesc" rows="5" maxlength="100" placeholder="Ø§ÙƒØªØ¨ Ù…Ø´ÙƒÙ„ØªÙƒ ÙˆØ¶Ø¹ Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø·Ù„Ø¨ #***********"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="helpSubmitBtn">Ø¥Ø±Ø³Ø§Ù„</button>
          <div class="back-btn" id="helpBackBtn">â¬… Ø±Ø¬ÙˆØ¹</div>
        </div>
      </div>
    </div>

    <!-- games page -->
    <div id="gamesPage" class="hidden">
      <div class="form-box">
        <h3>Ø§Ø®ØªØ± Ù„Ø¹Ø¨ØªÙƒ</h3>
        <select id="gameSelect">
          <option value="">-- Ø§Ø®ØªØ± Ù„Ø¹Ø¨Ø© --</option>
          <option value="Ø£ÙƒÙˆØ§Ø¯ ÙØ±ÙŠ ÙØ§ÙŠØ±">Ø£ÙƒÙˆØ§Ø¯ ÙØ±ÙŠ ÙØ§ÙŠØ±</option>
          <option value="ÙØ±ÙŠ ÙØ§ÙŠØ± Ø§ÙŠØ¯ÙŠ">ÙØ±ÙŠ ÙØ§ÙŠØ± Ø§ÙŠØ¯ÙŠ</option>
          <option value="Ø¨Ø¨Ø¬ÙŠ Ø§ÙŠØ¯ÙŠ">Ø¨Ø¨Ø¬ÙŠ Ø§ÙŠØ¯ÙŠ</option>
          <option value="Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø¨Ø¬ÙŠ">Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø¨Ø¬ÙŠ</option>
          <option value="Ø¬ÙˆØ§ÙƒØ±">Ø¬ÙˆØ§ÙƒØ±</option>
        </select>
        <input type="text" id="personalField" readonly>
        <input type="text" id="idField" placeholder="Ø¶Ø¹ Ø§Ù„Ø§ÙŠØ¯ÙŠ" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainer"></div>
        <div id="priceDisplay"></div>
        <button id="submitForm" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
        <div class="price-note" id="paymentNote">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹</div>
        <div id="orderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtn" class="small-btn hidden">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
        <div class="back-btn" id="gamesBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- apps page -->
    <div id="appsPage" class="hidden">
      <div class="form-box">
        <h3>Ø§Ø®ØªØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
        <select id="appSelect">
          <option value="">-- Ø§Ø®ØªØ± ØªØ·Ø¨ÙŠÙ‚ --</option>
          <option value="ØªØ·Ø¨ÙŠÙ‚ 1">ØªØ·Ø¨ÙŠÙ‚ 1</option>
          <option value="ØªØ·Ø¨ÙŠÙ‚ 2">ØªØ·Ø¨ÙŠÙ‚ 2</option>
          <option value="ØªØ·Ø¨ÙŠÙ‚ 3">ØªØ·Ø¨ÙŠÙ‚ 3</option>
        </select>
        <input type="text" id="appPersonalField" readonly>
        <input type="text" id="appIdField" placeholder="Ø¶Ø¹ Ø§Ù„Ø§ÙŠØ¯ÙŠ" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainerApps"></div>
        <div id="priceDisplayApps"></div>
        <button id="appSubmitForm" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
        <div class="price-note" id="appPaymentNote">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©/Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹</div>
        <div id="appOrderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtnApp" class="small-btn hidden">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
        <div class="back-btn" id="appsBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- offers page -->
    <div id="offersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§</h3>
        <div id="offersList"></div>
        <div class="back-btn" id="offersBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- payment details page -->
    <div id="paymentDetailsPage" class="hidden">
      <div class="form-box">
        <div class="back-btn" id="pdBackBtn">â¬… Ø±Ø¬ÙˆØ¹</div>
        <h3 id="pdTitle" style="text-align:center;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h3>
        <div id="pdContent">
          <div id="pdTopInfo" style="text-align:center;margin-bottom:10px;color:#FFCB01;font-weight:bold;"></div>
          <select id="pdCashSelect">
            <option value="">-- Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ --</option>
            <option value="sham">Ø´Ø§Ù… ÙƒØ§Ø´</option>
            <option value="syrtel">Ø³ÙŠØ±ØªÙŠÙ„ ÙƒØ§Ø´</option>
            <option value="mtn">MTN ÙƒØ§Ø´</option>
            <option value="hawala">Ø­ÙˆØ§Ù„Ø© Ù…Ø§Ù„ÙŠØ©</option>
          </select>
          <div style="position:relative; margin-bottom:10px;">
            <input type="text" id="pdCopyField" readonly style="width:100%;padding-right:80px;">
            <button type="button" id="pdCopyBtn" style="position:absolute;left:0;top:0;height:100%;width:70px;cursor:pointer;">Ù†Ø³Ø®</button>
          </div>
          <div style="text-align:center;margin-bottom:10px;">
            <button type="button" id="pdToggleQrBtn">Ø§Ø¸Ù‡Ø±/Ø§Ø®ÙÙ QR</button>
          </div>
          <div id="qrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="qrImg" src="https://i.postimg.cc/vHYg2nK5/IMG.jpg" alt="QR Ø´Ø§Ù…" style="width:300px;height:auto;">
          </div>
          <div id="syrtelQrContainer" style="display:none;margin-top:10px;text-align:center;">
            <img id="syrtelQrImg" src="https://i.postimg.cc/tT6ScwYv/IMG.jpg" alt="QR Ø³ÙŠØ±ØªÙŠÙ„" style="width:300px;height:auto;">
          </div>

          <div id="shamFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>ØªØ­ÙˆÙŠÙ„ Ø´Ø§Ù… ÙƒØ§Ø´ Ø¥Ù„Ù‰:</strong>
              <div style="margin-top:6px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„Ù…Ø­ÙØ¸Ø©: <span id="shamAddressDisplay">e5eca798a4add8f1b86d389330131c82</span></div>
            </div>
          </div>

          <div id="syrtelFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>ØªØ­ÙˆÙŠÙ„ Ø³ÙŠØ±ØªÙŠÙ„ ÙƒØ§Ø´ Ø¥Ù„Ù‰:</strong>
              <div style="margin-top:6px;">Ø§Ù„Ø±Ù‚Ù…: <span id="syrtelAddressDisplay">72289118</span></div>
            </div>
          </div>

          <div id="hawalaFields" style="display:none;margin-top:10px;">
            <div style="padding:8px;border:1px solid #333;border-radius:8px;">
              <strong>Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ:</strong>
              <div style="margin-top:8px;">Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ø­Ù…Ø¯ Ø¹ØªÙˆÙ†</div>
              <div class="muted-small" style="margin-top:8px;color:#ccc;">
                Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØªÙ… Ø¹Ø¨Ø± Ù…ÙƒØ§ØªØ¨ Ø§Ù„ØµØ±Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø³ÙˆØ±ÙŠØ§ Ù…Ø«Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„ÙØ¤Ø§Ø¯ØŒ Ø¯ÙˆÙÙŠØ²ØŒ Ø§Ù„Ø®...
              </div>
            </div>
          </div>

          <input type="file" id="paymentFileUpload" accept="image/*">
          <div class="upload-status" id="paymentUploadStatus"></div>
          <input type="text" id="paymentFileLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§" readonly>
          <div id="pdPriceInfo" style="color:#0f0;font-weight:bold;margin-top:10px;text-align:center"></div>
          <div class="price-note" id="pdNote" style="white-space:pre-line">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</div>
          <button id="pdSubmitForm">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
      </div>
    </div>

    <!-- orders page -->
    <div id="ordersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <div id="ordersList" class="orders-list"></div>
        <div class="back-btn" id="ordersBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

    <!-- review page -->
    <div id="reviewPage" class="hidden">
      <div class="form-box" style="text-align:center;">
        <h3>ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ</h3>
        <p id="reviewMsg">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡</p>
        <div class="back-btn" id="reviewBackBtn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
    </div>

  </main>

<script>
/* ---------- Frontend logic (Ù…ØµØ­Ø­) ----------
   ØªÙˆØ§ØµÙ„ Ù…Ø¹ backend Ø¹Ø¨Ø± https://fourb-tawy.onrender.com
*/

const API_ROOT = 'https://fourb-tawy.onrender.com'; // Ø§Ø³ØªØ®Ø¯Ù…Øª Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø°ÙŠ Ø±Ø¨Ø·ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹

// ==== helpers
function $(id){ return document.getElementById(id); }
function show(id){ const el=$(id); if(el) el.classList.remove('hidden'); }
function hide(id){ const el=$(id); if(el) el.classList.add('hidden'); }
function hideAllPages(){
  ['homePage','gamesPage','appsPage','ordersPage','paymentDetailsPage','reviewPage','helpPage','profilePage','loginPage','offersPage'].forEach(id => { const e=$(id); if(e) e.classList.add('hidden'); });
}
// ======= Helper to safely add listeners and get elements =======
function onIf(id, ev, fn){ const el = $(id); if(el) el.addEventListener(ev, fn); }
function valOrEmpty(id){ const el = $(id); return el ? el.value : ''; }

let currentProfile = null;
let selectedGameOption = '';
let selectedAppOption = '';
let currentMap = null;
const priceMapFF={"100 Ø¬ÙˆØ§Ù‡Ø±":"12500 Ù„.Ø³","200 Ø¬ÙˆØ§Ù‡Ø±":"25000 Ù„.Ø³","300 Ø¬ÙˆØ§Ù‡Ø±":"60000 Ù„.Ø³","530 Ø¬ÙˆØ§Ù‡Ø±":"60000 Ù„.Ø³","1080 Ø¬ÙˆØ§Ù‡Ø±":"120000 Ù„.Ø³","2200 Ø¬ÙˆØ§Ù‡Ø±":"240000 Ù„.Ø³","Ø¹Ø¶ÙˆÙŠØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©":"30000 Ù„.Ø³","Ø¹Ø¶ÙˆÙŠØ© Ø´Ù‡Ø±ÙŠØ©":"140000 Ù„.Ø³"};
const priceMapPUBG={"60 Ø´Ø¯Ø©":"6000 Ù„.Ø³","325 Ø´Ø¯Ø©":"25000 Ù„.Ø³","660 Ø´Ø¯Ø©":"48000 Ù„.Ø³","1800 Ø´Ø¯Ø©":"120000 Ù„.Ø³","3850 Ø´Ø¯Ø©":"240000 Ù„.Ø³","8100 Ø´Ø¯Ø©":"480000 Ù„.Ø³"};
const priceMappubg1={"ÙƒÙˆØ¯ 60 Ø´Ø¯Ù‡":"12500 Ù„.Ø³"};
const priceMapApps = {"ØªØ·Ø¨ÙŠÙ‚ 1":"5000 Ù„.Ø³","ØªØ·Ø¨ÙŠÙ‚ 2":"10000 Ù„.Ø³","ØªØ·Ø¨ÙŠÙ‚ 3":"15000 Ù„.Ø³"};

// ===== Initialization (Ø¢Ù…Ù†)
document.addEventListener('DOMContentLoaded', ()=> {
  // menu open/close
  onIf('menuBtn','click', ()=> { const s=$('sidebar'); if(s) s.classList.toggle('active'); });
  onIf('sidebarCloseBtn','click', ()=> { const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('sidebarProfileArea','click', ()=> { openProfile(); const s=$('sidebar'); if(s) s.classList.remove('active'); });

  // sidebar links (Ø¢Ù…Ù†)
  onIf('linkHome','click', e=>{ e.preventDefault(); showHome(); const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('linkOrders','click', e=>{ e.preventDefault(); showOrders(); const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('linkContact','click', e=>{ e.preventDefault(); window.open('https://wa.me/79228576801','_blank'); const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('linkHelp','click', e=>{ e.preventDefault(); showHelp(); const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('linkOffers','click', e=>{ e.preventDefault(); showOffers(); const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('linkJoinWhats','click', e=>{ e.preventDefault(); window.open('https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J?mode=ems_copy_t','_blank'); });
  onIf('linkGames','click', e=>{ e.preventDefault(); showGames(); const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('linkApps','click', e=>{ e.preventDefault(); showApps(); const s=$('sidebar'); if(s) s.classList.remove('active'); });
  onIf('btnCharge','click', ()=>{ const s=$('sidebar'); if(s) s.classList.remove('active'); openChargePage(); });

  // notif
  onIf('notifBell','click', ()=> { const p=$('notifPanel'); if(p) p.classList.toggle('hidden'); loadNotifications(); });
  onIf('notifCloseBtn','click', ()=> { const p=$('notifPanel'); if(p) p.classList.add('hidden'); });
  onIf('notifClearBtn','click', () => { const nl=$('notifList'); const nb=$('notifBadge'); if(nl) nl.innerHTML=''; if(nb) nb.classList.add('hidden'); });

  // login toggles
  onIf('loginTogglePwd','click', function(){ const inp=$('loginPassword'); if(!inp) return; if(inp.type==='password'){ inp.type='text'; this.textContent='Ø§Ø®ÙÙ'; } else { inp.type='password'; this.textContent='Ø§Ø¸Ù‡Ø§Ø±'; }});
  onIf('doLoginBtn','click', doLogin);

  // profile
  onIf('requestEditBtn','click', requestProfileEdit);
  onIf('confirmSaveBtn','click', confirmProfileSave);
  onIf('profileBackBtn','click', showHome);

  // help
  onIf('helpBackBtn','click', showHome);
  onIf('helpSubmitBtn','click', submitHelp);
  onIf('helpFileUpload','change', async function(){ if(this.files && this.files[0]) await uploadFileToImgbb(this.files[0], 'helpFileLink','helpUploadStatus'); });

  // games/app selects
  onIf('gameSelect','change', function(){ buildGameOptions(this.value); });
  onIf('appSelect','change', function(){ buildAppOptions(this.value); });

  onIf('idField','input', updateSubmitButtonGames);
  onIf('appIdField','input', updateSubmitButtonApps);
  onIf('submitForm','click', ()=> showPaymentDetailsFromSubmit('gamesPage'));
  onIf('appSubmitForm','click', ()=> showPaymentDetailsFromSubmit('appsPage'));

  // payment details
  onIf('pdCashSelect','change', onPdCashChange);
  onIf('pdToggleQrBtn','click', toggleQr);
  onIf('pdCopyBtn','click', ()=>{ const val = valOrEmpty('pdCopyField'); if(val) navigator.clipboard?.writeText(val).then(()=>alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®')).catch(()=>prompt('Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹:',val)); else alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ù†Ø³Ø®'); });
  onIf('paymentFileUpload','change', async function(){ if(this.files && this.files[0]) await uploadFileToImgbb(this.files[0], 'paymentFileLink','paymentUploadStatus'); });
  onIf('pdSubmitForm','click', submitPaymentDetails);
  onIf('pdBackBtn','click', ()=> returnFromPaymentDetails());

  // orders/review/offers back
  onIf('ordersBackBtn','click', showHome);
  onIf('reviewBackBtn','click', showHome);
  onIf('offersBackBtn','click', showHome);

  // cards/buttons
  onIf('cardGames','click', showGames);
  onIf('cardApps','click', showApps);
  onIf('goOrdersBtn','click', showOrders);
  onIf('goOrdersBtnApp','click', showOrders);

  // load profile from localStorage if present
  const saved = localStorage.getItem('user_profile_v1');
  if(saved){
    try{ currentProfile = JSON.parse(saved); }catch(e){ currentProfile = null; }
  }
  if(!currentProfile){
    // create temporary personalNumber if none
    let pn = localStorage.getItem('personalNumber');
    if(!pn){ pn = String(Math.floor(1000000 + Math.random()*9000000)); localStorage.setItem('personalNumber', pn); }
    currentProfile = { personalNumber: pn, name:'Ø¶ÙŠÙ', email:'', phone:'', balance:0, canEdit:false };
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  }
  refreshUIFromProfile();
  showHome();

  // poll server for updates every 6s (Ø¢Ù…Ù†)
  setInterval(()=>{ try{ refreshNotificationsCount(); fetchOffers(); }catch(e){ console.error('poll error',e); } }, 6000);
  refreshNotificationsCount();
  fetchOffers();
});

// ---------- UI/page navigation ----------
function showHome(){ hideAllPages(); show('homePage'); window.scrollTo({top:0}); }
function showGames(){ hideAllPages(); show('gamesPage'); window.scrollTo({top:0}); }
function showApps(){ hideAllPages(); show('appsPage'); window.scrollTo({top:0}); }
function showHelp(){ hideAllPages(); show('helpPage'); window.scrollTo({top:0}); }
function openProfile(){ hideAllPages(); show('profilePage'); fillProfileFields(); }
function openChargePage(){ hideAllPages(); show('paymentDetailsPage'); const t=$('pdTitle'); if(t) t.textContent='Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯'; const info=$('pdTopInfo'); if(info) info.textContent='Ø§Ø·Ù„Ø¨ Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ø¨Ø± Ø±ÙØ¹ Ø§ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„'; }
function showOrders(){ hideAllPages(); show('ordersPage'); loadOrdersList(); }
function showOffers(){ hideAllPages(); show('offersPage'); fetchOffers(); }

// ---------- profile helpers ----------
function refreshUIFromProfile(){
  const pn = currentProfile && currentProfile.personalNumber ? currentProfile.personalNumber : '';
  const elPersonalNum = $('personalNum'); if(elPersonalNum) elPersonalNum.textContent = pn;
  const pf = $('personalField'); if(pf) pf.value = pn;
  const apf = $('appPersonalField'); if(apf) apf.value = pn;
  const hpf = $('helpPersonalField'); if(hpf) hpf.value = pn;
  const lpn = $('loginPersonalNumber'); if(lpn) lpn.value = pn;
  const sideName = $('sidebarName'); if(sideName) sideName.textContent = currentProfile.name || 'Ø¶ÙŠÙ';
  const sideAv = $('sidebarAvatar'); if(sideAv) sideAv.textContent = (currentProfile.name && currentProfile.name.trim().length>0) ? currentProfile.name.trim().charAt(0).toUpperCase() : 'Ø£';
  const sidePersonal = $('sidebarPersonal'); if(sidePersonal) sidePersonal.textContent = 'Ø±Ù‚Ù…: ' + pn;
}
function fillProfileFields(){
  const n = $('profileName'); if(n) n.value = currentProfile.name || '';
  const e = $('profileEmail'); if(e) e.value = currentProfile.email || '';
  const p = $('profilePassword'); if(p) p.value = currentProfile.password || '';
  const ph = $('profilePhone'); if(ph) ph.value = currentProfile.phone || '';
  applyProfileEditState();
}
function applyProfileEditState(){
  const canEdit = !!currentProfile.canEdit;
  ['profileName','profileEmail','profilePassword','profilePhone'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(canEdit){ el.removeAttribute('readonly'); } else { el.setAttribute('readonly','readonly'); }
  });
  const reqBtn = $('requestEditBtn'); const saveBtn = $('confirmSaveBtn'); const msg = $('profileMsg');
  if(canEdit){
    if(reqBtn) reqBtn.classList.add('hidden');
    if(saveBtn) saveBtn.classList.remove('hidden');
    if(msg) msg.textContent='ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¢Ù† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.';
  } else {
    if(reqBtn) reqBtn.classList.remove('hidden');
    if(saveBtn) saveBtn.classList.add('hidden');
    if(msg) msg.textContent='Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡.';
  }
}

// ---------- login/register ----------
async function doLogin(){
  const name = (valOrEmpty('loginName') || '').trim();
  const email = (valOrEmpty('loginEmail') || '').trim();
  const password = valOrEmpty('loginPassword') || '';
  const phone = (valOrEmpty('loginPhone') || '').trim();
  const personal = valOrEmpty('loginPersonalNumber') || (currentProfile && currentProfile.personalNumber) || localStorage.getItem('personalNumber') || '';
  const errEl = $('loginError');
  if(errEl){ errEl.style.display='none'; errEl.textContent=''; }
  if(!name){ if(errEl){ errEl.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'; errEl.style.display='block'; } else alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'); return; }
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ if(errEl){ errEl.textContent='ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; errEl.style.display='block'; } else alert('ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
  if(!password){ if(errEl){ errEl.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±'; errEl.style.display='block'; } else alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±'); return; }

  try{
    const resp = await fetch(`${API_ROOT}/api/register`, {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ name, email, password, phone, personalNumber: personal })
    });
    if(!resp.ok){ const text = await resp.text(); throw new Error('HTTP ' + resp.status + ' ' + text); }
    const data = await resp.json();
    if(data && data.ok){
      currentProfile = data.profile || { personalNumber: personal, name, email, phone };
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();
      showHome();
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } else {
      alert('ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + (data && data.error ? data.error : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }
  }catch(e){
    console.error('doLogin error', e);
    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„/ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (e.message||e));
  }
}

// request profile edit (sends message to admin bot)
async function requestProfileEdit(){
  const ok = confirm('Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');
  if(!ok) return;
  try{
    const resp = await fetch(`${API_ROOT}/api/profile/request-edit`, {
      method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if(data && data.ok){ alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„. Ø§Ù†ØªØ¸Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.'); const btn=$('requestEditBtn'); if(btn) { btn.textContent='ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨'; setTimeout(()=>{ if(btn) btn.textContent='Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ'; }, 10000); } } else { alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨'); }
  }catch(e){ console.error('requestProfileEdit', e); alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨'); }
}

function confirmProfileSave(){
  const name = (valOrEmpty('profileName') || '').trim();
  const email = (valOrEmpty('profileEmail') || '').trim();
  const password = valOrEmpty('profilePassword') || '';
  const phone = (valOrEmpty('profilePhone') || '').trim();
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ alert('Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
  currentProfile.name = name; currentProfile.email = email; currentProfile.password = password; currentProfile.phone = phone; currentProfile.canEdit = false;
  localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  // call server to persist (fire-and-forget, but safe)
  fetch(`${API_ROOT}/api/register`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ name, email, password, phone, personalNumber: currentProfile.personalNumber }) }).catch(e=>console.error('save profile server error', e));
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
  applyProfileEditState();
  refreshUIFromProfile();
}

// ---------- help submit ----------
async function submitHelp(){
  const issue = valOrEmpty('helpIssueSelect');
  const fileLink = valOrEmpty('helpFileLink');
  const desc = (valOrEmpty('helpDesc') || '').trim();
  const personal = currentProfile && currentProfile.personalNumber ? currentProfile.personalNumber : localStorage.getItem('personalNumber');
  if(!issue){ alert('Ø§Ø®ØªØ± Ù…Ø´ÙƒÙ„ØªÙƒ'); return; }
  try{
    const resp = await fetch(`${API_ROOT}/api/help`, {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal, issue, fileLink, desc, name: currentProfile.name, email: currentProfile.email, phone: currentProfile.phone })
    });
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if(data && data.ok){ alert('ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©'); // show success safely
      const success = $('helpSuccessPage'); if(success){ show('helpSuccessPage'); hide('helpPage'); } else { showHome(); }
    } else { alert('ÙØ´Ù„ Ø§Ù„Ø§Ø±Ø³Ø§Ù„'); }
  }catch(e){ console.error('submitHelp', e); alert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©'); }
}

// ---------- uploading to server (ÙŠÙØ¶Ù„) ----------
async function uploadFileToImgbb(file, targetInputId = 'paymentFileLink', statusElId='paymentUploadStatus'){
  if(!file) return;
  const statusEl = $(statusElId);
  if(statusEl) statusEl.textContent = 'Ø¬Ø§Ø±ÙŠØ© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹...';
  try{
    // Try server upload first (server should implement POST /api/upload => { ok:true, url })
    const fd = new FormData();
    fd.append('file', file);
    const resp = await fetch(`${API_ROOT}/api/upload`, { method:'POST', body: fd });
    if(resp.ok){
      const data = await resp.json().catch(()=>null);
      if(data && data.ok && data.url){
        const inp = $(targetInputId); if(inp) inp.value = data.url;
        if(statusEl) statusEl.textContent = 'ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­';
        alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
        return;
      }
    }
    // fallback: server didn't support upload endpoint or failed
    if(statusEl) statusEl.textContent = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„Ø®Ø§Ø¯Ù…';
    alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± Ø§Ù„Ø®Ø§Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯ IMGBB Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….');
  }catch(e){
    console.error('uploadFile error', e);
    if(statusEl) statusEl.textContent = 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹';
    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: ' + (e.message || e));
  }
}

// ---------- games/apps options ----------
function buildGameOptions(val){
  const container = $('optionsContainer');
  if(container) container.innerHTML='';
  selectedGameOption=''; const pd = $('priceDisplay'); if(pd) { pd.textContent=''; pd.style.color=''; }
  if(val==='ÙØ±ÙŠ ÙØ§ÙŠØ± Ø§ÙŠØ¯ÙŠ'){ currentMap = priceMapFF; }
  else if(val==='Ø¨Ø¨Ø¬ÙŠ Ø§ÙŠØ¯ÙŠ'){ currentMap = priceMapPUBG; }
  else if(val==='Ø¬ÙˆØ§ÙƒØ±'){ currentMap = priceMappubg1; }
  else currentMap = null;
  if(currentMap && container){
    Object.keys(currentMap).forEach(opt=>{
      const d = document.createElement('div'); d.className='button-option'; d.textContent = opt;
      d.addEventListener('click', ()=> {
        container.querySelectorAll('.button-option').forEach(x=>x.classList.remove('selected'));
        d.classList.add('selected');
        selectedGameOption = opt;
        if(pd){ pd.textContent = `Ø§Ù„Ø­Ø²Ù…Ø©: ${opt}\nØ§Ù„Ø³Ø¹Ø±: ${currentMap[opt]}`; pd.style.color='#0f0'; }
        updateSubmitButtonGames();
      });
      container.appendChild(d);
    });
  }
}

function buildAppOptions(val){
  const container = $('optionsContainerApps');
  if(container) container.innerHTML='';
  selectedAppOption=''; const pd = $('priceDisplayApps'); if(pd) { pd.textContent=''; pd.style.color=''; }
  if(priceMapApps[val] && container){
    const d = document.createElement('div'); d.className='button-option'; d.textContent = val;
    d.addEventListener('click', ()=> {
      container.querySelectorAll('.button-option').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      selectedAppOption = val;
      if(pd){ pd.textContent = `Ø§Ù„Ø³Ø¹Ø±: ${priceMapApps[val]}`; pd.style.color='#0f0'; }
      updateSubmitButtonApps();
    });
    container.appendChild(d);
  }
}

function updateSubmitButtonGames(){ const idf = valOrEmpty('idField') ? valOrEmpty('idField').trim() : ''; const btn = $('submitForm'); if(btn) btn.disabled = !(selectedGameOption && idf); }
function updateSubmitButtonApps(){ const idf = valOrEmpty('appIdField') ? valOrEmpty('appIdField').trim() : ''; const btn = $('appSubmitForm'); if(btn) btn.disabled = !(selectedAppOption && idf); }

// ---------- payment flow ----------
let previousBeforePayment = null;
function showPaymentDetailsFromSubmit(fromPage){
  previousBeforePayment = fromPage;
  hideAllPages(); show('paymentDetailsPage');
  const pdTop = $('pdTopInfo'); if(pdTop) pdTop.textContent = '';
  const pdPrice = $('pdPriceInfo'); if(pdPrice) pdPrice.textContent = '';
  const pdCash = $('pdCashSelect'); if(pdCash) pdCash.value = '';
  const pdCopy = $('pdCopyField'); if(pdCopy) pdCopy.value = '';
  const qr = $('qrContainer'); if(qr) qr.style.display='none';
  const sqqr = $('syrtelQrContainer'); if(sqqr) sqqr.style.display='none';
  const pLink = $('paymentFileLink'); if(pLink) pLink.value = '';
  const pu = $('paymentUploadStatus'); if(pu) pu.textContent = '';
  const pdNote = $('pdNote'); if(pdNote) pdNote.textContent = 'Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª';
  const sham = $('shamFields'); if(sham) sham.style.display='none';
  const syr = $('syrtelFields'); if(syr) syr.style.display='none';
  const haw = $('hawalaFields'); if(haw) haw.style.display='none';
}

function returnFromPaymentDetails(){ if(previousBeforePayment==='gamesPage') showGames(); else if(previousBeforePayment==='appsPage') showApps(); else showHome(); }

// pd cash change
function onPdCashChange(){
  const value = valOrEmpty('pdCashSelect');
  const pdNoteEl = $('pdNote');
  const sham = $('shamFields'), syr = $('syrtelFields'), haw = $('hawalaFields'), qr = $('qrContainer'), sqr = $('syrtelQrContainer'), copy = $('pdCopyField');
  if(value==='sham'){
    if(sham) sham.style.display='block'; if(syr) syr.style.display='none'; if(haw) haw.style.display='none';
    if(qr) qr.style.display='none'; if(sqr) sqr.style.display='none';
    if(copy) copy.value = 'e5eca798a4add8f1b86d389330131c82';
    if(pdNoteEl) pdNoteEl.textContent = `ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø´Ø§Ù… ÙƒØ§Ø´...`;
  } else if(value==='syrtel'){
    if(sham) sham.style.display='none'; if(syr) syr.style.display='block'; if(haw) haw.style.display='none';
    if(copy) copy.value = '72289118';
    if(pdNoteEl) pdNoteEl.textContent = `ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³ÙŠØ±ØªÙŠÙ„...`;
  } else if(value==='hawala'){
    if(sham) sham.style.display='none'; if(syr) syr.style.display='none'; if(haw) haw.style.display='block';
    if(copy) copy.value = '';
    if(pdNoteEl) pdNoteEl.textContent = `Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù„Ù‰: Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ø­Ù…Ø¯ Ø¹ØªÙˆÙ†`;
  } else {
    if(sham) sham.style.display='none'; if(syr) syr.style.display='none'; if(haw) haw.style.display='none';
    if(copy) copy.value = '';
    if(pdNoteEl) pdNoteEl.textContent = 'Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª';
  }
}

function toggleQr(){
  const m = valOrEmpty('pdCashSelect');
  if(m==='sham'){ const q=$('qrContainer'); if(q) q.style.display = q.style.display === 'none' ? 'block' : 'none'; }
  else if(m==='syrtel'){ const q=$('syrtelQrContainer'); if(q) q.style.display = q.style.display === 'none' ? 'block' : 'none'; }
  else alert('ØµÙˆØ±Ø© QR ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©');
}

// submit payment details -> creates order or charge
async function submitPaymentDetails(){
  const cashMethod = valOrEmpty('pdCashSelect');
  const fileLink = valOrEmpty('paymentFileLink');
  if(!cashMethod){ alert('Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'); return; }
  try{
    if(previousBeforePayment === 'gamesPage'){
      const personal = valOrEmpty('personalField') || (currentProfile && currentProfile.personalNumber);
      const game = valOrEmpty('gameSelect');
      const idField = valOrEmpty('idField');
      const price = valOrEmpty('priceDisplay') || '';
      if(!game || !idField || !selectedGameOption){ alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
      const body = { personal, phone: currentProfile.phone, type:'Ø´Ø­Ù† Ù„Ø¹Ø¨Ø©', item: `${game} - ${selectedGameOption}`, idField, fileLink, cashMethod };
      const r = await fetch(`${API_ROOT}/api/orders`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      if(data && data.ok){ hideAllPages(); show('reviewPage'); const rm=$('reviewMsg'); if(rm) rm.textContent='ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡'; localStorage.setItem('lastOrderId', data.order && data.order.id ? data.order.id : ''); } else alert('ÙØ´Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
    } else if(previousBeforePayment === 'appsPage'){
      const personal = valOrEmpty('appPersonalField') || (currentProfile && currentProfile.personalNumber);
      const app = valOrEmpty('appSelect');
      const idField = valOrEmpty('appIdField');
      if(!app || !idField || !selectedAppOption){ alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
      const body = { personal, phone: currentProfile.phone, type:'Ø´Ø±Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚', item: `${app} - ${selectedAppOption}`, idField, fileLink, cashMethod };
      const r = await fetch(`${API_ROOT}/api/orders`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      if(data && data.ok){ hideAllPages(); show('reviewPage'); const rm=$('reviewMsg'); if(rm) rm.textContent='ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'; } else alert('ÙØ´Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
    } else {
      // charge flow
      const personal = currentProfile.personalNumber;
      const amount = prompt('ÙƒÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø´Ø­Ù†Ù‡ØŸ (Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙÙ‚Ø·)');
      if(!amount || isNaN(Number(amount))){ alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
      const method = cashMethod || 'unknown';
      const r = await fetch(`${API_ROOT}/api/charge`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ personal, phone: currentProfile.phone, amount, method, fileLink }) });
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      if(data && data.ok){ alert('ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†. Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.'); hideAllPages(); showHome(); } else alert('ÙØ´Ù„ Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†');
    }
  }catch(e){
    console.error('submitPaymentDetails', e);
    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: ' + (e.message||e));
  }
}

// ---------- load orders / list ----------
async function loadOrdersList(){
  try{
    const personal = currentProfile && currentProfile.personalNumber ? currentProfile.personalNumber : '';
    const resp = await fetch(`${API_ROOT}/api/notifications/${personal}`);
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if(data && data.ok){
      const orders = data.orders || [];
      const charges = data.charges || [];
      const container = $('ordersList'); if(!container) return;
      container.innerHTML = '';
      if(orders.length===0 && charges.length===0){ container.innerHTML = '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>'; return; }
      orders.forEach(o=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${o.id}</strong> - ${o.type} - ${o.item || ''} <br> Ø§Ù„Ø§ÙŠØ¯ÙŠ: ${o.idField || ''} <br> Ø§Ù„Ù‡Ø§ØªÙ: ${o.phone || ''} <br> Ø§Ù„Ø­Ø§Ù„Ø©: <strong>${o.status}</strong> <br> Ø£Ù†Ø´Ø¦: ${new Date(o.createdAt).toLocaleString()}`;
        container.appendChild(d);
      });
      charges.forEach(c=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${c.id}</strong> - Ø´Ø­Ù† Ø±ØµÙŠØ¯ - Ø§Ù„Ù…Ø¨Ù„Øº: ${c.amount} <br> Ø§Ù„Ø­Ø§Ù„Ø©: <strong>${c.status}</strong> <br> Ø£Ù†Ø´Ø¦: ${new Date(c.createdAt).toLocaleString()}`;
        container.appendChild(d);
      });
    }
  }catch(e){ console.error('loadOrdersList', e); }
}

// ---------- notifications & offers ----------
async function refreshNotificationsCount(){
  try{
    const personal = currentProfile && currentProfile.personalNumber ? currentProfile.personalNumber : '';
    const resp = await fetch(`${API_ROOT}/api/notifications/${personal}`);
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if(data && data.ok){
      const offers = data.offers || [];
      const orders = data.orders || [];
      const charges = data.charges || [];
      const unreadCount = (Array.isArray(orders) ? orders.filter(o=>o.replied).length : 0) + (Array.isArray(charges) ? charges.filter(c=>c.replied).length : 0) + (offers.length>0 ? 1 : 0);
      const nb = $('notifBadge');
      if(unreadCount>0){ if(nb) { nb.classList.remove('hidden'); nb.textContent = String(unreadCount); } } else { if(nb) nb.classList.add('hidden'); }
    }
  }catch(e){ console.error('refreshNotificationsCount', e); }
}

async function loadNotifications(){
  try{
    const personal = currentProfile && currentProfile.personalNumber ? currentProfile.personalNumber : '';
    const resp = await fetch(`${API_ROOT}/api/notifications/${personal}`);
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if(data && data.ok){
      const offers = data.offers || [];
      const orders = data.orders || [];
      const charges = data.charges || [];
      const list = $('notifList'); if(!list) return;
      list.innerHTML = '';
      (orders.filter?orders.filter(o=>o.replied):[]).forEach(o=>{
        const el = document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid rgba(255,203,1,0.06)'; el.style.marginBottom='8px';
        el.innerHTML = `<div><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${o.id}</strong></div><div>${o.status}</div>`;
        list.appendChild(el);
      });
      (charges.filter?charges.filter(c=>c.replied):[]).forEach(c=>{
        const el = document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid rgba(255,203,1,0.06)'; el.style.marginBottom='8px';
        el.innerHTML = `<div><strong>Ø­Ø§Ù„Ø© Ø´Ø­Ù†Ø© #${c.id}</strong></div><div>${c.status}</div>`;
        list.appendChild(el);
      });
      offers.forEach(of=>{
        const el = document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid rgba(255,203,1,0.06)'; el.style.marginBottom='8px';
        el.innerHTML = `<div><strong>Ø¹Ø±Ø¶</strong></div><div>${of.text}</div><div style="margin-top:6px;"><button class="small-btn" onclick="ackOffer('${of.id}')">ØªØ­Ù‚Ù‚</button></div>`;
        list.appendChild(el);
      });
    }
  }catch(e){ console.error('loadNotifications', e); }
}

async function fetchOffers(){
  try{
    const personal = currentProfile && currentProfile.personalNumber ? currentProfile.personalNumber : localStorage.getItem('personalNumber') || '';
    const resp = await fetch(`${API_ROOT}/api/notifications/${personal}`);
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if(data && data.ok){
      const offers = data.offers || [];
      const container = $('offersList'); if(!container) return;
      container.innerHTML = '';
      offers.forEach(of=>{
        const el = document.createElement('div'); el.style.border='1px solid rgba(255,203,1,0.06)'; el.style.padding='8px'; el.style.marginBottom='8px';
        el.innerHTML = `<div>${of.text}</div><div style="margin-top:8px;"><button class="small-btn" onclick="ackOffer('${of.id}')">ØªØ­Ù‚Ù‚</button></div>`;
        container.appendChild(el);
      });
    }
  }catch(e){ console.error('fetchOffers', e); }
}

async function ackOffer(id){
  try{
    const resp = await fetch(`${API_ROOT}/api/offer/ack`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ personal: currentProfile.personalNumber, offerId: id }) });
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if(data && data.ok){ alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚'); fetchOffers(); refreshNotificationsCount(); } else alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚');
  }catch(e){ console.error('ackOffer', e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚'); }
}

// ---------- misc ----------
async function fetchDBDebug(){ try{ const d = await fetch(`${API_ROOT}/api/debug/db`).then(r=>r.json()); return d; }catch(e){ console.error(e); return null; } }

// === Forms: login/register (safe bindings) ===
onIf('loginForm','submit', async (e)=>{
  e.preventDefault();
  const personal = valOrEmpty('loginPersonal');
  const password = valOrEmpty('loginPassword');
  try{
    const res = await fetch(`${API_ROOT}/api/login`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ personalNumber: personal, password })
    });
    const data = await res.json().catch(()=>({ ok:false }));
    if(data.ok){
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
      localStorage.setItem("personalNumber", personal);
      const lp = $('loginPage'); if(lp) lp.classList.add('hidden');
    }else{
      alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âŒ");
    }
  }catch(e){ console.error('login form', e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
});

onIf('registerForm','submit', async (e)=>{
  e.preventDefault();
  const name = valOrEmpty('regName');
  const email = valOrEmpty('regEmail');
  const phone = valOrEmpty('regPhone');
  const personal = valOrEmpty('regPersonal');
  const password = valOrEmpty('regPassword');
  try{
    const res = await fetch(`${API_ROOT}/api/register`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ name,email,phone,personalNumber:personal,password })
    });
    const data = await res.json().catch(()=>({ ok:false }));
    if(data.ok){
      alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…");
      // switch to login
      const lp = $('loginPage'); const rp = $('registerPage'); if(lp) lp.classList.remove('hidden'); if(rp) rp.classList.add('hidden');
    }else{
      alert("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âŒ");
    }
  }catch(e){ console.error('register form', e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'); }
});
</script>
</body>
  </html>
